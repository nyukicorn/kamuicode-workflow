name: Create 360Â° Panorama 3JS Experience

on:
  workflow_dispatch:
    inputs:
      panorama_scene:
        description: 'ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³ã®èª¬æ˜ï¼ˆ360åº¦é¢¨æ™¯ï¼‰'
        required: true
        type: string
      music_style:
        description: 'éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¬æ˜'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for panorama experience
        id: create-branch
        run: |
          BRANCH_NAME="panorama/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="panorama-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      panorama-prompt: ${{ steps.planning.outputs.panorama-prompt }}
      music-prompt: ${{ steps.planning.outputs.music-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒ‘ãƒãƒ©ãƒ3JSè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ“‹ Panorama 3JS Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          PANORAMA_SCENE="${{ inputs.panorama_scene }}"
          MUSIC_STYLE="${{ inputs.music_style }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "Panorama scene: $PANORAMA_SCENE"
          echo "Music style: $MUSIC_STYLE"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯360åº¦ãƒ‘ãƒãƒ©ãƒ3JSä½“é¨“ã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‹ã‚‰æœ€é©ãªãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’ç”Ÿæˆã—ã€3JSç’°å¢ƒã«çµ±åˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º**:
          - ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³: $PANORAMA_SCENE
          - éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«: $MUSIC_STYLE

          **ã‚¿ã‚¹ã‚¯**:
          1. ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³ã‚’åˆ†æã—ã€360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          2. éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ†æã—ã€éŸ³æ¥½ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          3. 3JSç’°å¢ƒã§ã®çµ±åˆæ–¹é‡ã‚’å®šç¾©
          4. è¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/panorama-3js-plan.mdã€ã«ä¿å­˜
          5. ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/panorama-prompt.txtã€ã«ä¿å­˜
          6. éŸ³æ¥½ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜

          **ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - Imagen4 Ultraã«æœ€é©åŒ–ã•ã‚ŒãŸ360åº¦ãƒ‘ãƒãƒ©ãƒç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - ã€Œ360 degree panoramic view, equirectangular formatã€ã‚’å«ã‚€
          - å…¨æ–¹ä½ã®è¦–è¦šçš„è¦ç´ ã‚’æ˜ç¢ºã«æŒ‡å®š
          - é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°
          - 50-100èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•

          **éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - Google Lyriaã«æœ€é©åŒ–ã•ã‚ŒãŸéŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³ã¨ã®èª¿å’Œã‚’è€ƒæ…®
          - 30-40ç§’ç¨‹åº¦ã®æ¥½æ›²ã¨ã—ã¦é©åˆ‡
          - é›°å›²æ°—ã‚„æ„Ÿæƒ…è¡¨ç¾ã‚’æ˜ç¢ºã«æŒ‡å®š

          **3JSçµ±åˆæ–¹é‡**:
          - ãƒ‘ãƒãƒ©ãƒç”»åƒã®çƒé¢ãƒãƒƒãƒ”ãƒ³ã‚°æ–¹æ³•
          - éŸ³æ¥½ã®è‡ªå‹•å†ç”Ÿè¨­å®š
          - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒæ“ä½œï¼‰
          - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ

          **é‡è¦**: 
          1. å¿…ãšä»¥ä¸‹ã®6ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
             - $PLANNING_DIR/panorama-3js-plan.md
             - $PLANNING_DIR/panorama-prompt.txt
             - $PLANNING_DIR/panorama-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
             - $PLANNING_DIR/music-prompt.txt
             - $PLANNING_DIR/music-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
             - $PLANNING_DIR/3js-integration-strategy.md
          2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€mdãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨
          3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
          4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
          
          echo "ğŸš€ Starting Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # ãƒ‘ãƒãƒ©ãƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/panorama-prompt.txt" ]; then
            PANORAMA_PROMPT=$(cat "$PLANNING_DIR/panorama-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Panorama prompt generated"
            echo "Panorama prompt: $PANORAMA_PROMPT"
            echo "panorama-prompt=$PANORAMA_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Panorama prompt file not found"
            exit 1
          fi
          
          # éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
            MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Music prompt generated"
            echo "Music prompt: $MUSIC_PROMPT"
            echo "music-prompt=$MUSIC_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Music prompt file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add panorama 3JS planning: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  panorama-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      panorama-completed: ${{ steps.panorama.outputs.completed }}
      google-panorama-url: ${{ steps.panorama.outputs.google-panorama-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: 360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Imagen4 Ultra)
        id: panorama
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸŒ Panorama Generation Agent Execution (Imagen4 Ultra)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          PANORAMA_SCENE="${{ inputs.panorama_scene }}"
          PLANNED_PANORAMA_PROMPT="${{ needs.planning.outputs.panorama-prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PANORAMA_DIR="$FOLDER_NAME/panorama"
          
          echo "Panorama scene: $PANORAMA_SCENE"
          echo "Planned panorama prompt: $PLANNED_PANORAMA_PROMPT"
          echo "Target folder: $PANORAMA_DIR"
          
          # ãƒ‘ãƒãƒ©ãƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PANORAMA_DIR" ]; then
            mkdir -p "$PANORAMA_DIR"
            echo "ğŸ“ Created panorama folder: $PANORAMA_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          echo "Allowed tools: mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§Imagen4 Ultraã‚’ä½¿ç”¨ã—ã¦360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: $PANORAMA_SCENE
          **æœ€é©åŒ–ã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_PANORAMA_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. **æœ€é©åŒ–ã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ï¼ˆ$PLANNED_PANORAMA_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Imagen4 Ultraã§360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆ
          2. \`mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit\`ãƒ„ãƒ¼ãƒ«ã§ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result\`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-panorama-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$PANORAMA_DIR/generated-panorama.jpgã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - ãƒ‘ãƒãƒ©ãƒç”»åƒã¯å¿…ãšã€Œ$PANORAMA_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œgenerated-panorama.jpgã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-panorama-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
          
          **å‡¦ç†ã®æµã‚Œ**:
          1. ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆã—ã¦Google URLã‚’å–å¾—
          2. Google URLã‚’ã€Œ$FOLDER_NAME/google-panorama-url.txtã€ã«ä¿å­˜ï¼ˆ3JSçµ±åˆç”¨ï¼‰
          3. åŒã˜Google URLã‹ã‚‰ã€Œ$PANORAMA_DIR/generated-panorama.jpgã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿å­˜ç”¨ï¼‰"
          
          echo "ğŸš€ Starting Panorama Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒã®ç¢ºèª
          echo ""
          echo "ğŸŒ Checking generated panorama images..."
          if [ -d "$PANORAMA_DIR" ]; then
            IMAGE_COUNT=$(find "$PANORAMA_DIR" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | wc -l)
            echo "::notice::ğŸŒ Generated $IMAGE_COUNT panorama images"
            if [ "$IMAGE_COUNT" -gt 0 ]; then
              echo "Panorama image files:"
              FIRST_IMAGE=$(find "$PANORAMA_DIR" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | head -1)
              echo "First image: $FIRST_IMAGE"
              
              # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
              if [ -f "$FOLDER_NAME/google-panorama-url.txt" ]; then
                GOOGLE_URL=$(cat "$FOLDER_NAME/google-panorama-url.txt")
                echo "Google panorama URL: $GOOGLE_URL"
                echo "google-panorama-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ Google panorama URL not found in file"
                echo "google-panorama-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No panorama images were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Panorama directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push panorama images
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No panorama images to commit"
          else
            git commit -m "Add generated panorama images: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  music-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      music-completed: ${{ steps.music.outputs.completed }}
      google-music-url: ${{ steps.music.outputs.google-music-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Google Lyria)
        id: music
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Music Generation Agent Execution (Google Lyria)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_STYLE="${{ inputs.music_style }}"
          PLANNED_MUSIC_PROMPT="${{ needs.planning.outputs.music-prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          echo "Music style: $MUSIC_STYLE"
          echo "Planned music prompt: $PLANNED_MUSIC_PROMPT"
          echo "Target folder: $MUSIC_DIR"
          
          # éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$MUSIC_DIR" ]; then
            mkdir -p "$MUSIC_DIR"
            echo "ğŸ“ Created music folder: $MUSIC_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          echo "Allowed tools: mcp__t2m-google-lyria__lyria_submit,mcp__t2m-google-lyria__lyria_status,mcp__t2m-google-lyria__lyria_result,Bash"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§Google Lyriaã‚’ä½¿ç”¨ã—ã¦éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: $MUSIC_STYLE
          **æœ€é©åŒ–ã•ã‚ŒãŸéŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_MUSIC_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. **æœ€é©åŒ–ã•ã‚ŒãŸéŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ï¼ˆ$PLANNED_MUSIC_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Google Lyriaã§éŸ³æ¥½ç”Ÿæˆ
          2. \`mcp__t2m-google-lyria__lyria_submit\`ãƒ„ãƒ¼ãƒ«ã§éŸ³æ¥½ç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2m-google-lyria__lyria_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2m-google-lyria__lyria_result\`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-music-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$MUSIC_DIR/generated-music.wavã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - éŸ³æ¥½ã¯å¿…ãšã€Œ$MUSIC_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œgenerated-music.wavã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-music-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰éŸ³æ¥½ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
          
          **å‡¦ç†ã®æµã‚Œ**:
          1. éŸ³æ¥½ç”Ÿæˆã—ã¦Google URLã‚’å–å¾—
          2. Google URLã‚’ã€Œ$FOLDER_NAME/google-music-url.txtã€ã«ä¿å­˜ï¼ˆ3JSçµ±åˆç”¨ï¼‰
          3. åŒã˜Google URLã‹ã‚‰ã€Œ$MUSIC_DIR/generated-music.wavã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿å­˜ç”¨ï¼‰"
          
          echo "ğŸš€ Starting Music Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2m-google-lyria__lyria_submit,mcp__t2m-google-lyria__lyria_status,mcp__t2m-google-lyria__lyria_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ã®ç¢ºèª
          echo ""
          echo "ğŸµ Checking generated music..."
          if [ -d "$MUSIC_DIR" ]; then
            MUSIC_COUNT=$(find "$MUSIC_DIR" -name "*.wav" -o -name "*.mp3" -o -name "*.ogg" | wc -l)
            echo "::notice::ğŸµ Generated $MUSIC_COUNT music files"
            if [ "$MUSIC_COUNT" -gt 0 ]; then
              echo "Music files:"
              FIRST_MUSIC=$(find "$MUSIC_DIR" -name "*.wav" -o -name "*.mp3" -o -name "*.ogg" | head -1)
              echo "First music: $FIRST_MUSIC"
              
              # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
              if [ -f "$FOLDER_NAME/google-music-url.txt" ]; then
                GOOGLE_URL=$(cat "$FOLDER_NAME/google-music-url.txt")
                echo "Google music URL: $GOOGLE_URL"
                echo "google-music-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ Google music URL not found in file"
                echo "google-music-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No music files were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Music directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push music files
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No music files to commit"
          else
            git commit -m "Add generated music: ${{ inputs.music_style }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  threejs-integration:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, panorama-generation, music-generation]
    permissions:
      contents: write
    outputs:
      integration-completed: ${{ steps.integration.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: 3JSçµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: integration
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸŒ 3JS Integration Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PANORAMA_DIR="$FOLDER_NAME/panorama"
          MUSIC_DIR="$FOLDER_NAME/music"
          THREEJS_DIR="$FOLDER_NAME/3js-experience"
          GOOGLE_PANORAMA_URL="${{ needs.panorama-generation.outputs.google-panorama-url }}"
          GOOGLE_MUSIC_URL="${{ needs.music-generation.outputs.google-music-url }}"
          
          echo "3JS experience folder: $THREEJS_DIR"
          echo "Google panorama URL: $GOOGLE_PANORAMA_URL"
          echo "Google music URL: $GOOGLE_MUSIC_URL"
          
          # 3JSçµ±åˆãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$THREEJS_DIR" ]; then
            mkdir -p "$THREEJS_DIR"
            echo "ğŸ“ Created 3JS experience folder: $THREEJS_DIR"
          fi
          
          # å¿…è¦ãªã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ä½œæˆ
          mkdir -p "$THREEJS_DIR/assets"
          mkdir -p "$THREEJS_DIR/js"
          
          # ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆã®ç¢ºèª
          PANORAMA_FILE=""
          MUSIC_FILE=""
          
          if [ -d "$PANORAMA_DIR" ]; then
            PANORAMA_FILE=$(find "$PANORAMA_DIR" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | head -1)
            echo "Panorama file: $PANORAMA_FILE"
          fi
          
          if [ -d "$MUSIC_DIR" ]; then
            MUSIC_FILE=$(find "$MUSIC_DIR" -name "*.wav" -o -name "*.mp3" -o -name "*.ogg" | head -1)
            echo "Music file: $MUSIC_FILE"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’çµ±åˆã—ãŸ3JSä½“é¨“ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ**:
          - ãƒ‘ãƒãƒ©ãƒç”»åƒ: $PANORAMA_FILE
          - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: $MUSIC_FILE
          - Google ãƒ‘ãƒãƒ©ãƒURL: $GOOGLE_PANORAMA_URL
          - Google éŸ³æ¥½URL: $GOOGLE_MUSIC_URL

          **ä½œæˆã™ã‚‹3JSä½“é¨“ã®è¦ä»¶**:
          1. **index.html**: ãƒ¡ã‚¤ãƒ³ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«
          2. **assets/**: ãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’ã‚³ãƒ”ãƒ¼
          3. **js/**: Three.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒª
          4. **æ©Ÿèƒ½**: 360åº¦ãƒ‘ãƒãƒ©ãƒè¡¨ç¤ºã€éŸ³æ¥½å†ç”Ÿã€ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒæ“ä½œ

          **å®Ÿè¡Œæ‰‹é †**:
          1. ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ã€Œ$THREEJS_DIR/assets/panorama.jpgã€ã«ã‚³ãƒ”ãƒ¼
          2. ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ã‚’ã€Œ$THREEJS_DIR/assets/music.wavã€ã«ã‚³ãƒ”ãƒ¼
          3. Three.js CDNã‚’ä½¿ç”¨ã—ãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$THREEJS_DIR/index.htmlã€ã«ä½œæˆ
          4. ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’çƒé¢ã«ãƒãƒƒãƒ”ãƒ³ã‚°
          5. éŸ³æ¥½ã®è‡ªå‹•å†ç”Ÿè¨­å®š
          6. ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã§ã®è¦–ç‚¹æ“ä½œ
          7. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ
          8. ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¯¾å¿œ

          **HTMLæ§‹é€ ã®ä¾‹**:
          ```html
          <!DOCTYPE html>
          <html lang=\"ja\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>360Â° Panorama Experience</title>
              <style>
                  body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
                  #container { width: 100vw; height: 100vh; }
                  #info { position: absolute; top: 10px; left: 10px; color: white; z-index: 100; }
                  #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
                  button { padding: 10px 20px; margin: 0 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; cursor: pointer; }
                  button:hover { background: rgba(0,0,0,0.9); }
              </style>
          </head>
          <body>
              <div id=\"container\"></div>
              <div id=\"info\">
                  <h3>360Â° Panorama Experience</h3>
                  <p>ãƒã‚¦ã‚¹ã‚„ã‚¿ãƒƒãƒã§è¦–ç‚¹ã‚’å¤‰æ›´ã§ãã¾ã™</p>
              </div>
              <div id=\"controls\">
                  <button id=\"playPause\">éŸ³æ¥½ å†ç”Ÿ/åœæ­¢</button>
                  <button id=\"fullscreen\">ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³</button>
              </div>
              <audio id=\"backgroundMusic\" loop>
                  <source src=\"assets/music.wav\" type=\"audio/wav\">
              </audio>
              <script src=\"https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js\"></script>
              <script>
                  // Three.jsã®åˆæœŸåŒ–ã¨ãƒ‘ãƒãƒ©ãƒè¡¨ç¤ºã®ã‚³ãƒ¼ãƒ‰
              </script>
          </body>
          </html>
          ```

          **é‡è¦**:
          1. ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„
          2. Three.jsã®CDNã‚’ä½¿ç”¨ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
          3. ãƒ‘ãƒãƒ©ãƒç”»åƒã¯çƒé¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„
          4. éŸ³æ¥½ã¯è‡ªå‹•å†ç”Ÿã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä¸¡æ–¹ã«å¯¾å¿œã—ã¦ãã ã•ã„
          5. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã§ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã—ã¦ãã ã•ã„
          6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é©åˆ‡ã«å®Ÿè£…ã—ã¦ãã ã•ã„"
          
          echo "ğŸš€ Starting 3JS Integration Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # 3JSçµ±åˆçµæœã®ç¢ºèª
          echo ""
          echo "ğŸŒ Checking 3JS integration results..."
          
          if [ -f "$THREEJS_DIR/index.html" ]; then
            echo "::notice::âœ… 3JS experience HTML created"
            echo "HTML file size: $(stat -c%s "$THREEJS_DIR/index.html" 2>/dev/null || stat -f%z "$THREEJS_DIR/index.html" 2>/dev/null || echo "0") bytes"
          else
            echo "::error::âŒ 3JS experience HTML not found"
            exit 1
          fi
          
          if [ -d "$THREEJS_DIR/assets" ]; then
            ASSET_COUNT=$(find "$THREEJS_DIR/assets" -type f | wc -l)
            echo "::notice::ğŸ“ Assets folder contains $ASSET_COUNT files"
            if [ "$ASSET_COUNT" -gt 0 ]; then
              echo "Asset files:"
              find "$THREEJS_DIR/assets" -type f | head -5
            fi
          else
            echo "::warning::âš ï¸ Assets folder not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push 3JS experience
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No 3JS experience files to commit"
          else
            git commit -m "Add 3JS panorama experience: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, panorama-generation, music-generation, threejs-integration]
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ needs.setup-branch.outputs.branch-name }}"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æœ€çµ‚æˆæœç‰©ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          echo "=== Final Panorama 3JS Experience Summary ==="
          echo "Experience folder: $FOLDER_NAME"
          
          PANORAMA_COUNT=0
          MUSIC_COUNT=0
          THREEJS_READY=false
          
          if [ -d "$FOLDER_NAME" ]; then
            echo "âœ… Experience folder exists: $FOLDER_NAME"
            echo "Contents:"
            ls -la "$FOLDER_NAME"
            
            # ãƒ‘ãƒãƒ©ãƒç”»åƒã®ç¢ºèª
            if [ -d "$FOLDER_NAME/panorama" ]; then
              PANORAMA_COUNT=$(find "$FOLDER_NAME/panorama" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | wc -l)
              echo "âœ… Panorama directory exists with $PANORAMA_COUNT files"
            else
              echo "âŒ Panorama directory not found"
            fi
            
            # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/music" ]; then
              MUSIC_COUNT=$(find "$FOLDER_NAME/music" -name "*.wav" -o -name "*.mp3" -o -name "*.ogg" | wc -l)
              echo "âœ… Music directory exists with $MUSIC_COUNT files"
            else
              echo "âŒ Music directory not found"
            fi
            
            # 3JSä½“é¨“ã®ç¢ºèª
            if [ -f "$FOLDER_NAME/3js-experience/index.html" ]; then
              THREEJS_READY=true
              echo "âœ… 3JS experience ready"
            else
              echo "âŒ 3JS experience not found"
            fi
          else
            echo "âŒ Experience folder not found: $FOLDER_NAME"
          fi
          
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$FOLDER_NAME/" 2>/dev/null || true
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MESSAGE="Add new 360Â° Panorama 3JS Experience: ${{ inputs.panorama_scene }}
          
          ã‚·ãƒ¼ãƒ³: ${{ inputs.panorama_scene }}
          éŸ³æ¥½: ${{ inputs.music_style }}
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          
          ğŸ“Š Generation Summary:
          - ãƒ‘ãƒãƒ©ãƒç”»åƒ: $PANORAMA_COUNT files (Imagen4 Ultra)
          - éŸ³æ¥½: $MUSIC_COUNT files (Google Lyria)
          - 3JSä½“é¨“: $([ "$THREEJS_READY" = true ] && echo "Ready" || echo "Not Ready")
          
          ğŸŒ Generated with Claude Code SDK & kamuicode MCP
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin $BRANCH_NAME
          
          # GitHub Actions Summaryã«çµæœã‚’å‡ºåŠ›
          echo "# ğŸŒ 360Â° Panorama 3JS Experience å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ç”Ÿæˆæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³**: ${{ inputs.panorama_scene }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«**: ${{ inputs.music_style }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¥æ™‚**: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“Š ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ **ãƒ‘ãƒãƒ©ãƒç”»åƒ**: $PANORAMA_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Imagen4 Ultra)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸµ **éŸ³æ¥½**: $MUSIC_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Google Lyria)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ **3JSä½“é¨“**: $([ "$THREEJS_READY" = true ] && echo "å®Œæˆ" || echo "æœªå®Œæˆ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ã‚µãƒãƒªã«è¡¨ç¤º
          PANORAMA_FILE=$(find "$FOLDER_NAME/panorama" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | head -1)
          if [ -n "$PANORAMA_FILE" ] && [ -f "$PANORAMA_FILE" ]; then
            GITHUB_PANORAMA_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$PANORAMA_FILE"
            echo "## ğŸŒ ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒ" >> $GITHUB_STEP_SUMMARY
            echo "![Generated Panorama]($GITHUB_PANORAMA_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # 3JSä½“é¨“ã®æ¡ˆå†…
          if [ "$THREEJS_READY" = true ]; then
            GITHUB_EXPERIENCE_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$FOLDER_NAME/3js-experience/index.html"
            echo "## ğŸŒ 3JSä½“é¨“" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **ä½“é¨“ãƒ•ã‚¡ã‚¤ãƒ«**: \`$FOLDER_NAME/3js-experience/index.html\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ 3JSä½“é¨“ã¯ç›´æ¥é–‹ãã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ã„ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§3JSä½“é¨“ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. index.htmlã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã" >> $GITHUB_STEP_SUMMARY
          echo "3. 360åº¦ãƒ‘ãƒãƒ©ãƒä½“é¨“ã‚’æ¥½ã—ã‚€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸŒ Claude Code SDK & kamuicode MCPã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ360åº¦ãƒ‘ãƒãƒ©ãƒ3JSä½“é¨“ã§ã™ã€‚"
          PR_BODY="$PR_BODY"$'\n\n'"ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³: ${{ inputs.panorama_scene }}"
          PR_BODY="$PR_BODY"$'\n'"éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«: ${{ inputs.music_style }}"
          PR_BODY="$PR_BODY"$'\n\n'"ç”Ÿæˆãƒ•ãƒ­ãƒ¼:"
          PR_BODY="$PR_BODY"$'\n'"1. ğŸŒ Imagen4 Ultra ã§360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆ"
          PR_BODY="$PR_BODY"$'\n'"2. ğŸµ Google Lyria ã§éŸ³æ¥½ç”Ÿæˆ"
          PR_BODY="$PR_BODY"$'\n'"3. ğŸŒ Three.js ã§çµ±åˆä½“é¨“æ§‹ç¯‰"
          PR_BODY="$PR_BODY"$'\n\n'"æˆæœç‰©:"
          PR_BODY="$PR_BODY"$'\n'"- ãƒ‘ãƒãƒ©ãƒç”»åƒ: $PANORAMA_COUNT ãƒ•ã‚¡ã‚¤ãƒ«"
          PR_BODY="$PR_BODY"$'\n'"- éŸ³æ¥½: $MUSIC_COUNT ãƒ•ã‚¡ã‚¤ãƒ«"
          PR_BODY="$PR_BODY"$'\n'"- 3JSä½“é¨“: $([ "$THREEJS_READY" = true ] && echo "å®Œæˆ" || echo "æœªå®Œæˆ")"
          
          # ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ -n "$PANORAMA_FILE" ] && [ -f "$PANORAMA_FILE" ]; then
            GITHUB_PANORAMA_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$PANORAMA_FILE"
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸŒ ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒãƒ©ãƒç”»åƒ"
            PR_BODY="$PR_BODY"$'\n'"![Generated Panorama]($GITHUB_PANORAMA_URL)"
          fi
          
          # 3JSä½“é¨“ã®æ¡ˆå†…
          if [ "$THREEJS_READY" = true ]; then
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸŒ 3JSä½“é¨“ã®ä½¿ã„æ–¹"
            PR_BODY="$PR_BODY"$'\n'"1. \`$FOLDER_NAME/3js-experience/index.html\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
            PR_BODY="$PR_BODY"$'\n'"2. ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã"
            PR_BODY="$PR_BODY"$'\n'"3. ãƒã‚¦ã‚¹ã‚„ã‚¿ãƒƒãƒã§360åº¦ãƒ‘ãƒãƒ©ãƒã‚’æ¥½ã—ã‚€"
            PR_BODY="$PR_BODY"$'\n'"4. éŸ³æ¥½ã¨ä¸€ç·’ã«æ²¡å…¥ä½“é¨“"
          fi
          
          PR_BODY="$PR_BODY

          ---
          ğŸŒ Generated with [Claude Code SDK & kamuicode MCP](https://github.com/AI-Summoner/ai-summoner)"
          
          # PRä½œæˆ (GH_TOKENã‚’ä½¿ç”¨)
          gh pr create \
            --title "æ–°ã—ã„360Â° Panorama 3JS Experience: ${{ inputs.panorama_scene }}" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME