name: 'Video Prompt Adjustment'
description: 'Adjust video prompts based on generated images and strategic planning'
author: 'KamuiCode Workflow'

inputs:
  folder-name:
    description: 'The folder name containing generated images'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true
  video-prompt-1:
    description: 'Original video prompt for segment 1 from music analysis'
    required: true
  video-prompt-2:
    description: 'Original video prompt for segment 2 from music analysis'
    required: true
  video-prompt-3:
    description: 'Original video prompt for segment 3 from music analysis'
    required: true

outputs:
  adjustment-completed:
    description: 'Whether video prompt adjustment was completed successfully'
    value: ${{ steps.adjust.outputs.completed }}
  adjusted-video-prompt-1:
    description: 'Adjusted video prompt for segment 1'
    value: ${{ steps.adjust.outputs.video-prompt-1 }}
  adjusted-video-prompt-2:
    description: 'Adjusted video prompt for segment 2'
    value: ${{ steps.adjust.outputs.video-prompt-2 }}
  adjusted-video-prompt-3:
    description: 'Adjusted video prompt for segment 3'
    value: ${{ steps.adjust.outputs.video-prompt-3 }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: adjust
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¨ Video Prompt Adjustment Agent"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        FOLDER_NAME="${{ inputs.folder-name }}"
        ADJUSTMENT_DIR="$FOLDER_NAME/video-adjustments"
        
        # èª¿æ•´ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$ADJUSTMENT_DIR" ]; then
          mkdir -p "$ADJUSTMENT_DIR"
          echo "ðŸ“ Created adjustment folder: $ADJUSTMENT_DIR"
        fi
        
        # ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        ORIGINAL_VIDEO_PROMPT_1="${{ inputs.video-prompt-1 }}"
        ORIGINAL_VIDEO_PROMPT_2="${{ inputs.video-prompt-2 }}"
        ORIGINAL_VIDEO_PROMPT_3="${{ inputs.video-prompt-3 }}"
        
        echo "Original video prompt 1: $ORIGINAL_VIDEO_PROMPT_1"
        echo "Original video prompt 2: $ORIGINAL_VIDEO_PROMPT_2"
        echo "Original video prompt 3: $ORIGINAL_VIDEO_PROMPT_3"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="æˆ¦ç•¥çš„è¨ˆç”»ã¨ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’åˆ†æžã—ã€æ–¹å‘æ€§ã‚’ä¿ã¡ãªãŒã‚‰æœ€é©åŒ–ã•ã‚ŒãŸå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

        **é‡è¦**: æˆ¦ç•¥çš„è¨ˆç”»ã®æ–¹å‘æ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ã€å®Ÿéš›ã®ç”»åƒã«åˆã‚ã›ãŸèª¿æ•´ã‚’è¡Œã†ã“ã¨

        **ã‚¿ã‚¹ã‚¯**:
        1. æˆ¦ç•¥çš„è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€å…¨ä½“ã®æ–¹å‘æ€§ã¨å„å‹•ç”»ã®å½¹å‰²ã‚’ç†è§£
        2. ç”Ÿæˆç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§è¦–è¦šçš„ç‰¹å¾´ã‚’åˆ†æž
        3. æˆ¦ç•¥ã¨ç”»åƒã®ä¸¡æ–¹ã‚’è€ƒæ…®ã—ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸèª¿æ•´ã‚’å®Ÿæ–½
        4. å„å‹•ç”»ã®æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³/ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ/ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰ã‚’ç¶­æŒ

        **å‚ç…§ã™ã¹ãæˆ¦ç•¥æ–‡æ›¸**:
        - æˆ¦ç•¥çš„è¨ˆç”»: $FOLDER_NAME/planning/music-video-strategy.md
        - å‹•ç”»æˆ¦ç•¥: $FOLDER_NAME/planning/video-strategy.txt
        - éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $FOLDER_NAME/planning/music-prompt.md

        **ç”»åƒã®å ´æ‰€**:
        - ç”»åƒ1: $FOLDER_NAME/images/generated-image.png

        **ã‚ªãƒªã‚¸ãƒŠãƒ«å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
        - å‹•ç”»1: $ORIGINAL_VIDEO_PROMPT_1
        - å‹•ç”»2: $ORIGINAL_VIDEO_PROMPT_2
        - å‹•ç”»3: $ORIGINAL_VIDEO_PROMPT_3

        **å®Ÿè¡Œæ‰‹é †**:
        1. æˆ¦ç•¥çš„è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€å„å‹•ç”»ã®å½¹å‰²ã¨ç·¨é›†æˆ¦ç•¥ã‚’æŠŠæ¡
        2. ç”Ÿæˆç”»åƒã‚’Readãƒ„ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã¿ã€è¦–è¦šçš„ç‰¹å¾´ã‚’åˆ†æž
        3. æˆ¦ç•¥çš„å½¹å‰²ã‚’ç¶­æŒã—ãªãŒã‚‰ã€ç”»åƒã®å®Ÿéš›ã®å†…å®¹ã«åˆã‚ã›ã¦èª¿æ•´
        4. éŸ³æ¥½ã¨ã®çµ±åˆã‚’è€ƒæ…®ã—ãŸå‹•ãã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­è¨ˆ
        5. èª¿æ•´å¾Œã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜:
           - $ADJUSTMENT_DIR/adjusted-video-prompt-1.txt
           - $ADJUSTMENT_DIR/adjusted-video-prompt-2.txt
           - $ADJUSTMENT_DIR/adjusted-video-prompt-3.txt
        6. èª¿æ•´ç†ç”±ã¨æˆ¦ç•¥ã¨ã®æ•´åˆæ€§ã‚’$ADJUSTMENT_DIR/adjustment-report.mdã«ä¿å­˜

        **èª¿æ•´ã®åŽŸå‰‡**:
        - æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³50-60%ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ20-30%ã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³10-20%ï¼‰ã‚’ç¶­æŒ
        - ç”»åƒã®å®Ÿéš›ã®è¦ç´ ã‚’æ´»ã‹ã—ã¤ã¤ã€å…¨ä½“ã®çµ±ä¸€æ„Ÿã‚’ä¿æŒ
        - éŸ³æ¥½ã®ãƒ†ãƒ³ãƒã¨ãƒ“ãƒ¼ãƒˆã«åˆã‚ã›ãŸå‹•ãã®è¨­è¨ˆ
        - ç·¨é›†æ™‚ã®ä½¿ç”¨é »åº¦ã¨é…ç½®ã‚’è€ƒæ…®ã—ãŸæœ€é©åŒ–

        **æ³¨æ„**: ç¾åœ¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯1ã¤ã®ç”»åƒã®ã¿ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ç”»åƒã‚’ãƒ™ãƒ¼ã‚¹ã«3ã¤ã®ç•°ãªã‚‹å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚"
        
        echo "ðŸš€ Starting Video Prompt Adjustment Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write" \
          --max-turns 30 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # èª¿æ•´ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
        if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-1.txt" ]; then
          ADJUSTED_PROMPT_1=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-1.txt" | tr '\n' ' ')
          echo "::notice::âœ… Adjusted video prompt 1 generated"
          echo "Adjusted video prompt 1: $ADJUSTED_PROMPT_1"
          echo "video-prompt-1=$ADJUSTED_PROMPT_1" >> $GITHUB_OUTPUT
        else
          echo "::warning::âš ï¸ Using original prompt 1"
          echo "video-prompt-1=$ORIGINAL_VIDEO_PROMPT_1" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-2.txt" ]; then
          ADJUSTED_PROMPT_2=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-2.txt" | tr '\n' ' ')
          echo "::notice::âœ… Adjusted video prompt 2 generated"
          echo "Adjusted video prompt 2: $ADJUSTED_PROMPT_2"
          echo "video-prompt-2=$ADJUSTED_PROMPT_2" >> $GITHUB_OUTPUT
        else
          echo "::warning::âš ï¸ Using original prompt 2"
          echo "video-prompt-2=$ORIGINAL_VIDEO_PROMPT_2" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-3.txt" ]; then
          ADJUSTED_PROMPT_3=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-3.txt" | tr '\n' ' ')
          echo "::notice::âœ… Adjusted video prompt 3 generated"
          echo "Adjusted video prompt 3: $ADJUSTED_PROMPT_3"
          echo "video-prompt-3=$ADJUSTED_PROMPT_3" >> $GITHUB_OUTPUT
        else
          echo "::warning::âš ï¸ Using original prompt 3"
          echo "video-prompt-3=$ORIGINAL_VIDEO_PROMPT_3" >> $GITHUB_OUTPUT
        fi
        
        # èª¿æ•´ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
        if [ -f "$ADJUSTMENT_DIR/adjustment-report.md" ]; then
          echo "::notice::âœ… Adjustment report generated"
          echo "Adjustment report preview:"
          head -10 "$ADJUSTMENT_DIR/adjustment-report.md"
        else
          echo "::warning::âš ï¸ Adjustment report not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit and push adjustments
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No adjustments to commit"
        else
          git commit -m "Add video prompt adjustments based on generated images"
          git push origin ${{ inputs.branch-name }}
        fi