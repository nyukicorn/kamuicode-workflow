name: 'Image Upload'
description: 'Upload and process images from Issue attachments'
author: 'KamuiCode Workflow'

inputs:
  image-url:
    description: 'Issue attachment image URL'
    required: true
  output-folder:
    description: 'Output folder for processed image'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true

outputs:
  image-path:
    description: 'Path to the processed image file'
    value: ${{ steps.upload.outputs.image-path }}
  upload-completed:
    description: 'Whether image upload was completed successfully'
    value: ${{ steps.upload.outputs.completed }}
  image-format:
    description: 'Detected image format'
    value: ${{ steps.upload.outputs.format }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Upload and Process Image
      id: upload
      shell: bash
      run: |
        echo "::group::ðŸ–¼ï¸ Image Upload Processing"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        IMAGE_URL="${{ inputs.image-url }}"
        OUTPUT_FOLDER="${{ inputs.output-folder }}"
        
        echo "Image URL: $IMAGE_URL"
        echo "Output folder: $OUTPUT_FOLDER"
        
        # URLå½¢å¼ã®æ¤œè¨¼ï¼ˆGitHubæ·»ä»˜URLãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        if [[ ! "$IMAGE_URL" =~ ^https://github\.com/(user-attachments/assets/|.*\.(png|jpg|jpeg|webp)) ]]; then
          echo "::error::âŒ Invalid GitHub attachment URL format"
          echo "Expected: https://github.com/user-attachments/assets/... or https://github.com/.../image.(png|jpg|jpeg|webp)"
          exit 1
        fi
        
        # å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ
        mkdir -p "$OUTPUT_FOLDER"
        mkdir -p "$OUTPUT_FOLDER/images"
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
        TEMP_IMAGE="/tmp/temp_image_$(date +%s)"
        
        # ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        echo "ðŸ“¥ Downloading image from URL..."
        if ! curl -L -f -s -o "$TEMP_IMAGE" "$IMAGE_URL"; then
          echo "::error::âŒ Failed to download image from URL"
          exit 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
        FILE_SIZE=$(stat -f%z "$TEMP_IMAGE" 2>/dev/null || stat -c%s "$TEMP_IMAGE" 2>/dev/null)
        MAX_SIZE=$((10 * 1024 * 1024))  # 10MB
        
        if [ "$FILE_SIZE" -gt "$MAX_SIZE" ]; then
          echo "::error::âŒ Image file too large: ${FILE_SIZE} bytes (max: ${MAX_SIZE} bytes)"
          rm -f "$TEMP_IMAGE"
          exit 1
        fi
        
        echo "âœ… Downloaded image: ${FILE_SIZE} bytes"
        
        # ç”»åƒå½¢å¼ã®æ¤œè¨¼
        if command -v file >/dev/null 2>&1; then
          FILE_TYPE=$(file -b --mime-type "$TEMP_IMAGE")
          case "$FILE_TYPE" in
            image/png)
              IMAGE_FORMAT="png"
              EXTENSION="png"
              ;;
            image/jpeg)
              IMAGE_FORMAT="jpeg"
              EXTENSION="jpg"
              ;;
            image/webp)
              IMAGE_FORMAT="webp"
              EXTENSION="webp"
              ;;
            *)
              echo "::error::âŒ Unsupported image format: $FILE_TYPE"
              echo "Supported formats: PNG, JPEG, WebP"
              rm -f "$TEMP_IMAGE"
              exit 1
              ;;
          esac
        else
          # fileã‚³ãƒžãƒ³ãƒ‰ãŒãªã„å ´åˆã¯URLæ‹¡å¼µå­ã‹ã‚‰æŽ¨æ¸¬
          case "$IMAGE_URL" in
            *.png|*.PNG)
              IMAGE_FORMAT="png"
              EXTENSION="png"
              ;;
            *.jpg|*.jpeg|*.JPG|*.JPEG)
              IMAGE_FORMAT="jpeg"
              EXTENSION="jpg"
              ;;
            *.webp|*.WEBP)
              IMAGE_FORMAT="webp"
              EXTENSION="webp"
              ;;
            *)
              echo "::error::âŒ Cannot determine image format from URL"
              rm -f "$TEMP_IMAGE"
              exit 1
              ;;
          esac
        fi
        
        echo "âœ… Detected format: $IMAGE_FORMAT"
        
        # æœ€çµ‚çš„ãªç”»åƒãƒ‘ã‚¹ã‚’æ±ºå®š
        FINAL_IMAGE_PATH="$OUTPUT_FOLDER/images/uploaded-image.$EXTENSION"
        
        # ç”»åƒã‚’æœ€çµ‚ä½ç½®ã«ç§»å‹•
        mv "$TEMP_IMAGE" "$FINAL_IMAGE_PATH"
        
        echo "âœ… Image saved to: $FINAL_IMAGE_PATH"
        
        # ç”»åƒæƒ…å ±ã®è¡¨ç¤º
        if command -v identify >/dev/null 2>&1; then
          IMAGE_INFO=$(identify "$FINAL_IMAGE_PATH" 2>/dev/null || echo "Unknown dimensions")
          echo "ðŸ“Š Image info: $IMAGE_INFO"
        fi
        
        # Set outputs
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "image-path=$FINAL_IMAGE_PATH" >> $GITHUB_OUTPUT
        echo "format=$IMAGE_FORMAT" >> $GITHUB_OUTPUT
        
        echo "âœ… Image upload completed successfully"
        echo "::endgroup::"
    
    - name: Commit uploaded image
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.output-folder }}/images/
        if git diff --cached --quiet; then
          echo "No image files to commit"
        else
          git commit -m "Add uploaded image to ${{ inputs.output-folder }}"
          git push origin ${{ inputs.branch-name }}
        fi