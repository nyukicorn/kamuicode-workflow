name: 'Music Analysis & Prompt Optimization'
description: 'Analyze generated music and optimize image/video prompts based on musical characteristics'
author: 'KamuiCode Workflow'

inputs:
  music-concept:
    description: 'The music concept for context'
    required: true
  original-image-prompt:
    description: 'Original image prompt from planning'
    required: true
  original-video-prompt:
    description: 'Original video concept from planning'
    required: true
  music-url:
    description: 'Generated music file path'
    required: true
  folder-name:
    description: 'The folder name containing music files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  analysis-completed:
    description: 'Whether music analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  image-prompt-1:
    description: 'Optimized image prompt for segment 1'
    value: ${{ steps.analysis.outputs.image-prompt-1 }}
  image-prompt-2:
    description: 'Optimized image prompt for segment 2'
    value: ${{ steps.analysis.outputs.image-prompt-2 }}
  image-prompt-3:
    description: 'Optimized image prompt for segment 3'
    value: ${{ steps.analysis.outputs.image-prompt-3 }}
  video-prompt-1:
    description: 'Optimized video prompt for segment 1'
    value: ${{ steps.analysis.outputs.video-prompt-1 }}
  video-prompt-2:
    description: 'Optimized video prompt for segment 2'
    value: ${{ steps.analysis.outputs.video-prompt-2 }}
  video-prompt-3:
    description: 'Optimized video prompt for segment 3'
    value: ${{ steps.analysis.outputs.video-prompt-3 }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: éŸ³æ¥½åˆ†æžãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽµ Music Analysis & Prompt Optimization Agent"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        MUSIC_CONCEPT="${{ inputs.music-concept }}"
        ORIGINAL_IMAGE_PROMPT="${{ inputs.original-image-prompt }}"
        ORIGINAL_VIDEO_PROMPT="${{ inputs.original-video-prompt }}"
        MUSIC_URL="${{ inputs.music-url }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        MUSIC_DIR="$FOLDER_NAME/music"
        ANALYSIS_DIR="$FOLDER_NAME/analysis"
        
        echo "Music concept: $MUSIC_CONCEPT"
        echo "Original image prompt: $ORIGINAL_IMAGE_PROMPT"
        echo "Original video prompt: $ORIGINAL_VIDEO_PROMPT"
        echo "Music URL: $MUSIC_URL"
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # åˆ†æžãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "ðŸ“ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ ! -d "$MUSIC_DIR" ]; then
          echo "::error::âŒ Music directory not found: $MUSIC_DIR"
          exit 1
        fi
        
        GENERATED_MUSIC=$(find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
        if [ -z "$GENERATED_MUSIC" ]; then
          echo "::error::âŒ No generated music found"
          exit 1
        fi
        
        echo "Generated music file: $GENERATED_MUSIC"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="éŸ³æ¥½åˆ†æžå°‚é–€å®¶ã¨ã—ã¦ã€ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ã®ç‰¹å¾´ã‚’åˆ†æžã—ã€æ—¢å­˜ã®æˆ¦ç•¥è¨ˆç”»ã‚’ãƒ™ãƒ¼ã‚¹ã«éŸ³æ¥½ã«æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¾®èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

        **é‡è¦**: æˆ¦ç•¥ã‚’å†ç­–å®šã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®æˆ¦ç•¥è¨ˆç”»ã«éŸ³æ¥½ã®ç‰¹å¾´ã‚’åæ˜ ã—ãŸå¾®èª¿æ•´ã‚’å®Ÿæ–½

        **å‚ç…§ã™ã¹ãæˆ¦ç•¥è¨ˆç”»**: $FOLDER_NAME/planning/music-video-strategy.mdã€$FOLDER_NAME/planning/video-strategy.txt
        **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
        **ç”Ÿæˆæ¸ˆã¿éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«**: $GENERATED_MUSIC
        **å…ƒã®ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $ORIGINAL_IMAGE_PROMPT
        **å…ƒã®å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $ORIGINAL_VIDEO_PROMPT

        **ã‚¿ã‚¹ã‚¯**:
        1. æˆ¦ç•¥è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€æ—¢å­˜ã®ç·¨é›†æˆ¦ç•¥ã¨å‹•ç”»å½¹å‰²ã‚’ç†è§£
        2. ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æžã—ã¦éŸ³æ¥½çš„ç‰¹å¾´ã‚’æŠŠæ¡
        3. æ—¢å­˜æˆ¦ç•¥ã‚’ç¶­æŒã—ãªãŒã‚‰ã€éŸ³æ¥½ã®å®Ÿéš›ã®ç‰¹å¾´ã«åˆã‚ã›ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¾®èª¿æ•´
        4. å…ƒã®ç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éŸ³æ¥½ã®ç‰¹å¾´ã«åˆã‚ã›ã¦å¾®èª¿æ•´
        5. èª¿æ•´ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜

        **å¾®èª¿æ•´ã®åŽŸå‰‡**:
        - æˆ¦ç•¥è¨ˆç”»ã§å®šç¾©ã•ã‚ŒãŸå½¹å‰²åˆ†æ‹…ï¼ˆãƒ¡ã‚¤ãƒ³50-60%ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ20-30%ã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³10-20%ï¼‰ã‚’ç¶­æŒ
        - éŸ³æ¥½ã®å®Ÿéš›ã®ãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ¥½å™¨æ§‹æˆã‚’å…ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åæ˜ 
        - ç·¨é›†æˆ¦ç•¥ï¼ˆãƒ«ãƒ¼ãƒ—è€æ€§ã€é€Ÿåº¦å¯å¤‰ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¯¾å¿œï¼‰ã‚’ä¿æŒ

        **å®Ÿè¡Œæ‰‹é †**:
        1. æˆ¦ç•¥è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿
        2. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æžï¼ˆãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ§‹é€ ï¼‰
        3. å…ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«éŸ³æ¥½ã®ç‰¹å¾´ã‚’åŠ å‘³ã—ã¦å¾®èª¿æ•´
        4. ä»¥ä¸‹ã®æˆæžœç‰©ã‚’ä¿å­˜:

        **ä¿å­˜ã™ã¹ãæˆæžœç‰©**:
        - **éŸ³æ¥½åˆ†æžãƒ¬ãƒãƒ¼ãƒˆ**: ã€Œ$ANALYSIS_DIR/music-analysis.mdã€
          * éŸ³æ¥½ã®ç‰¹å¾´åˆ†æžçµæžœï¼ˆãƒ†ãƒ³ãƒã€æ¥½å™¨ã€é›°å›²æ°—ï¼‰
          * æ—¢å­˜æˆ¦ç•¥ã¨ã®æ•´åˆæ€§ç¢ºèª
          * å¾®èª¿æ•´ã®æ ¹æ‹ ã¨ç†ç”±
        - **èª¿æ•´æ¸ˆã¿ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: 
          * ã€Œ$ANALYSIS_DIR/image-prompt-1.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          * ã€Œ$ANALYSIS_DIR/image-prompt-2.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          * ã€Œ$ANALYSIS_DIR/image-prompt-3.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
        - **èª¿æ•´æ¸ˆã¿å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
          * ã€Œ$ANALYSIS_DIR/video-prompt-1.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          * ã€Œ$ANALYSIS_DIR/video-prompt-2.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          * ã€Œ$ANALYSIS_DIR/video-prompt-3.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
        - **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨**:
          * ã€Œ$ANALYSIS_DIR/image-prompt-1.mdã€ã€œã€Œ$ANALYSIS_DIR/image-prompt-3.mdã€
          * ã€Œ$ANALYSIS_DIR/video-prompt-1.mdã€ã€œã€Œ$ANALYSIS_DIR/video-prompt-3.mdã€

        **å¿…é ˆ**: æˆ¦ç•¥ã®å¤§å¹…å¤‰æ›´ã§ã¯ãªãã€éŸ³æ¥½ã«åˆã‚ã›ãŸç´°ã‹ãªèª¿æ•´ã®ã¿å®Ÿæ–½"
        
        echo "ðŸš€ Starting Music Analysis & Prompt Optimization Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit" \
          --max-turns 50 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # æœ€é©åŒ–çµæžœã®ç¢ºèª
        echo ""
        echo "ðŸŽµ Checking music analysis and optimized prompts..."
        
        # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
        SEGMENTS_COUNT=3
        echo "segments-count=$SEGMENTS_COUNT" >> $GITHUB_OUTPUT
        
        for i in $(seq 1 $SEGMENTS_COUNT); do
          if [ -f "$ANALYSIS_DIR/image-prompt-$i.txt" ]; then
            IMAGE_PROMPT=$(cat "$ANALYSIS_DIR/image-prompt-$i.txt" | tr '\n' ' ')
            echo "::notice::âœ… Image prompt $i generated"
            echo "Image prompt $i: $IMAGE_PROMPT"
            echo "image-prompt-$i=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Image prompt $i file not found"
            exit 1
          fi
        done
        
        # å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
        for i in $(seq 1 $SEGMENTS_COUNT); do
          if [ -f "$ANALYSIS_DIR/video-prompt-$i.txt" ]; then
            VIDEO_PROMPT=$(cat "$ANALYSIS_DIR/video-prompt-$i.txt" | tr '\n' ' ')
            echo "::notice::âœ… Video prompt $i generated"
            echo "Video prompt $i: $VIDEO_PROMPT"
            echo "video-prompt-$i=$VIDEO_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Video prompt $i file not found"
            exit 1
          fi
        done
        
        # éŸ³æ¥½åˆ†æžãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/music-analysis.md" ]; then
          echo "::notice::âœ… Music analysis report generated"
          echo "Music analysis preview:"
          head -10 "$ANALYSIS_DIR/music-analysis.md"
        else
          echo "::warning::âš ï¸ Music analysis report not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit analysis results
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis results to commit"
        else
          git commit -m "Add music analysis and optimized prompts: ${{ inputs.music-concept }}"
          git push origin ${{ inputs.branch-name }}
        fi