name: 'Web Player Generation & GitHub Pages Deploy'
description: 'Generate web player for music video and deploy to GitHub Pages'
author: 'KamuiCode Workflow'

inputs:
  folder-name:
    description: 'The folder name containing generated assets'
    required: true
  music-concept:
    description: 'The original music concept'
    required: true
  branch-name:
    description: 'The branch name for this generation'
    required: true
  execution-time:
    description: 'Total execution time of the workflow'
    required: false
    default: 'Unknown'
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  web-player-created:
    description: 'Whether web player was created successfully'
    value: ${{ steps.web-player.outputs.completed }}
  web-player-url:
    description: 'GitHub Pages URL for the web player'
    value: ${{ steps.web-player.outputs.web-url }}
  docs-deployed:
    description: 'Whether files were deployed to docs folder'
    value: ${{ steps.deploy.outputs.deployed }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: Automatic Web Player Generation
      id: web-player
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
        MUSIC_CONCEPT: ${{ inputs.music-concept }}
        FOLDER_NAME: ${{ inputs.folder-name }}
        BRANCH_NAME: ${{ inputs.branch-name }}
        EXECUTION_TIME: ${{ inputs.execution-time }}
      run: |
        echo "::group::ğŸŒ Automatic Web Player Generation"
        echo "Starting web player generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®šç¢ºèª
        echo "Music concept: $MUSIC_CONCEPT"
        echo "Folder name: $FOLDER_NAME"
        echo "Branch name: $BRANCH_NAME"
        echo "Execution time: $EXECUTION_TIME"
        
        # ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆã®ç¢ºèª
        echo "ğŸ“ Checking generated assets..."
        if [ -d "$FOLDER_NAME" ]; then
          echo "âœ… Source folder found: $FOLDER_NAME"
          
          # ã‚¢ã‚»ãƒƒãƒˆå­˜åœ¨ç¢ºèª
          FINAL_VIDEO=""
          MUSIC_FILE=""
          IMAGE_FILE=""
          
          if [ -f "$FOLDER_NAME/final/final-music-video.mp4" ]; then
            FINAL_VIDEO="$FOLDER_NAME/final/final-music-video.mp4"
            VIDEO_SIZE=$(ls -lah "$FINAL_VIDEO" | awk '{print $5}')
            echo "âœ… Found final video: $FINAL_VIDEO ($VIDEO_SIZE)"
          fi
          
          if [ -f "$FOLDER_NAME/music/generated-music.wav" ]; then
            MUSIC_FILE="$FOLDER_NAME/music/generated-music.wav"
            echo "âœ… Found music file: $MUSIC_FILE"
          fi
          
          if [ -f "$FOLDER_NAME/images/generated-image.png" ]; then
            IMAGE_FILE="$FOLDER_NAME/images/generated-image.png"
            echo "âœ… Found image file: $IMAGE_FILE"
          fi
          
        else
          echo "âŒ Source folder not found: $FOLDER_NAME"
          exit 1
        fi
        
        # Intent-to-Prompt: Web Playerè‡ªå‹•ç”Ÿæˆ
        SMART_PROMPT="éŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®Webãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
        
        **ç”Ÿæˆã—ãŸã‚¢ã‚»ãƒƒãƒˆæƒ…å ±**:
        - éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $MUSIC_CONCEPT
        - ãƒ•ã‚©ãƒ«ãƒ€å: $FOLDER_NAME
        - ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME
        - å®Ÿè¡Œæ™‚é–“: $EXECUTION_TIME
        - æœ€çµ‚å‹•ç”»: $FINAL_VIDEO
        - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: $MUSIC_FILE
        - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: $IMAGE_FILE
        
        **ã‚ãªãŸã®åˆ¤æ–­ã§è¡Œã£ã¦ãã ã•ã„**:
        1. ä¸Šè¨˜ã®ã‚¢ã‚»ãƒƒãƒˆæƒ…å ±ã‚’åŸºã«ã€ç¾ã—ã„Webãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        2. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã§ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
        3. ãƒ“ãƒ‡ã‚ªãƒ»éŸ³æ¥½ãƒ»ç”»åƒã®çµ±åˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½
        4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã¨è©³ç´°æƒ…å ±è¡¨ç¤º
        5. GitHub Pagesç”¨ã®æœ€é©åŒ–
        
        **ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜è¦ç´„ï¼ˆå¿…é ˆéµå®ˆï¼‰**:
        1. HTMLãƒ•ã‚¡ã‚¤ãƒ«: '$FOLDER_NAME/index.html' ã«ä¿å­˜
        2. docsãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼: 'docs/$FOLDER_NAME/' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        3. docs/index.html ã®æ›´æ–°: æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
        4. ä¿å­˜ç¢ºèª: å„ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å¾Œã« 'ls -la [filepath]' ã§ç¢ºèª
        
        **å‚è€ƒHTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ¨å¥¨ï¼‰**:
        åŸºæœ¬æ§‹é€ ã¨ã—ã¦ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¤ã¤ã€ã‚ˆã‚Šè‰¯ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã«æ”¹å–„:
        - ãƒ¢ãƒ€ãƒ³ãªCSSï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚·ãƒ£ãƒ‰ã‚¦ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        - ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        - éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        - ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
        - ç”Ÿæˆæƒ…å ±ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        
        **é‡è¦**:
        - ã‚ãªãŸã®å‰µé€ æ€§ã‚’æœ€å¤§é™æ´»ç”¨ã—ã¦ã€ç¾ã—ãæ©Ÿèƒ½çš„ãªWebãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
        - ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ç›¸å¯¾ãƒ‘ã‚¹ã§æ­£ç¢ºã«æŒ‡å®š
        - GitHub Pages ã§ã®ã‚¢ã‚¯ã‚»ã‚¹æ€§ã‚’æœ€å„ªå…ˆã«è¨­è¨ˆ"
        
        echo "ğŸš€ Starting Automatic Web Player Generation..."
        echo "ğŸ“ Prompt length: ${#SMART_PROMPT}"
        
        # Claude Code SDKå®Ÿè¡Œï¼ˆWebãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆå°‚ç”¨ï¼‰
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Bash" \
          --max-turns 30 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$SMART_PROMPT" 2>&1 | tee web-player-generation.log || {
            EXIT_CODE=$?
            echo "::error::âŒ Web player generation failed with exit code: $EXIT_CODE"
            echo "::group::Web Player Generation Error Details"
            tail -50 web-player-generation.log || echo "No execution log available"
            echo "::endgroup::"
            exit $EXIT_CODE
          }
        
        # çµæœç¢ºèª
        WEB_PLAYER_HTML="$FOLDER_NAME/index.html"
        DOCS_PLAYER_HTML="docs/$FOLDER_NAME/index.html"
        
        if [ -f "$WEB_PLAYER_HTML" ]; then
          echo "âœ… Web player created: $WEB_PLAYER_HTML"
          FILE_SIZE=$(ls -lah "$WEB_PLAYER_HTML" | awk '{print $5}')
          echo "File size: $FILE_SIZE"
          
          if [ -f "$DOCS_PLAYER_HTML" ]; then
            echo "âœ… Docs deployment ready: $DOCS_PLAYER_HTML"
            WEB_URL="https://$(echo $GITHUB_REPOSITORY | cut -d'/' -f1).github.io/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)/$FOLDER_NAME/"
            echo "ğŸŒ GitHub Pages URL: $WEB_URL"
            echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Docs deployment not completed"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ Web player generation failed"
          exit 1
        fi
        
        echo "::endgroup::"
    
    - name: Deploy to docs folder
      id: deploy
      shell: bash
      run: |
        echo "ğŸ“ Verifying docs deployment..."
        
        DOCS_FOLDER="docs/${{ inputs.folder-name }}"
        
        if [ -d "$DOCS_FOLDER" ]; then
          echo "âœ… Docs folder exists: $DOCS_FOLDER"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          FILE_COUNT=$(find "$DOCS_FOLDER" -type f | wc -l)
          echo "ğŸ“Š Files in docs folder: $FILE_COUNT"
          
          # ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          if [ -f "$DOCS_FOLDER/index.html" ]; then
            echo "âœ… index.html: OK"
          fi
          if [ -f "$DOCS_FOLDER/final/final-music-video.mp4" ]; then
            echo "âœ… final-music-video.mp4: OK"
          fi
          if [ -f "$DOCS_FOLDER/music/generated-music.wav" ]; then
            echo "âœ… generated-music.wav: OK"
          fi
          if [ -f "$DOCS_FOLDER/images/generated-image.png" ]; then
            echo "âœ… generated-image.png: OK"
          fi
          
          echo "deployed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Docs folder not found: $DOCS_FOLDER"
          echo "deployed=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Commit and push web player
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # docs ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿è¿½åŠ ï¼ˆThree.jsãƒãƒ¼ãƒ ã¨ã®ç«¶åˆå›é¿ï¼‰
        git add docs/
        
        if git diff --cached --quiet; then
          echo "No web player files to commit"
        else
          git commit -m "Add auto-generated web player: ${{ inputs.music-concept }}

ğŸŒ Auto-generated web interface:
- Responsive HTML video player
- Integrated music and image display
- Download links for all assets
- GitHub Pages deployment ready

ğŸ“Š Generation info:
- Folder: ${{ inputs.folder-name }}
- Branch: ${{ inputs.branch-name }}
- Execution time: ${{ inputs.execution-time }}

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
          
          git push origin main
        fi