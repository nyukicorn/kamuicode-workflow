name: 'Prompt Translation'
description: 'Translate Japanese prompts to English for image generation'
author: 'KamuiCode Workflow'

inputs:
  japanese-prompt:
    description: 'The Japanese prompt to translate'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  english-prompt:
    description: 'The translated English prompt'
    value: ${{ steps.translation.outputs.english-prompt }}
  translation-completed:
    description: 'Whether translation was completed successfully'
    value: ${{ steps.translation.outputs.completed }}

runs:
  using: 'composite'
  steps:
    - name: Translate Japanese to English
      id: translation
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŒ Japanese to English Translation"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        JAPANESE_PROMPT="${{ inputs.japanese-prompt }}"
        
        echo "Original Japanese prompt: $JAPANESE_PROMPT"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ä»¥ä¸‹ã®æ—¥æœ¬èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ­£ç¢ºãªè‹±èªžã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚

ç¿»è¨³å¯¾è±¡:
$JAPANESE_PROMPT

è¦ä»¶:
1. æ„å‘³ã‚’æ­£ç¢ºã«ä¿æŒã—ãŸè‹±èªžç¿»è¨³
2. ç”»åƒç”ŸæˆAIï¼ˆImagen4ï¼‰ã«é©ã—ãŸè‡ªç„¶ãªè‹±èªžè¡¨ç¾
3. æŠ€è¡“ç”¨èªžã¯é©åˆ‡ãªè‹±èªžç”¨èªžã«å¤‰æ›
4. 360åº¦ãƒ‘ãƒŽãƒ©ãƒžã€EquirectangularæŠ•å½±ãªã©ã®å°‚é–€ç”¨èªžã‚‚æ­£ç¢ºã«ç¿»è¨³

å‡ºåŠ›å½¢å¼:
ç¿»è¨³çµæžœã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜Žã‚„å‰ç½®ãã¯ä¸è¦ï¼‰ã€‚

æ³¨æ„:
- å…ƒã®æ„å‘³ã‚„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’ä¿æŒ
- ç”»åƒç”Ÿæˆã«æœ€é©åŒ–ã•ã‚ŒãŸè¡¨ç¾
- å†—é•·ãªèª¬æ˜Žã¯é¿ã‘ã¦ç°¡æ½”ã«"
        
        echo "ðŸš€ Starting Translation Agent..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # ç¿»è¨³çµæžœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        TEMP_FILE=$(mktemp)
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "none" \
          --max-turns 5 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" > "$TEMP_FILE" || {
            echo "::error::âŒ Translation failed"
            exit 1
          }
        
        # ç¿»è¨³çµæžœã‚’å–å¾—ï¼ˆæœ€å¾Œã®éžç©ºè¡Œï¼‰
        ENGLISH_PROMPT=$(grep -v '^$' "$TEMP_FILE" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
        
        if [ -z "$ENGLISH_PROMPT" ]; then
          echo "::error::âŒ No translation result found"
          exit 1
        fi
        
        echo ""
        echo "âœ… Translation completed!"
        echo "ðŸ“ Original: $JAPANESE_PROMPT"
        echo "ðŸŒ English: $ENGLISH_PROMPT"
        
        # GitHub Outputã«è¨­å®š
        echo "english-prompt=$ENGLISH_PROMPT" >> $GITHUB_OUTPUT
        echo "completed=true" >> $GITHUB_OUTPUT
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -f "$TEMP_FILE"
        
        echo "::endgroup::"