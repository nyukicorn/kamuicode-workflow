name: 'Prompt Translation'
description: 'Translate Japanese prompts to English for image generation'
author: 'KamuiCode Workflow'

inputs:
  japanese-prompt:
    description: 'The Japanese prompt to translate'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  english-prompt:
    description: 'The translated English prompt'
    value: ${{ steps.translation.outputs.english-prompt }}
  translation-completed:
    description: 'Whether translation was completed successfully'
    value: ${{ steps.translation.outputs.completed }}

runs:
  using: 'composite'
  steps:
    - name: Translate Japanese to English
      id: translation
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::🌐 Japanese to English Translation"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        JAPANESE_PROMPT="${{ inputs.japanese-prompt }}"
        
        echo "Original Japanese prompt: $JAPANESE_PROMPT"
        
        # プロンプトの構築
        PROMPT="以下の日本語プロンプトを正確な英語に翻訳してください。

翻訳対象:
$JAPANESE_PROMPT

要件:
1. 意味を正確に保持した英語翻訳
2. 画像生成AI（Imagen4）に適した自然な英語表現
3. 技術用語は適切な英語用語に変換
4. 360度パノラマ、Equirectangular投影などの専門用語も正確に翻訳

出力形式:
翻訳結果のみを出力してください（説明や前置きは不要）。

注意:
- 元の意味やニュアンスを保持
- 画像生成に最適化された表現
- 冗長な説明は避けて簡潔に"
        
        echo "🚀 Starting Translation Agent..."
        echo "📝 Prompt length: ${#PROMPT}"
        
        # 翻訳結果を一時ファイルに保存
        TEMP_FILE=$(mktemp)
        
        # Claude Code CLIの実行
        npx @anthropic-ai/claude-code \
          --allowedTools "none" \
          --max-turns 5 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" > "$TEMP_FILE" || {
            echo "::error::❌ Translation failed"
            exit 1
          }
        
        # 翻訳結果を取得（最後の非空行）
        ENGLISH_PROMPT=$(grep -v '^$' "$TEMP_FILE" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
        
        if [ -z "$ENGLISH_PROMPT" ]; then
          echo "::error::❌ No translation result found"
          exit 1
        fi
        
        echo ""
        echo "✅ Translation completed!"
        echo "📝 Original: $JAPANESE_PROMPT"
        echo "🌐 English: $ENGLISH_PROMPT"
        
        # GitHub Outputに設定
        echo "english-prompt=$ENGLISH_PROMPT" >> $GITHUB_OUTPUT
        echo "completed=true" >> $GITHUB_OUTPUT
        
        # 一時ファイルを削除
        rm -f "$TEMP_FILE"
        
        echo "::endgroup::"