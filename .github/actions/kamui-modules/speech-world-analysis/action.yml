name: 'Speech World Analysis'
description: 'Analyze speech/voice content to extract world characteristics for immersive experience'
author: 'KamuiCode Workflow'

inputs:
  # Èü≥Â£∞ÂÖ•Âäõ„Ç™„Éó„Ç∑„Éß„É≥ÔºàË§áÊï∞ÂΩ¢ÂºèÂØæÂøúÔºâ
  speech-prompt:
    description: 'Speech content description or transcript'
    required: false
  speech-url:
    description: 'URL to speech/audio file'
    required: false
  speech-file:
    description: 'Path to local speech/audio file'
    required: false
  speech-transcript:
    description: 'Text transcript of speech content'
    required: false
  
  # ÂÖ±ÈÄöË®≠ÂÆö
  folder-name:
    description: 'The folder name for storing analysis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true
  skip-commit:
    description: 'Skip commit and push step (for multimodal workflows)'
    required: false
    default: 'false'

outputs:
  # Èü≥Â£∞„ÉªË®ÄË™ûÁâπÊÄß
  atmosphere:
    description: 'Speech atmosphere (calm/energetic/dramatic/mysterious/etc.)'
    value: ${{ steps.analysis.outputs.atmosphere }}
  emotion:
    description: 'Primary emotion (happy/sad/excited/angry/neutral/etc.)'
    value: ${{ steps.analysis.outputs.emotion }}
  tone:
    description: 'Speech tone (formal/casual/intimate/authoritative/etc.)'
    value: ${{ steps.analysis.outputs.tone }}
  pace:
    description: 'Speech pace (slow/medium/fast/varied)'
    value: ${{ steps.analysis.outputs.pace }}
  energy:
    description: 'Energy level (1-10)'
    value: ${{ steps.analysis.outputs.energy }}
  
  # Ë®ÄË™û„ÉªÂÜÖÂÆπÁâπÊÄß
  language-style:
    description: 'Language style (poetic/technical/conversational/narrative/etc.)'
    value: ${{ steps.analysis.outputs.language-style }}
  content-type:
    description: 'Content type (story/explanation/dialogue/monologue/etc.)'
    value: ${{ steps.analysis.outputs.content-type }}
  formality:
    description: 'Formality level (1-10)'
    value: ${{ steps.analysis.outputs.formality }}
  
  # Á©∫Èñì„ÉªÊôÇÈñìÁâπÊÄß
  implied-space:
    description: 'Implied spatial setting (indoor/outdoor/intimate/vast/etc.)'
    value: ${{ steps.analysis.outputs.implied-space }}
  time-period:
    description: 'Implied time period (modern/historical/futuristic/timeless)'
    value: ${{ steps.analysis.outputs.time-period }}
  cultural-context:
    description: 'Cultural context (western/eastern/universal/specific/etc.)'
    value: ${{ steps.analysis.outputs.cultural-context }}
  
  # ÊäÄË°ì„ÉªÂìÅË≥™ÁâπÊÄß  
  audio-quality:
    description: 'Audio quality perception (studio/live/phone/outdoor/etc.)'
    value: ${{ steps.analysis.outputs.audio-quality }}
  speaker-count:
    description: 'Number of speakers (single/multiple/crowd/etc.)'
    value: ${{ steps.analysis.outputs.speaker-count }}
  background-environment:
    description: 'Background environment (silent/ambient/noisy/musical/etc.)'
    value: ${{ steps.analysis.outputs.background-environment }}
  
  # „É°„Çø„Éá„Éº„Çø
  analysis-completed:
    description: 'Whether analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  confidence:
    description: 'Analysis confidence score (0.0-1.0)'
    value: ${{ steps.analysis.outputs.confidence }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: Èü≥Â£∞‰∏ñÁïåË¶≥ÂàÜÊûê„Ç®„Éº„Ç∏„Çß„É≥„Éà
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::üé§ Speech World Analysis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # Ë®≠ÂÆö
        FOLDER_NAME="${{ inputs.folder-name }}"
        ANALYSIS_DIR="$FOLDER_NAME/world-analysis"
        
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # ÂàÜÊûê„Éï„Ç©„É´„ÉÄ„Çí‰∫ãÂâç„Å´‰ΩúÊàê
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "üìÅ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # ÂÖ•Âäõ„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç„Å®Êï¥ÁêÜ
        SPEECH_PROMPT="${{ inputs.speech-prompt }}"
        SPEECH_URL="${{ inputs.speech-url }}"
        SPEECH_FILE="${{ inputs.speech-file }}"
        SPEECH_TRANSCRIPT="${{ inputs.speech-transcript }}"
        
        echo "Input validation:"
        echo "- Speech prompt: ${SPEECH_PROMPT:+provided}"
        echo "- Speech URL: ${SPEECH_URL:+provided}"
        echo "- Speech file: ${SPEECH_FILE:+provided}"
        echo "- Speech transcript: ${SPEECH_TRANSCRIPT:+provided}"
        
        # ÂÖ•ÂäõÊ§úË®º
        INPUT_COUNT=0
        INPUT_TYPE=""
        
        if [ -n "$SPEECH_PROMPT" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          INPUT_TYPE="prompt"
          echo "‚úÖ Using speech prompt input"
        fi
        
        if [ -n "$SPEECH_URL" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          INPUT_TYPE="url"
          echo "‚úÖ Using speech URL input"
        fi
        
        if [ -n "$SPEECH_FILE" ] && [ -f "$SPEECH_FILE" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          INPUT_TYPE="file"
          echo "‚úÖ Using speech file input: $SPEECH_FILE"
        fi
        
        if [ -n "$SPEECH_TRANSCRIPT" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          INPUT_TYPE="transcript"
          echo "‚úÖ Using speech transcript input"
        fi
        
        if [ "$INPUT_COUNT" -eq 0 ]; then
          echo "::error::‚ùå No speech input provided"
          exit 1
        fi
        
        if [ "$INPUT_COUNT" -gt 1 ]; then
          echo "::warning::‚ö†Ô∏è Multiple speech inputs provided, using first available"
        fi
        
        # „Éó„É≠„É≥„Éó„Éà„ÅÆÊßãÁØâ
        PROMPT="„ÅÇ„Å™„Åü„ÅØÈü≥Â£∞„Éª„Çπ„Éî„Éº„ÉÅÂàÜÊûê„Åã„Çâ‰∏ñÁïåË¶≥ÁâπÊÄß„ÇíÊäΩÂá∫„Åô„ÇãÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ"
        
        if [ -n "$SPEECH_PROMPT" ]; then
          PROMPT="$PROMPT
        
        **Èü≥Â£∞„Ç≥„É≥„ÉÜ„É≥„ÉÑË™¨Êòé**:
        $SPEECH_PROMPT"
        elif [ -n "$SPEECH_TRANSCRIPT" ]; then
          PROMPT="$PROMPT
        
        **Èü≥Â£∞„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà**:
        $SPEECH_TRANSCRIPT"
        elif [ -n "$SPEECH_URL" ]; then
          PROMPT="$PROMPT
        
        **Èü≥Â£∞URL**: $SPEECH_URL
        (URL„Åã„ÇâÈü≥Â£∞ÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ)"
        elif [ -n "$SPEECH_FILE" ]; then
          PROMPT="$PROMPT
        
        **Èü≥Â£∞„Éï„Ç°„Ç§„É´**: $SPEECH_FILE
        („Éï„Ç°„Ç§„É´„Åã„ÇâÈü≥Â£∞ÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ)"
        fi
        
        PROMPT="$PROMPT
        
        **ÂàÜÊûê„Çø„Çπ„ÇØ**:
        Èü≥Â£∞„Éª„Çπ„Éî„Éº„ÉÅ„ÅÆÁâπÊÄß„ÇíÂ§öËßíÁöÑ„Å´ÂàÜÊûê„Åó„ÄÅ3D‰ΩìÈ®ì„ÇÑ‰∏ñÁïåË¶≥ÊßãÁØâ„Å´Ê¥ªÁî®„Åß„Åç„ÇãÁâπÊÄß„ÇíÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        **ÂàÜÊûêË¶ÅÁ¥†**:
        1. **Èü≥Â£∞„ÉªË®ÄË™ûÁâπÊÄß**:
           - atmosphere: Èü≥Â£∞„ÅÆÈõ∞Âõ≤Ê∞óÔºàcalm/energetic/dramatic/mysterious/intimate/etc.Ôºâ
           - emotion: ‰∏ªË¶ÅÊÑüÊÉÖÔºàhappy/sad/excited/angry/neutral/contemplative/etc.Ôºâ
           - tone: Ë©±„ÅóÊñπ„ÅÆ„Éà„Éº„É≥Ôºàformal/casual/intimate/authoritative/playful/etc.Ôºâ
           - pace: Ë©±„Åô„Éö„Éº„ÇπÔºàslow/medium/fast/variedÔºâ
           - energy: „Ç®„Éç„É´„ÇÆ„Éº„É¨„Éô„É´Ôºà1-10Ôºâ
        
        2. **Ë®ÄË™û„ÉªÂÜÖÂÆπÁâπÊÄß**:
           - language_style: Ë®ÄË™û„Çπ„Çø„Ç§„É´Ôºàpoetic/technical/conversational/narrative/etc.Ôºâ
           - content_type: ÂÜÖÂÆπ„Çø„Ç§„ÉóÔºàstory/explanation/dialogue/monologue/etc.Ôºâ
           - formality: „Éï„Ç©„Éº„Éû„É™„ÉÜ„Ç£„É¨„Éô„É´Ôºà1-10Ôºâ
        
        3. **Á©∫Èñì„ÉªÊôÇÈñìÁâπÊÄß**:
           - implied_space: ÊöóÁ§∫„Åï„Çå„ÇãÁ©∫ÈñìË®≠ÂÆöÔºàindoor/outdoor/intimate/vast/etc.Ôºâ
           - time_period: ÊöóÁ§∫„Åï„Çå„ÇãÊôÇ‰ª£Ôºàmodern/historical/futuristic/timelessÔºâ
           - cultural_context: ÊñáÂåñÁöÑÊñáËÑàÔºàwestern/eastern/universal/specific/etc.Ôºâ
        
        4. **ÊäÄË°ì„ÉªÂìÅË≥™ÁâπÊÄß**:
           - audio_quality: Èü≥Â£∞ÂìÅË≥™„ÅÆÁü•Ë¶öÔºàstudio/live/phone/outdoor/etc.Ôºâ
           - speaker_count: Ë©±ËÄÖÊï∞Ôºàsingle/multiple/crowd/etc.Ôºâ
           - background_environment: ËÉåÊôØÁí∞Â¢ÉÔºàsilent/ambient/noisy/musical/etc.Ôºâ
        
        **ÂøÖÈ†àÂá∫Âäõ„Éï„Ç°„Ç§„É´**:
        1. **$ANALYSIS_DIR/speech-analysis.json** - ÊßãÈÄ†Âåñ„Åï„Çå„ÅüÂàÜÊûêÁµêÊûú
        2. **$ANALYSIS_DIR/speech-analysis.md** - Ë©≥Á¥∞ÂàÜÊûê„É¨„Éù„Éº„Éà
        3. **$ANALYSIS_DIR/speech-summary.txt** - 1Ë°åË¶ÅÁ¥Ñ
        
        **JSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà**:
        \`\`\`json
        {
          \"atmosphere\": \"calm\",
          \"emotion\": \"contemplative\", 
          \"tone\": \"intimate\",
          \"pace\": \"slow\",
          \"energy\": 3,
          \"language_style\": \"conversational\",
          \"content_type\": \"monologue\",
          \"formality\": 4,
          \"implied_space\": \"indoor\",
          \"time_period\": \"modern\",
          \"cultural_context\": \"universal\",
          \"audio_quality\": \"studio\",
          \"speaker_count\": \"single\",
          \"background_environment\": \"silent\",
          \"confidence\": 0.85,
          \"input_type\": \"$INPUT_TYPE\",
          \"analysis_timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"
        }
        \`\`\`
        
        **ÈáçË¶Å„Å™Ê≥®ÊÑèÁÇπ**:
        1. ÂÖ®„Å¶„ÅÆÂÄ§„ÅØÊåáÂÆö„Åï„Çå„ÅüÈÅ∏ÊäûËÇ¢„Åæ„Åü„ÅØÊï∞ÂÄ§ÁØÑÂõ≤ÂÜÖ„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        2. Èü≥Â£∞„ÅÆÂæÆÁ¥∞„Å™„Éã„É•„Ç¢„É≥„Çπ„ÇÇÊçâ„Åà„Å¶ÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        3. 3D‰ΩìÈ®ì„ÇÑ‰∏ñÁïåË¶≥ÊßãÁØâ„Å∏„ÅÆÈÅ©Áî®ÂèØËÉΩÊÄß„ÇíËÄÉÊÖÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        4. „Éï„Ç°„Ç§„É´‰ΩúÊàêÂæå„ÄÅ„Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÁ¢∫Ë™ç„ÉªÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        
        echo "üöÄ Starting Speech World Analysis Agent Claude Code CLI..."
        echo "üìù Prompt length: ${#PROMPT}"
        
        # Claude Code CLI„ÅÆÂÆüË°å
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 15 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::‚ùå Claude Code CLI execution failed"
            exit 1
          }
        
        # ÁîüÊàê„Åï„Çå„ÅüÂàÜÊûêÁµêÊûú„ÅÆÁ¢∫Ë™ç„Å®Âá∫ÂäõË®≠ÂÆö
        echo ""
        echo "üìã Checking generated analysis files..."
        
        # JSONÂàÜÊûêÁµêÊûú„ÅÆÁ¢∫Ë™ç„Å®Âá∫ÂäõË®≠ÂÆö
        if [ -f "$ANALYSIS_DIR/speech-analysis.json" ]; then
          echo "::notice::‚úÖ Speech analysis JSON generated"
          
          # JSON„Åã„ÇâÂÄ§„ÇíÊäΩÂá∫„Åó„Å¶GitHub Output„Å´Ë®≠ÂÆö
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          EMOTION=$(grep -o '"emotion"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          TONE=$(grep -o '"tone"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          PACE=$(grep -o '"pace"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          ENERGY=$(grep -o '"energy"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/speech-analysis.json" | cut -d':' -f2 | tr -d ' ')
          LANGUAGE_STYLE=$(grep -o '"language_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          CONTENT_TYPE=$(grep -o '"content_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          FORMALITY=$(grep -o '"formality"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/speech-analysis.json" | cut -d':' -f2 | tr -d ' ')
          IMPLIED_SPACE=$(grep -o '"implied_space"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          TIME_PERIOD=$(grep -o '"time_period"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          CULTURAL_CONTEXT=$(grep -o '"cultural_context"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          AUDIO_QUALITY=$(grep -o '"audio_quality"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          SPEAKER_COUNT=$(grep -o '"speaker_count"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          BACKGROUND_ENV=$(grep -o '"background_environment"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/speech-analysis.json" | cut -d'"' -f4)
          CONFIDENCE=$(grep -o '"confidence"[[:space:]]*:[[:space:]]*[0-9.]*' "$ANALYSIS_DIR/speech-analysis.json" | cut -d':' -f2 | tr -d ' ')
          
          echo "Speech atmosphere: $ATMOSPHERE"
          echo "Primary emotion: $EMOTION"
          echo "Speech tone: $TONE"
          echo "Speech pace: $PACE"
          echo "Energy level: $ENERGY"
          echo "Language style: $LANGUAGE_STYLE"
          echo "Content type: $CONTENT_TYPE"
          echo "Formality: $FORMALITY"
          echo "Implied space: $IMPLIED_SPACE"
          echo "Time period: $TIME_PERIOD"
          echo "Cultural context: $CULTURAL_CONTEXT"
          echo "Audio quality: $AUDIO_QUALITY"
          echo "Speaker count: $SPEAKER_COUNT"
          echo "Background environment: $BACKGROUND_ENV"
          echo "Analysis confidence: $CONFIDENCE"
          
          # GitHub Output„Å´Ë®≠ÂÆö
          echo "atmosphere=${ATMOSPHERE:-calm}" >> $GITHUB_OUTPUT
          echo "emotion=${EMOTION:-neutral}" >> $GITHUB_OUTPUT
          echo "tone=${TONE:-conversational}" >> $GITHUB_OUTPUT
          echo "pace=${PACE:-medium}" >> $GITHUB_OUTPUT
          echo "energy=${ENERGY:-5}" >> $GITHUB_OUTPUT
          echo "language-style=${LANGUAGE_STYLE:-conversational}" >> $GITHUB_OUTPUT
          echo "content-type=${CONTENT_TYPE:-monologue}" >> $GITHUB_OUTPUT
          echo "formality=${FORMALITY:-5}" >> $GITHUB_OUTPUT
          echo "implied-space=${IMPLIED_SPACE:-indoor}" >> $GITHUB_OUTPUT
          echo "time-period=${TIME_PERIOD:-modern}" >> $GITHUB_OUTPUT
          echo "cultural-context=${CULTURAL_CONTEXT:-universal}" >> $GITHUB_OUTPUT
          echo "audio-quality=${AUDIO_QUALITY:-studio}" >> $GITHUB_OUTPUT
          echo "speaker-count=${SPEAKER_COUNT:-single}" >> $GITHUB_OUTPUT
          echo "background-environment=${BACKGROUND_ENV:-silent}" >> $GITHUB_OUTPUT
          echo "confidence=${CONFIDENCE:-0.8}" >> $GITHUB_OUTPUT
        else
          echo "::error::‚ùå Speech analysis JSON file not found"
          exit 1
        fi
        
        # ÂàÜÊûêÊñáÊõ∏„ÅÆÁ¢∫Ë™ç
        if [ -f "$ANALYSIS_DIR/speech-analysis.md" ]; then
          echo "::notice::‚úÖ Speech analysis document generated"
          echo "First 10 lines of analysis:"
          head -10 "$ANALYSIS_DIR/speech-analysis.md"
        else
          echo "::warning::‚ö†Ô∏è Speech analysis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push analysis
      if: ${{ inputs.skip-commit != 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          git commit -m "Add speech world analysis results"
          # Pull before push to handle concurrent commits
          for i in {1..3}; do
            git add . && git pull origin ${{ inputs.branch-name }} --rebase && git push origin ${{ inputs.branch-name }} && break
            echo "Push attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
        fi
    
    - name: Skip commit message
      if: ${{ inputs.skip-commit == 'true' }}
      shell: bash
      run: |
        echo "::notice::‚è≠Ô∏è Commit and push skipped for multimodal workflow"