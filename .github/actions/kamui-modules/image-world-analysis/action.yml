name: 'Image World Analysis'
description: 'Analyze images (prompts/URLs/files) to extract comprehensive world characteristics and visual properties'
author: 'KamuiCode Workflow'

inputs:
  image-prompt:
    description: 'The image prompt to analyze for world building'
    required: false
  image-url:
    description: 'URL of image to analyze for world characteristics'
    required: false
  image-file:
    description: 'Path to local image file for analysis'
    required: false
  folder-name:
    description: 'The folder name for storing analysis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  analysis-completed:
    description: 'Whether analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  scene-type:
    description: 'Analyzed scene type (static/dynamic/dramatic)'
    value: ${{ steps.analysis.outputs.scene-type }}
  atmosphere:
    description: 'Overall atmosphere (peaceful/energetic/mysterious/etc)'
    value: ${{ steps.analysis.outputs.atmosphere }}
  depth-mode:
    description: 'Recommended depth enhancement (normal/enhanced)'
    value: ${{ steps.analysis.outputs.depth-mode }}
  lighting-style:
    description: 'Lighting characteristics (soft/bright/dramatic/etc)'
    value: ${{ steps.analysis.outputs.lighting-style }}
  movement-energy:
    description: 'Movement energy level (1-10 scale)'
    value: ${{ steps.analysis.outputs.movement-energy }}
  color-temperature:
    description: 'Color temperature (warm/cool/neutral)'
    value: ${{ steps.analysis.outputs.color-temperature }}
  perspective-depth:
    description: 'Spatial depth perception (shallow/moderate/deep)'
    value: ${{ steps.analysis.outputs.perspective-depth }}
  visual-complexity:
    description: 'Visual complexity level (simple/moderate/complex)'
    value: ${{ steps.analysis.outputs.visual-complexity }}
  artistic-style:
    description: 'Artistic movement/style (realistic/impressionistic/abstract/etc)'
    value: ${{ steps.analysis.outputs.artistic-style }}
  cultural-context:
    description: 'Cultural/regional context (western/eastern/global/etc)'
    value: ${{ steps.analysis.outputs.cultural-context }}
  time-period:
    description: 'Implied time period (vintage/contemporary/futuristic)'
    value: ${{ steps.analysis.outputs.time-period }}
  image-quality:
    description: 'Image quality assessment (lo-fi/hi-fi/professional)'
    value: ${{ steps.analysis.outputs.image-quality }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ç”»åƒä¸–ç•Œè¦³åˆ†æžã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¨ Image World Analysis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®šã¨å…¥åŠ›å½¢å¼åˆ¤å®š
        IMAGE_PROMPT="${{ inputs.image-prompt }}"
        IMAGE_URL="${{ inputs.image-url }}"
        IMAGE_FILE="${{ inputs.image-file }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        ANALYSIS_DIR="$FOLDER_NAME/world-analysis"
        
        # å…¥åŠ›å½¢å¼ã®åˆ¤å®š
        INPUT_TYPE=""
        INPUT_SOURCE=""
        if [ -n "$IMAGE_PROMPT" ]; then
          INPUT_TYPE="prompt"
          INPUT_SOURCE="$IMAGE_PROMPT"
          echo "Input type: Text prompt"
          echo "Image prompt: $IMAGE_PROMPT"
        elif [ -n "$IMAGE_URL" ]; then
          INPUT_TYPE="url"
          INPUT_SOURCE="$IMAGE_URL"
          echo "Input type: Image URL"
          echo "Image URL: $IMAGE_URL"
        elif [ -n "$IMAGE_FILE" ]; then
          INPUT_TYPE="file"
          INPUT_SOURCE="$IMAGE_FILE"
          echo "Input type: Image file"
          echo "Image file: $IMAGE_FILE"
        else
          echo "::error::âŒ No input provided. Please specify image-prompt, image-url, or image-file"
          exit 1
        fi
        
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # åˆ†æžãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "ðŸ“ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯ç”»åƒã‹ã‚‰åŒ…æ‹¬çš„ãªä¸–ç•Œè¦³ç‰¹æ€§ã‚’æŠ½å‡ºã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚å…¥åŠ›å½¢å¼ã«å¿œã˜ã¦é©åˆ‡ã«åˆ†æžã—ã€æ±Žç”¨çš„ãªä¸–ç•Œè¦³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

        **å…¥åŠ›æƒ…å ±**:
        - **å…¥åŠ›å½¢å¼**: $INPUT_TYPE ($INPUT_TYPE = prompt/url/file)
        - **åˆ†æžå¯¾è±¡**: $INPUT_SOURCE

        **åŒ…æ‹¬çš„åˆ†æžã‚¿ã‚¹ã‚¯**:
        
        **åŸºæœ¬ä¸–ç•Œè¦³ç‰¹æ€§**:
        1. **ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—**: static/dynamic/dramatic ã®ã„ãšã‚Œã‹ã‚’åˆ¤å®š
        2. **é›°å›²æ°—**: peaceful/energetic/mysterious/dramatic/romantic/adventurousç­‰ã‚’ç‰¹å®š
        3. **æ·±åº¦ãƒ¢ãƒ¼ãƒ‰**: normal(æ¨™æº–)/enhanced(å¼·èª¿)ã®ã©ã¡ã‚‰ãŒé©åˆ‡ã‹ã‚’åˆ¤å®š
        4. **ç…§æ˜Žã‚¹ã‚¿ã‚¤ãƒ«**: soft/bright/dramatic/dim/warm/coolç­‰ã®ç‰¹æ€§
        5. **å‹•ãã‚¨ãƒãƒ«ã‚®ãƒ¼**: 1-10ã®ã‚¹ã‚±ãƒ¼ãƒ«ã§å‹•ãã®æ¿€ã—ã•ã‚’è©•ä¾¡
        6. **è‰²æ¸©åº¦**: warm(æš–è‰²ç³»)/cool(å¯’è‰²ç³»)/neutral(ä¸­æ€§)ã‚’åˆ¤å®š

        **æ–°è¦è¿½åŠ åˆ†æžè¦ç´ **:
        7. **ç©ºé–“ç‰¹æ€§**: 
           - perspective_depth: shallow/moderate/deep (å¥¥è¡Œãæ„Ÿ)
           - subject_distance: close/medium/distant (è¢«å†™ä½“ã¨ã®è·é›¢æ„Ÿ)
           - environmental_scale: intimate/spacious/vast (ç’°å¢ƒã‚¹ã‚±ãƒ¼ãƒ«)
        8. **å‹•çš„ç‰¹æ€§**:
           - implied_movement: still/gentle/active (æš—ç¤ºã•ã‚Œã‚‹å‹•ã)
           - visual_complexity: simple/moderate/complex (è¦–è¦šçš„è¤‡é›‘åº¦)
           - composition_balance: stable/dynamic/tension (æ§‹å›³ãƒãƒ©ãƒ³ã‚¹)
        9. **æ–‡åŒ–ç‰¹æ€§**:
           - artistic_style: realistic/impressionistic/abstract/surrealç­‰ (èŠ¸è¡“æ§˜å¼)
           - cultural_context: western/eastern/global/fusionç­‰ (æ–‡åŒ–çš„èƒŒæ™¯)
           - time_period: vintage/contemporary/futuristic (æ™‚ä»£æ€§)
        10. **æŠ€è¡“ç‰¹æ€§**:
            - image_quality: lo-fi/hi-fi/professional (ç”»è³ªè©•ä¾¡)
            - artistic_processing: natural/processed/heavily_modified (åŠ å·¥åº¦)

        **å…¥åŠ›å½¢å¼åˆ¥å‡¦ç†**:
        - **prompt**: ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‹ã‚‰ä¸–ç•Œè¦³ã‚’æŽ¨è«–
        - **url**: æŒ‡å®šURLã®ç”»åƒã‚’å–å¾—ãƒ»åˆ†æžï¼ˆå¯èƒ½ãªå ´åˆï¼‰
        - **file**: æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ç”»åƒã‚’åˆ†æžï¼ˆå¯èƒ½ãªå ´åˆï¼‰

        **ã‚¨ãƒ©ãƒ¼è€æ€§**: åˆ†æžå›°é›£ãªè¦ç´ ã¯\"moderate\"ã‚„\"unknown\"ç­‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        
        **å¿…é ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**:
        1. **$ANALYSIS_DIR/image-analysis.json** - æ©Ÿæ¢°å‡¦ç†ç”¨ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
        2. **$ANALYSIS_DIR/image-analysis.md** - äººé–“ç¢ºèªç”¨ã®è©³ç´°åˆ†æžçµæžœ
        3. **$ANALYSIS_DIR/recommendations.txt** - è¨­å®šæŽ¨å¥¨å€¤ï¼ˆ1è¡Œå½¢å¼ï¼‰

        **JSONãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¾‹**:
        \`\`\`json
        {
          \"scene_type\": \"dynamic\",
          \"atmosphere\": \"peaceful\",
          \"depth_mode\": \"enhanced\",
          \"lighting_style\": \"soft\",
          \"movement_energy\": 3,
          \"color_temperature\": \"warm\",
          \"perspective_depth\": \"moderate\",
          \"subject_distance\": \"medium\",
          \"environmental_scale\": \"spacious\",
          \"implied_movement\": \"gentle\",
          \"visual_complexity\": \"moderate\",
          \"composition_balance\": \"stable\",
          \"artistic_style\": \"realistic\",
          \"cultural_context\": \"western\",
          \"time_period\": \"contemporary\",
          \"image_quality\": \"hi-fi\",
          \"artistic_processing\": \"natural\",
          \"confidence\": 0.85,
          \"input_type\": \"$INPUT_TYPE\"
        }
        \`\`\`

        **é‡è¦ãªæ³¨æ„ç‚¹**:
        1. å¿…ãš3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã™ã¹ã¦ã‚’ä½œæˆã—ã¦ãã ã•ã„
        2. JSONå½¢å¼ã¯åŽ³å¯†ã«å¾“ã£ã¦ãã ã•ã„ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨ï¼‰
        3. åˆ†æžç†ç”±ã‚’æ˜Žç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„
        4. 360åº¦ãƒ‘ãƒŽãƒ©ãƒžãƒ»ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ä½“é¨“ã«æœ€é©åŒ–ã—ãŸæŽ¨å¥¨ã‚’è¡Œã£ã¦ãã ã•ã„
        5. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
        
        echo "ðŸš€ Starting Image World Analysis Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 15 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸåˆ†æžçµæžœã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated analysis files..."
        
        # JSONåˆ†æžçµæžœã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
        if [ -f "$ANALYSIS_DIR/image-analysis.json" ]; then
          echo "::notice::âœ… Image analysis JSON generated"
          
          # jqãŒãªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µã§JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          SCENE_TYPE=$(grep -o '"scene_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          DEPTH_MODE=$(grep -o '"depth_mode"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          LIGHTING_STYLE=$(grep -o '"lighting_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          MOVEMENT_ENERGY=$(grep -o '"movement_energy"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/image-analysis.json" | cut -d':' -f2 | tr -d ' ')
          COLOR_TEMPERATURE=$(grep -o '"color_temperature"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          
          # æ–°è¦è¿½åŠ è¦ç´ ã®æŠ½å‡º
          PERSPECTIVE_DEPTH=$(grep -o '"perspective_depth"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          VISUAL_COMPLEXITY=$(grep -o '"visual_complexity"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          ARTISTIC_STYLE=$(grep -o '"artistic_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          CULTURAL_CONTEXT=$(grep -o '"cultural_context"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          TIME_PERIOD=$(grep -o '"time_period"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          IMAGE_QUALITY=$(grep -o '"image_quality"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          
          echo "Scene type: $SCENE_TYPE"
          echo "Atmosphere: $ATMOSPHERE"
          echo "Depth mode: $DEPTH_MODE"
          echo "Lighting style: $LIGHTING_STYLE"
          echo "Movement energy: $MOVEMENT_ENERGY"
          echo "Color temperature: $COLOR_TEMPERATURE"
          echo "Perspective depth: $PERSPECTIVE_DEPTH"
          echo "Visual complexity: $VISUAL_COMPLEXITY"
          echo "Artistic style: $ARTISTIC_STYLE"
          echo "Cultural context: $CULTURAL_CONTEXT"
          echo "Time period: $TIME_PERIOD"
          echo "Image quality: $IMAGE_QUALITY"
          
          # GitHub Outputã«è¨­å®šï¼ˆåŸºæœ¬è¦ç´ ï¼‰
          echo "scene-type=$SCENE_TYPE" >> $GITHUB_OUTPUT
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "depth-mode=$DEPTH_MODE" >> $GITHUB_OUTPUT
          echo "lighting-style=$LIGHTING_STYLE" >> $GITHUB_OUTPUT
          echo "movement-energy=$MOVEMENT_ENERGY" >> $GITHUB_OUTPUT
          echo "color-temperature=$COLOR_TEMPERATURE" >> $GITHUB_OUTPUT
          
          # GitHub Outputã«è¨­å®šï¼ˆæ–°è¦è¿½åŠ è¦ç´ ï¼‰
          echo "perspective-depth=${PERSPECTIVE_DEPTH:-moderate}" >> $GITHUB_OUTPUT
          echo "visual-complexity=${VISUAL_COMPLEXITY:-moderate}" >> $GITHUB_OUTPUT
          echo "artistic-style=${ARTISTIC_STYLE:-realistic}" >> $GITHUB_OUTPUT
          echo "cultural-context=${CULTURAL_CONTEXT:-global}" >> $GITHUB_OUTPUT
          echo "time-period=${TIME_PERIOD:-contemporary}" >> $GITHUB_OUTPUT
          echo "image-quality=${IMAGE_QUALITY:-hi-fi}" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Image analysis JSON file not found"
          exit 1
        fi
        
        # æŽ¨å¥¨è¨­å®šã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/recommendations.txt" ]; then
          echo "::notice::âœ… Recommendations generated"
          echo "Recommendations:"
          cat "$ANALYSIS_DIR/recommendations.txt"
        else
          echo "::warning::âš ï¸ Recommendations file not found"
        fi
        
        # åˆ†æžæ–‡æ›¸ã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/image-analysis.md" ]; then
          echo "::notice::âœ… Analysis document generated"
          echo "First 10 lines of analysis:"
          head -10 "$ANALYSIS_DIR/image-analysis.md"
        else
          echo "::warning::âš ï¸ Analysis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push analysis
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          if [ -n "${{ inputs.image-prompt }}" ]; then
            git commit -m "Add image world analysis for prompt: ${{ inputs.image-prompt }}"
          elif [ -n "${{ inputs.image-url }}" ]; then
            git commit -m "Add image world analysis for URL: ${{ inputs.image-url }}"
          else
            git commit -m "Add image world analysis for file: ${{ inputs.image-file }}"
          fi
          git push origin ${{ inputs.branch-name }}
        fi