name: 'Image World Analysis'
description: 'Analyze images (prompts/URLs/files) to extract comprehensive world characteristics and visual properties'
author: 'KamuiCode Workflow'

inputs:
  image-prompt:
    description: 'The image prompt to analyze for world building'
    required: false
  image-url:
    description: 'URL of image to analyze for world characteristics'
    required: false
  image-file:
    description: 'Path to local image file for analysis'
    required: false
  folder-name:
    description: 'The folder name for storing analysis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true
  skip-commit:
    description: 'Skip commit and push step (for multimodal workflows)'
    required: false
    default: 'false'

outputs:
  analysis-completed:
    description: 'Whether analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  scene-type:
    description: 'Analyzed scene type (static/dynamic/dramatic)'
    value: ${{ steps.analysis.outputs.scene-type }}
  atmosphere:
    description: 'Overall atmosphere (peaceful/energetic/mysterious/etc)'
    value: ${{ steps.analysis.outputs.atmosphere }}
  depth-mode:
    description: 'Recommended depth enhancement (normal/enhanced)'
    value: ${{ steps.analysis.outputs.depth-mode }}
  lighting-style:
    description: 'Lighting characteristics (soft/bright/dramatic/etc)'
    value: ${{ steps.analysis.outputs.lighting-style }}
  movement-energy:
    description: 'Movement energy level (1-10 scale)'
    value: ${{ steps.analysis.outputs.movement-energy }}
  color-temperature:
    description: 'Color temperature (warm/cool/neutral)'
    value: ${{ steps.analysis.outputs.color-temperature }}
  perspective-depth:
    description: 'Spatial depth perception (shallow/moderate/deep)'
    value: ${{ steps.analysis.outputs.perspective-depth }}
  visual-complexity:
    description: 'Visual complexity level (simple/moderate/complex)'
    value: ${{ steps.analysis.outputs.visual-complexity }}
  artistic-style:
    description: 'Artistic movement/style (realistic/impressionistic/abstract/etc)'
    value: ${{ steps.analysis.outputs.artistic-style }}
  cultural-context:
    description: 'Cultural/regional context (western/eastern/global/etc)'
    value: ${{ steps.analysis.outputs.cultural-context }}
  time-period:
    description: 'Implied time period (vintage/contemporary/futuristic)'
    value: ${{ steps.analysis.outputs.time-period }}
  image-quality:
    description: 'Image quality assessment (lo-fi/hi-fi/professional)'
    value: ${{ steps.analysis.outputs.image-quality }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ÁîªÂÉè‰∏ñÁïåË¶≥ÂàÜÊûê„Ç®„Éº„Ç∏„Çß„É≥„Éà
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::üé® Image World Analysis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # Ë®≠ÂÆö„Å®ÂÖ•ÂäõÂΩ¢ÂºèÂà§ÂÆö
        IMAGE_PROMPT="${{ inputs.image-prompt }}"
        IMAGE_URL="${{ inputs.image-url }}"
        IMAGE_FILE="${{ inputs.image-file }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        ANALYSIS_DIR="$FOLDER_NAME/world-analysis"
        
        # ÂÖ•ÂäõÂΩ¢Âºè„ÅÆÂà§ÂÆö
        INPUT_TYPE=""
        INPUT_SOURCE=""
        if [ -n "$IMAGE_PROMPT" ]; then
          INPUT_TYPE="prompt"
          INPUT_SOURCE="$IMAGE_PROMPT"
          echo "Input type: Text prompt"
          echo "Image prompt: $IMAGE_PROMPT"
        elif [ -n "$IMAGE_URL" ]; then
          INPUT_TYPE="url"
          INPUT_SOURCE="$IMAGE_URL"
          echo "Input type: Image URL"
          echo "Image URL: $IMAGE_URL"
        elif [ -n "$IMAGE_FILE" ]; then
          INPUT_TYPE="file"
          INPUT_SOURCE="$IMAGE_FILE"
          echo "Input type: Image file"
          echo "Image file: $IMAGE_FILE"
        else
          echo "::error::‚ùå No input provided. Please specify image-prompt, image-url, or image-file"
          exit 1
        fi
        
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # ÂàÜÊûê„Éï„Ç©„É´„ÉÄ„Çí‰∫ãÂâç„Å´‰ΩúÊàê
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "üìÅ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # „Éó„É≠„É≥„Éó„Éà„ÅÆÊßãÁØâ
        PROMPT="„ÅÇ„Å™„Åü„ÅØÁîªÂÉè„Åã„ÇâÂåÖÊã¨ÁöÑ„Å™‰∏ñÁïåË¶≥ÁâπÊÄß„ÇíÊäΩÂá∫„Åô„ÇãÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÂÖ•ÂäõÂΩ¢Âºè„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´ÂàÜÊûê„Åó„ÄÅÊ±éÁî®ÁöÑ„Å™‰∏ñÁïåË¶≥„Éá„Éº„Çø„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

        **ÂÖ•ÂäõÊÉÖÂ†±**:
        - **ÂÖ•ÂäõÂΩ¢Âºè**: $INPUT_TYPE ($INPUT_TYPE = prompt/url/file)
        - **ÂàÜÊûêÂØæË±°**: $INPUT_SOURCE

        **ÂåÖÊã¨ÁöÑÂàÜÊûê„Çø„Çπ„ÇØ**:
        
        **Âü∫Êú¨‰∏ñÁïåË¶≥ÁâπÊÄß**:
        1. **„Ç∑„Éº„É≥„Çø„Ç§„Éó**: static/dynamic/dramatic „ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÂà§ÂÆö
        2. **Èõ∞Âõ≤Ê∞ó**: peaceful/energetic/mysterious/dramatic/romantic/adventurousÁ≠â„ÇíÁâπÂÆö
        3. **Ê∑±Â∫¶„É¢„Éº„Éâ**: normal(Ê®ôÊ∫ñ)/enhanced(Âº∑Ë™ø)„ÅÆ„Å©„Å°„Çâ„ÅåÈÅ©Âàá„Åã„ÇíÂà§ÂÆö
        4. **ÁÖßÊòé„Çπ„Çø„Ç§„É´**: soft/bright/dramatic/dim/warm/coolÁ≠â„ÅÆÁâπÊÄß
        5. **Âãï„Åç„Ç®„Éç„É´„ÇÆ„Éº**: 1-10„ÅÆ„Çπ„Ç±„Éº„É´„ÅßÂãï„Åç„ÅÆÊøÄ„Åó„Åï„ÇíË©ï‰æ°
        6. **Ëâ≤Ê∏©Â∫¶**: warm(ÊöñËâ≤Á≥ª)/cool(ÂØíËâ≤Á≥ª)/neutral(‰∏≠ÊÄß)„ÇíÂà§ÂÆö

        **Êñ∞Ë¶èËøΩÂä†ÂàÜÊûêË¶ÅÁ¥†**:
        7. **Á©∫ÈñìÁâπÊÄß**: 
           - perspective_depth: shallow/moderate/deep (Â••Ë°å„ÅçÊÑü)
           - subject_distance: close/medium/distant (Ë¢´ÂÜô‰Ωì„Å®„ÅÆË∑ùÈõ¢ÊÑü)
           - environmental_scale: intimate/spacious/vast (Áí∞Â¢É„Çπ„Ç±„Éº„É´)
        8. **ÂãïÁöÑÁâπÊÄß**:
           - implied_movement: still/gentle/active (ÊöóÁ§∫„Åï„Çå„ÇãÂãï„Åç)
           - visual_complexity: simple/moderate/complex (Ë¶ñË¶öÁöÑË§áÈõëÂ∫¶)
           - composition_balance: stable/dynamic/tension (ÊßãÂõ≥„Éê„É©„É≥„Çπ)
        9. **ÊñáÂåñÁâπÊÄß**:
           - artistic_style: realistic/impressionistic/abstract/surrealÁ≠â (Ëä∏Ë°ìÊßòÂºè)
           - cultural_context: western/eastern/global/fusionÁ≠â (ÊñáÂåñÁöÑËÉåÊôØ)
           - time_period: vintage/contemporary/futuristic (ÊôÇ‰ª£ÊÄß)
        10. **ÊäÄË°ìÁâπÊÄß**:
            - image_quality: lo-fi/hi-fi/professional (ÁîªË≥™Ë©ï‰æ°)
            - artistic_processing: natural/processed/heavily_modified (Âä†Â∑•Â∫¶)

        **ÂÖ•ÂäõÂΩ¢ÂºèÂà•Âá¶ÁêÜ**:
        - **prompt**: „ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ„Åã„Çâ‰∏ñÁïåË¶≥„ÇíÊé®Ë´ñ
        - **url**: ÊåáÂÆöURL„ÅÆÁîªÂÉè„ÇíÂèñÂæó„ÉªÂàÜÊûêÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
        - **file**: ÊåáÂÆö„Éï„Ç°„Ç§„É´„Éë„Çπ„ÅÆÁîªÂÉè„ÇíÂàÜÊûêÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ

        **„Ç®„É©„ÉºËÄêÊÄß**: ÂàÜÊûêÂõ∞Èõ£„Å™Ë¶ÅÁ¥†„ÅØ\"moderate\"„ÇÑ\"unknown\"Á≠â„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„Çí‰ΩøÁî®
        
        **ÂøÖÈ†àÂá∫Âäõ„Éï„Ç°„Ç§„É´**:
        1. **$ANALYSIS_DIR/image-analysis.json** - Ê©üÊ¢∞Âá¶ÁêÜÁî®„ÅÆÊßãÈÄ†Âåñ„Éá„Éº„Çø
        2. **$ANALYSIS_DIR/image-analysis.md** - ‰∫∫ÈñìÁ¢∫Ë™çÁî®„ÅÆË©≥Á¥∞ÂàÜÊûêÁµêÊûú
        3. **$ANALYSIS_DIR/recommendations.txt** - Ë®≠ÂÆöÊé®Â•®ÂÄ§Ôºà1Ë°åÂΩ¢ÂºèÔºâ

        **JSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰æã**:
        \`\`\`json
        {
          \"scene_type\": \"dynamic\",
          \"atmosphere\": \"peaceful\",
          \"depth_mode\": \"enhanced\",
          \"lighting_style\": \"soft\",
          \"movement_energy\": 3,
          \"color_temperature\": \"warm\",
          \"perspective_depth\": \"moderate\",
          \"subject_distance\": \"medium\",
          \"environmental_scale\": \"spacious\",
          \"implied_movement\": \"gentle\",
          \"visual_complexity\": \"moderate\",
          \"composition_balance\": \"stable\",
          \"artistic_style\": \"realistic\",
          \"cultural_context\": \"western\",
          \"time_period\": \"contemporary\",
          \"image_quality\": \"hi-fi\",
          \"artistic_processing\": \"natural\",
          \"confidence\": 0.85,
          \"input_type\": \"$INPUT_TYPE\"
        }
        \`\`\`

        **ÈáçË¶Å„Å™Ê≥®ÊÑèÁÇπ**:
        1. ÂøÖ„Åö3„Å§„ÅÆ„Éï„Ç°„Ç§„É´„Åô„Åπ„Å¶„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        2. JSONÂΩ¢Âºè„ÅØÂé≥ÂØÜ„Å´Âæì„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºàÊ©üÊ¢∞Âá¶ÁêÜÁî®Ôºâ
        3. ÂàÜÊûêÁêÜÁî±„ÇíÊòéÁ¢∫„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        4. 360Â∫¶„Éë„Éé„É©„Éû„Éª„Éù„Ç§„É≥„Éà„ÇØ„É©„Ç¶„Éâ‰ΩìÈ®ì„Å´ÊúÄÈÅ©Âåñ„Åó„ÅüÊé®Â•®„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ
        5. „Éï„Ç°„Ç§„É´‰ΩúÊàêÂæå„ÄÅ„Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÁ¢∫Ë™ç„ÉªÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        
        echo "üöÄ Starting Image World Analysis Agent Claude Code CLI..."
        echo "üìù Prompt length: ${#PROMPT}"
        
        # Claude Code CLI„ÅÆÂÆüË°å
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 15 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::‚ùå Claude Code CLI execution failed"
            exit 1
          }
        
        # ÁîüÊàê„Åï„Çå„ÅüÂàÜÊûêÁµêÊûú„ÅÆÁ¢∫Ë™ç
        echo ""
        echo "üìã Checking generated analysis files..."
        
        # JSONÂàÜÊûêÁµêÊûú„ÅÆÁ¢∫Ë™ç„Å®Âá∫ÂäõË®≠ÂÆö
        if [ -f "$ANALYSIS_DIR/image-analysis.json" ]; then
          echo "::notice::‚úÖ Image analysis JSON generated"
          
          # jq„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ‰ª£ÊõøÊâãÊÆµ„ÅßJSON„Åã„ÇâÂÄ§„ÇíÊäΩÂá∫
          SCENE_TYPE=$(grep -o '"scene_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          DEPTH_MODE=$(grep -o '"depth_mode"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          LIGHTING_STYLE=$(grep -o '"lighting_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          MOVEMENT_ENERGY=$(grep -o '"movement_energy"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/image-analysis.json" | cut -d':' -f2 | tr -d ' ')
          COLOR_TEMPERATURE=$(grep -o '"color_temperature"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          
          # Êñ∞Ë¶èËøΩÂä†Ë¶ÅÁ¥†„ÅÆÊäΩÂá∫
          PERSPECTIVE_DEPTH=$(grep -o '"perspective_depth"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          VISUAL_COMPLEXITY=$(grep -o '"visual_complexity"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          ARTISTIC_STYLE=$(grep -o '"artistic_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          CULTURAL_CONTEXT=$(grep -o '"cultural_context"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          TIME_PERIOD=$(grep -o '"time_period"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          IMAGE_QUALITY=$(grep -o '"image_quality"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          
          echo "Scene type: $SCENE_TYPE"
          echo "Atmosphere: $ATMOSPHERE"
          echo "Depth mode: $DEPTH_MODE"
          echo "Lighting style: $LIGHTING_STYLE"
          echo "Movement energy: $MOVEMENT_ENERGY"
          echo "Color temperature: $COLOR_TEMPERATURE"
          echo "Perspective depth: $PERSPECTIVE_DEPTH"
          echo "Visual complexity: $VISUAL_COMPLEXITY"
          echo "Artistic style: $ARTISTIC_STYLE"
          echo "Cultural context: $CULTURAL_CONTEXT"
          echo "Time period: $TIME_PERIOD"
          echo "Image quality: $IMAGE_QUALITY"
          
          # GitHub Output„Å´Ë®≠ÂÆöÔºàÂü∫Êú¨Ë¶ÅÁ¥†Ôºâ
          echo "scene-type=$SCENE_TYPE" >> $GITHUB_OUTPUT
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "depth-mode=$DEPTH_MODE" >> $GITHUB_OUTPUT
          echo "lighting-style=$LIGHTING_STYLE" >> $GITHUB_OUTPUT
          echo "movement-energy=$MOVEMENT_ENERGY" >> $GITHUB_OUTPUT
          echo "color-temperature=$COLOR_TEMPERATURE" >> $GITHUB_OUTPUT
          
          # GitHub Output„Å´Ë®≠ÂÆöÔºàÊñ∞Ë¶èËøΩÂä†Ë¶ÅÁ¥†Ôºâ
          echo "perspective-depth=${PERSPECTIVE_DEPTH:-moderate}" >> $GITHUB_OUTPUT
          echo "visual-complexity=${VISUAL_COMPLEXITY:-moderate}" >> $GITHUB_OUTPUT
          echo "artistic-style=${ARTISTIC_STYLE:-realistic}" >> $GITHUB_OUTPUT
          echo "cultural-context=${CULTURAL_CONTEXT:-global}" >> $GITHUB_OUTPUT
          echo "time-period=${TIME_PERIOD:-contemporary}" >> $GITHUB_OUTPUT
          echo "image-quality=${IMAGE_QUALITY:-hi-fi}" >> $GITHUB_OUTPUT
        else
          echo "::error::‚ùå Image analysis JSON file not found"
          exit 1
        fi
        
        # Êé®Â•®Ë®≠ÂÆö„ÅÆÁ¢∫Ë™ç
        if [ -f "$ANALYSIS_DIR/recommendations.txt" ]; then
          echo "::notice::‚úÖ Recommendations generated"
          echo "Recommendations:"
          cat "$ANALYSIS_DIR/recommendations.txt"
        else
          echo "::warning::‚ö†Ô∏è Recommendations file not found"
        fi
        
        # ÂàÜÊûêÊñáÊõ∏„ÅÆÁ¢∫Ë™ç
        if [ -f "$ANALYSIS_DIR/image-analysis.md" ]; then
          echo "::notice::‚úÖ Analysis document generated"
          echo "First 10 lines of analysis:"
          head -10 "$ANALYSIS_DIR/image-analysis.md"
        else
          echo "::warning::‚ö†Ô∏è Analysis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push analysis
      if: ${{ inputs.skip-commit != 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          if [ -n "${{ inputs.image-prompt }}" ]; then
            git commit -m "Add image world analysis for prompt: ${{ inputs.image-prompt }}"
          elif [ -n "${{ inputs.image-url }}" ]; then
            git commit -m "Add image world analysis for URL: ${{ inputs.image-url }}"
          else
            git commit -m "Add image world analysis for file: ${{ inputs.image-file }}"
          fi
          # Pull before push to handle concurrent commits
          for i in {1..3}; do
            git add . && git pull origin ${{ inputs.branch-name }} --rebase && git push origin ${{ inputs.branch-name }} && break
            echo "Push attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
        fi
    
    - name: Skip commit message
      if: ${{ inputs.skip-commit == 'true' }}
      shell: bash
      run: |
        echo "::notice::‚è≠Ô∏è Commit and push skipped for multimodal workflow"