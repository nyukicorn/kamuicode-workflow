name: 'Image Generation'
description: 'Generate images using Imagen4 Fast via KamuiCode MCP'
author: 'KamuiCode Workflow'

inputs:
  image-prompt:
    description: 'The image generation prompt'
    required: true
  image-model:
    description: 'Image generation model (auto/imagen4-ultra/imagen4-fast/imagen3/flux-schnell/photo-flux)'
    required: false
    default: 'auto'
  folder-name:
    description: 'The folder name for storing image files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true
  mcp-config:
    description: 'MCP configuration JSON'
    required: true

outputs:
  image-completed:
    description: 'Whether image generation was completed successfully'
    value: ${{ steps.image.outputs.completed }}
  google-image-url:
    description: 'Google URL of the generated image'
    value: ${{ steps.image.outputs.google-image-url }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Imagen4 Fast)
      id: image
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¨ Image Generation (Imagen4 Fast)"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        IMAGE_PROMPT="${{ inputs.image-prompt }}"
        IMAGE_MODEL="${{ inputs.image-model }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        IMAGES_DIR="$FOLDER_NAME/images"
        
        echo "Image prompt: $IMAGE_PROMPT"
        echo "Selected model: $IMAGE_MODEL"
        echo "Target folder: $IMAGES_DIR"
        
        # ãƒ¢ãƒ‡ãƒ«é¸æŠžãƒ­ã‚¸ãƒƒã‚¯ï¼ˆAIè‡ªå‹•é¸æŠžå¯¾å¿œï¼‰
        if [ "$IMAGE_MODEL" == "auto" ]; then
          echo "ðŸ¤– AI Auto Selection Mode"
          # ã‚³ãƒ³ã‚»ãƒ—ãƒˆè§£æžã§ãƒ¢ãƒ‡ãƒ«è‡ªå‹•é¸æŠž
          if echo "$IMAGE_PROMPT" | grep -iE "(realistic|photo|real|portrait|landscape)" > /dev/null; then
            SELECTED_MODEL="imagen4-ultra"
            echo "ðŸ“¸ Detected realistic content â†’ Imagen4 Ultra"
          elif echo "$IMAGE_PROMPT" | grep -iE "(anime|cartoon|illustration|art)" > /dev/null; then
            SELECTED_MODEL="flux-schnell"
            echo "ðŸŽ¨ Detected artistic content â†’ Flux Schnell"
          elif echo "$IMAGE_PROMPT" | grep -iE "(fast|quick|speed)" > /dev/null; then
            SELECTED_MODEL="imagen4-fast"
            echo "âš¡ Detected speed preference â†’ Imagen4 Fast"
          else
            SELECTED_MODEL="imagen4-fast"
            echo "ðŸ”„ Default selection â†’ Imagen4 Fast"
          fi
        else
          SELECTED_MODEL="$IMAGE_MODEL"
          echo "ðŸ‘¤ User selection â†’ $SELECTED_MODEL"
        fi
        
        # ãƒ¢ãƒ‡ãƒ«åˆ¥MCPè¨­å®š
        case "$SELECTED_MODEL" in
          "imagen4-ultra")
            MCP_SERVICE_PREFIX="mcp__t2i-fal-imagen4-ultra"
            TOOLS_LIST="mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash"
            MODEL_NAME="Imagen4 Ultra"
            ;;
          "imagen4-fast")
            MCP_SERVICE_PREFIX="mcp__t2i-fal-imagen4-fast"
            TOOLS_LIST="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash"
            MODEL_NAME="Imagen4 Fast"
            ;;
          "imagen3")
            MCP_SERVICE_PREFIX="mcp__t2i-google-imagen3"
            TOOLS_LIST="mcp__t2i-google-imagen3__imagen3_submit,mcp__t2i-google-imagen3__imagen3_status,mcp__t2i-google-imagen3__imagen3_result,Bash"
            MODEL_NAME="Google Imagen3"
            ;;
          "flux-schnell")
            MCP_SERVICE_PREFIX="mcp__t2i-fal-flux-schnell"
            TOOLS_LIST="mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result,Bash"
            MODEL_NAME="Flux Schnell"
            ;;
          "photo-flux")
            MCP_SERVICE_PREFIX="mcp__t2i-fal-rundiffusion-photo-flux"
            TOOLS_LIST="mcp__t2i-fal-rundiffusion-photo-flux__photo_flux_submit,mcp__t2i-fal-rundiffusion-photo-flux__photo_flux_status,mcp__t2i-fal-rundiffusion-photo-flux__photo_flux_result,Bash"
            MODEL_NAME="Photo Flux"
            ;;
          *)
            echo "âš ï¸ Unknown model: $SELECTED_MODEL, falling back to Imagen4 Fast"
            MCP_SERVICE_PREFIX="mcp__t2i-fal-imagen4-fast"
            TOOLS_LIST="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash"
            MODEL_NAME="Imagen4 Fast (Fallback)"
            ;;
        esac
        
        echo "âœ… Final selection: $MODEL_NAME"
        echo "ðŸ”§ MCP Service: $MCP_SERVICE_PREFIX"
        
        # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$IMAGES_DIR" ]; then
          mkdir -p "$IMAGES_DIR"
          echo "ðŸ“ Created images folder: $IMAGES_DIR"
        fi
        
        # MCPè¨­å®šã®ç¢ºèª
        MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
        MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
        
        echo "ðŸ“‹ MCP Configuration Check:"
        echo "Working directory: $(pwd)"
        echo "MCP config path: $MCP_CONFIG_PATH"
        echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
        echo "Allowed tools: $TOOLS_LIST"
        
        # Create MCP config file from GitHub Secret
        mkdir -p .claude
        echo '${{ inputs.mcp-config }}' > "$MCP_CONFIG_ABS_PATH"
        echo "âœ… MCP config file created from GitHub Secret"
        
        # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
          echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
          echo "MCP servers configured:"
          jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" || true
        else
          echo "âŒ MCP config file creation failed"
          exit 1
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰ - å‹•çš„ãƒ¢ãƒ‡ãƒ«å¯¾å¿œç‰ˆ
        PROMPT="ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

        **é¸æŠžãƒ¢ãƒ‡ãƒ«**: $MODEL_NAME
        **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆè‹±èªžï¼‰**: $IMAGE_PROMPT

        **å®Ÿè¡Œæ‰‹é †**:
        1. ä¸Šè¨˜ã®è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦$MODEL_NAMEã§ç”»åƒç”Ÿæˆ
        2. \`${MCP_SERVICE_PREFIX}__submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
        3. \`${MCP_SERVICE_PREFIX}__status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        4. \`${MCP_SERVICE_PREFIX}__result\`ã§çµæžœå–å¾—ã—ã¦Google URLã‚’å–å¾—
        5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/generated-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

        **é‡è¦ãªæ³¨æ„ç‚¹**:
        - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
        - ç”»åƒã¯å¿…ãšã€Œ$IMAGES_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
        - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œgenerated-image.pngã€ã¨ã™ã‚‹
        - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜

        **ä¿å­˜å…ˆ**:
        - ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $IMAGES_DIR
        - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: generated-image.png
        - Google URLä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«: $FOLDER_NAME/google-image-url.txt"
        
        echo "ðŸš€ Starting Image Generation Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --mcp-config="$MCP_CONFIG_ABS_PATH" \
          --allowedTools "$TOOLS_LIST" \
          --max-turns 25 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
        echo ""
        echo "ðŸ“¸ Checking generated images..."
        if [ -d "$IMAGES_DIR" ]; then
          IMAGE_COUNT=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
          echo "::notice::ðŸ“¸ Generated $IMAGE_COUNT images"
          if [ "$IMAGE_COUNT" -gt 0 ]; then
            echo "Image files:"
            FIRST_IMAGE=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -1)
            echo "First image: $FIRST_IMAGE"
            
            # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
            if [ -f "$FOLDER_NAME/google-image-url.txt" ]; then
              GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url.txt")
              echo "Google image URL: $GOOGLE_URL"
              echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            else
              echo "::warning::âš ï¸ Google image URL not found in file"
              echo "google-image-url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ No image files were generated"
            exit 1
          fi
        else
          echo "::error::âŒ Images directory not found"
          exit 1
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit and push image
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No image files to commit"
        else
          git commit -m "Add generated image: ${{ inputs.image-prompt }}"
          git push origin ${{ inputs.branch-name }}
        fi