name: 'World Synthesis V2'
description: 'Flexibly synthesize any combination of world analyses into unified settings'
author: 'KamuiCode Workflow'

inputs:
  # JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç›´æŽ¥æŒ‡å®šã™ã‚‹æ–°æ–¹å¼
  image-analysis-json:
    description: 'Path to image world analysis JSON file'
    required: false
  music-analysis-json:
    description: 'Path to music world analysis JSON file' 
    required: false
  speech-analysis-json:
    description: 'Path to speech world analysis JSON file'
    required: false
  video-analysis-json:
    description: 'Path to video world analysis JSON file'
    required: false
  
  # å…±é€šè¨­å®š
  primary-weight:
    description: 'Primary analysis weight (auto/image/music/speech/video/balanced)'
    required: false
    default: 'auto'
  folder-name:
    description: 'The folder name for storing synthesis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  synthesis-completed:
    description: 'Whether synthesis was completed successfully'
    value: ${{ steps.synthesis.outputs.completed }}
  input-count:
    description: 'Number of analysis inputs processed'
    value: ${{ steps.synthesis.outputs.input-count }}
  primary-source:
    description: 'Primary source used for synthesis'
    value: ${{ steps.synthesis.outputs.primary-source }}
  final-depth-mode:
    description: 'Final depth enhancement recommendation'
    value: ${{ steps.synthesis.outputs.depth-mode }}
  final-atmosphere:
    description: 'Synthesized atmosphere'
    value: ${{ steps.synthesis.outputs.atmosphere }}
  brightness-level:
    description: 'Recommended brightness level (0.3-1.2)'
    value: ${{ steps.synthesis.outputs.brightness-level }}
  rotation-speed:
    description: 'Recommended rotation speed (0.1-2.0)'
    value: ${{ steps.synthesis.outputs.rotation-speed }}
  particle-energy:
    description: 'Recommended particle interaction energy (0.1-1.0)'
    value: ${{ steps.synthesis.outputs.particle-energy }}
  auto-rotate:
    description: 'Whether auto-rotation should be enabled'
    value: ${{ steps.synthesis.outputs.auto-rotate }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: æŸ”è»Ÿãªä¸–ç•Œè¦³çµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: synthesis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŒ Flexible World Synthesis Agent V2"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        FOLDER_NAME="${{ inputs.folder-name }}"
        SYNTHESIS_DIR="$FOLDER_NAME/world-synthesis"
        PRIMARY_WEIGHT="${{ inputs.primary-weight }}"
        
        # å…¥åŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ã®åŽé›†
        IMAGE_JSON="${{ inputs.image-analysis-json }}"
        MUSIC_JSON="${{ inputs.music-analysis-json }}"
        SPEECH_JSON="${{ inputs.speech-analysis-json }}"
        VIDEO_JSON="${{ inputs.video-analysis-json }}"
        
        echo "Synthesis folder: $SYNTHESIS_DIR"
        echo "Primary weight: $PRIMARY_WEIGHT"
        
        # çµ±åˆãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$SYNTHESIS_DIR" ]; then
          mkdir -p "$SYNTHESIS_DIR"
          echo "ðŸ“ Created synthesis folder: $SYNTHESIS_DIR"
        fi
        
        # åˆ©ç”¨å¯èƒ½ãªå…¥åŠ›ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        INPUT_COUNT=0
        AVAILABLE_INPUTS=""
        
        # ãƒ‡ãƒãƒƒã‚°ï¼šå…¥åŠ›å¤‰æ•°ã®ç¢ºèª
        echo "ðŸ” Debug: IMAGE_JSON='$IMAGE_JSON'"
        echo "ðŸ” Debug: MUSIC_JSON='$MUSIC_JSON'"
        echo "ðŸ” Debug: SPEECH_JSON='$SPEECH_JSON'"
        echo "ðŸ” Debug: VIDEO_JSON='$VIDEO_JSON'"
        echo "ðŸ” Debug: Current directory: $(pwd)"
        echo "ðŸ” Debug: Directory contents:"
        ls -la || true
        
        if [ -n "$IMAGE_JSON" ]; then
          echo "ðŸ” IMAGE_JSON is not empty: '$IMAGE_JSON'"
          if [ -f "$IMAGE_JSON" ]; then
            INPUT_COUNT=$((INPUT_COUNT + 1))
            AVAILABLE_INPUTS="${AVAILABLE_INPUTS}image "
            echo "âœ… Image analysis JSON found: $IMAGE_JSON"
          else
            echo "âŒ Image analysis JSON file not found: $IMAGE_JSON"
          fi
        else
          echo "ðŸ” IMAGE_JSON is empty or null"
        fi
        
        if [ -n "$MUSIC_JSON" ]; then
          echo "ðŸ” MUSIC_JSON is not empty: '$MUSIC_JSON'"
          if [ -f "$MUSIC_JSON" ]; then
            INPUT_COUNT=$((INPUT_COUNT + 1))
            AVAILABLE_INPUTS="${AVAILABLE_INPUTS}music "
            echo "âœ… Music analysis JSON found: $MUSIC_JSON"
          else
            echo "âŒ Music analysis JSON file not found: $MUSIC_JSON"
          fi
        else
          echo "ðŸ” MUSIC_JSON is empty or null"
        fi
        
        if [ -n "$SPEECH_JSON" ] && [ -f "$SPEECH_JSON" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          AVAILABLE_INPUTS="${AVAILABLE_INPUTS}speech "
          echo "âœ… Speech analysis JSON found: $SPEECH_JSON"
        fi
        
        if [ -n "$VIDEO_JSON" ] && [ -f "$VIDEO_JSON" ]; then
          INPUT_COUNT=$((INPUT_COUNT + 1))
          AVAILABLE_INPUTS="${AVAILABLE_INPUTS}video "
          echo "âœ… Video analysis JSON found: $VIDEO_JSON"
        fi
        
        echo "Total inputs available: $INPUT_COUNT"
        echo "Available input types: $AVAILABLE_INPUTS"
        
        if [ "$INPUT_COUNT" -eq 0 ]; then
          echo "::error::âŒ No analysis input files provided"
          exit 1
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯æŸ”è»Ÿãªä¸–ç•Œè¦³çµ±åˆã®å°‚é–€å®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸä»»æ„ã®çµ„ã¿åˆã‚ã›ã®åˆ†æžçµæžœã‹ã‚‰ã€æœ€é©ãª3Dä½“é¨“è¨­å®šã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

        **åˆ©ç”¨å¯èƒ½ãªå…¥åŠ›**: $AVAILABLE_INPUTS ($INPUT_COUNT å€‹)
        **çµ±åˆæˆ¦ç•¥**: $PRIMARY_WEIGHT"
        
        # å„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¿½åŠ 
        if [ -n "$IMAGE_JSON" ] && [ -f "$IMAGE_JSON" ]; then
          PROMPT="$PROMPT

        **ç”»åƒåˆ†æžãƒ‡ãƒ¼ã‚¿** ($IMAGE_JSON):
        æä¾›ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        if [ -n "$MUSIC_JSON" ] && [ -f "$MUSIC_JSON" ]; then
          PROMPT="$PROMPT

        **éŸ³æ¥½åˆ†æžãƒ‡ãƒ¼ã‚¿** ($MUSIC_JSON):
        æä¾›ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
        â€»æ„Ÿæƒ…æ›²ç·šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ emotion-curves.srt ã¾ãŸã¯ emotion-curves.json ã‚‚å‚ç…§"
        fi
        
        if [ -n "$SPEECH_JSON" ] && [ -f "$SPEECH_JSON" ]; then
          PROMPT="$PROMPT

        **éŸ³å£°åˆ†æžãƒ‡ãƒ¼ã‚¿** ($SPEECH_JSON):
        æä¾›ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        if [ -n "$VIDEO_JSON" ] && [ -f "$VIDEO_JSON" ]; then
          PROMPT="$PROMPT

        **å‹•ç”»åˆ†æžãƒ‡ãƒ¼ã‚¿** ($VIDEO_JSON):
        æä¾›ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        PROMPT="$PROMPT

        **çµ±åˆã‚¿ã‚¹ã‚¯**:
        1. å„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ä¸–ç•Œè¦³ç‰¹æ€§ã‚’æŠ½å‡º
        2. åˆ©ç”¨å¯èƒ½ãªåˆ†æžçµæžœã«åŸºã¥ã„ã¦æœ€é©ãªè¨­å®šã‚’æ±ºå®š
        3. å˜ä¸€å…¥åŠ›ã®å ´åˆã¯ã€ãã®ç‰¹æ€§ã‚’æœ€å¤§é™æ´»ç”¨
        4. è¤‡æ•°å…¥åŠ›ã®å ´åˆã¯ã€èª¿å’Œçš„ã«çµ±åˆ
        5. primary-weight='auto'ã®å ´åˆã¯ã€å…¥åŠ›ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦è‡ªå‹•åˆ¤æ–­

        **é©å¿œçš„çµ±åˆãƒ«ãƒ¼ãƒ«**:
        - **1å…¥åŠ›ã®å ´åˆ**: ãã®å…¥åŠ›ã®ç‰¹æ€§ã‚’ãƒ•ãƒ«ã«åæ˜ 
        - **2å…¥åŠ›ã®å ´åˆ**: ä¸»å¾“é–¢ä¿‚ã‚’æ˜Žç¢ºã«ã—ã¦çµ±åˆ
        - **3å…¥åŠ›ä»¥ä¸Š**: å¤šå±¤çš„ãªä¸–ç•Œè¦³ã‚’æ§‹ç¯‰
        - **ç«¶åˆè§£æ±º**: ã‚ˆã‚Šå…·ä½“çš„ãƒ»è©³ç´°ãªåˆ†æžã‚’å„ªå…ˆ

        **å‡ºåŠ›è¨­å®šã®æ±ºå®š**:
        - **depth_mode**: ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã (dramatic/dynamicâ†’enhanced)
        - **brightness_level**: é›°å›²æ°—ã«åŸºã¥ã (0.3-1.2)
        - **rotation_speed**: ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã (0.1-2.0)
        - **particle_energy**: å‹•ãã®å¼·åº¦ã«åŸºã¥ã (0.1-1.0)
        - **auto_rotate**: ã‚·ãƒ¼ãƒ³ã®é™å‹•ã«åŸºã¥ã

        **å¿…é ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**:
        1. **$SYNTHESIS_DIR/world-synthesis.json** - æœ€çµ‚è¨­å®š
        2. **$SYNTHESIS_DIR/world-synthesis.md** - çµ±åˆè§£èª¬
        3. **$SYNTHESIS_DIR/final-settings.txt** - 1è¡Œè¨­å®šå€¤
        4. **$SYNTHESIS_DIR/input-summary.json** - å…¥åŠ›ã‚µãƒžãƒªãƒ¼

        **JSONãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ**:
        \`\`\`json
        {
          \"depth_mode\": \"enhanced\",
          \"atmosphere\": \"mysterious_energetic\",
          \"brightness_level\": 0.6,
          \"rotation_speed\": 0.4,
          \"particle_energy\": 0.6,
          \"auto_rotate\": true,
          \"synthesis_confidence\": 0.9,
          \"input_sources\": [\"image\", \"music\"],
          \"primary_influence\": \"balanced\",
          \"reasoning\": \"çµ±åˆç†ç”±ã®è©³ç´°\",
          \"input_count\": $INPUT_COUNT
        }
        \`\`\`

        **é‡è¦**: 
        - æä¾›ã•ã‚ŒãŸå…¥åŠ›ã®ã¿ã‚’ä½¿ç”¨ï¼ˆå­˜åœ¨ã—ãªã„å…¥åŠ›ã¯ç„¡è¦–ï¼‰
        - å˜ä¸€å…¥åŠ›ã§ã‚‚å®Œå…¨ãªè¨­å®šã‚’ç”Ÿæˆ
        - å…¥åŠ›ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸæœ€é©åŒ–ã‚’å®Ÿæ–½"
        
        echo "ðŸš€ Starting Flexible World Synthesis..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 20 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸçµ±åˆçµæžœã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated synthesis files..."
        
        # JSONçµ±åˆçµæžœã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
        if [ -f "$SYNTHESIS_DIR/world-synthesis.json" ]; then
          echo "::notice::âœ… World synthesis JSON generated"
          
          # JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          DEPTH_MODE=$(grep -o '"depth_mode"[[:space:]]*:[[:space:]]*"[^"]*"' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d'"' -f4)
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d'"' -f4)
          BRIGHTNESS_LEVEL=$(grep -o '"brightness_level"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          ROTATION_SPEED=$(grep -o '"rotation_speed"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          PARTICLE_ENERGY=$(grep -o '"particle_energy"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          AUTO_ROTATE=$(grep -o '"auto_rotate"[[:space:]]*:[[:space:]]*[a-z]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          PRIMARY_SOURCE=$(grep -o '"primary_influence"[[:space:]]*:[[:space:]]*"[^"]*"' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d'"' -f4)
          
          echo "Final depth mode: $DEPTH_MODE"
          echo "Final atmosphere: $ATMOSPHERE"
          echo "Brightness level: $BRIGHTNESS_LEVEL"
          echo "Rotation speed: $ROTATION_SPEED"
          echo "Particle energy: $PARTICLE_ENERGY"
          echo "Auto rotate: $AUTO_ROTATE"
          echo "Primary source: $PRIMARY_SOURCE"
          
          # GitHub Outputã«è¨­å®š
          echo "depth-mode=$DEPTH_MODE" >> $GITHUB_OUTPUT
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "brightness-level=${BRIGHTNESS_LEVEL:-0.8}" >> $GITHUB_OUTPUT
          echo "rotation-speed=${ROTATION_SPEED:-0.5}" >> $GITHUB_OUTPUT
          echo "particle-energy=${PARTICLE_ENERGY:-0.3}" >> $GITHUB_OUTPUT
          echo "auto-rotate=${AUTO_ROTATE:-true}" >> $GITHUB_OUTPUT
          echo "input-count=$INPUT_COUNT" >> $GITHUB_OUTPUT
          echo "primary-source=${PRIMARY_SOURCE:-auto}" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ World synthesis JSON file not found"
          exit 1
        fi
        
        # input-summary.jsonã®ç¢ºèª
        if [ -f "$SYNTHESIS_DIR/input-summary.json" ]; then
          echo "::notice::âœ… Input summary generated"
          cat "$SYNTHESIS_DIR/input-summary.json"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push synthesis
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No synthesis files to commit"
        else
          git commit -m "Add flexible world synthesis results (v2)"
          git push origin ${{ inputs.branch-name }}
        fi