name: 'World Synthesis'
description: 'Synthesize multiple world analyses into unified settings for immersive experience'
author: 'KamuiCode Workflow'

inputs:
  image-scene-type:
    description: 'Scene type from image analysis'
    required: true
  image-atmosphere:
    description: 'Atmosphere from image analysis'
    required: true
  image-depth-mode:
    description: 'Depth mode from image analysis'
    required: true
  image-lighting-style:
    description: 'Lighting style from image analysis'
    required: true
  image-movement-energy:
    description: 'Movement energy from image analysis'
    required: true
  image-color-temperature:
    description: 'Color temperature from image analysis'
    required: true
  music-atmosphere:
    description: 'Atmosphere from music analysis (optional)'
    required: false
    default: ''
  music-energy:
    description: 'Energy level from music analysis (optional)'
    required: false
    default: ''
  primary-weight:
    description: 'Primary analysis weight (image/music/balanced)'
    required: false
    default: 'image'
  folder-name:
    description: 'The folder name for storing synthesis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  synthesis-completed:
    description: 'Whether synthesis was completed successfully'
    value: ${{ steps.synthesis.outputs.completed }}
  final-depth-mode:
    description: 'Final depth enhancement recommendation'
    value: ${{ steps.synthesis.outputs.depth-mode }}
  final-atmosphere:
    description: 'Synthesized atmosphere'
    value: ${{ steps.synthesis.outputs.atmosphere }}
  brightness-level:
    description: 'Recommended brightness level (0.3-1.2)'
    value: ${{ steps.synthesis.outputs.brightness-level }}
  rotation-speed:
    description: 'Recommended rotation speed (0.1-2.0)'
    value: ${{ steps.synthesis.outputs.rotation-speed }}
  particle-energy:
    description: 'Recommended particle interaction energy (0.1-1.0)'
    value: ${{ steps.synthesis.outputs.particle-energy }}
  auto-rotate:
    description: 'Whether auto-rotation should be enabled'
    value: ${{ steps.synthesis.outputs.auto-rotate }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ä¸–ç•Œè¦³çµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: synthesis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŒ World Synthesis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        FOLDER_NAME="${{ inputs.folder-name }}"
        SYNTHESIS_DIR="$FOLDER_NAME/world-synthesis"
        PRIMARY_WEIGHT="${{ inputs.primary-weight }}"
        
        echo "Synthesis folder: $SYNTHESIS_DIR"
        echo "Primary weight: $PRIMARY_WEIGHT"
        
        # çµ±åˆãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$SYNTHESIS_DIR" ]; then
          mkdir -p "$SYNTHESIS_DIR"
          echo "ðŸ“ Created synthesis folder: $SYNTHESIS_DIR"
        fi
        
        # å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†
        IMAGE_DATA="Scene Type: ${{ inputs.image-scene-type }}
        Atmosphere: ${{ inputs.image-atmosphere }}
        Depth Mode: ${{ inputs.image-depth-mode }}
        Lighting Style: ${{ inputs.image-lighting-style }}
        Movement Energy: ${{ inputs.image-movement-energy }}
        Color Temperature: ${{ inputs.image-color-temperature }}"
        
        MUSIC_DATA="Atmosphere: ${{ inputs.music-atmosphere }}
        Energy: ${{ inputs.music-energy }}"
        
        echo "Image analysis data:"
        echo "$IMAGE_DATA"
        echo ""
        echo "Music analysis data:"
        echo "$MUSIC_DATA"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯è¤‡æ•°ã®ä¸–ç•Œè¦³åˆ†æžã‚’çµ±åˆã—ã¦ã€æœ€é©ãª3Dãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ä½“é¨“è¨­å®šã‚’æ±ºå®šã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚

        **çµ±åˆå¯¾è±¡ãƒ‡ãƒ¼ã‚¿**:

        **ç”»åƒåˆ†æžçµæžœ**:
        $IMAGE_DATA

        **éŸ³æ¥½åˆ†æžçµæžœ** (åˆ©ç”¨å¯èƒ½ãªå ´åˆ):
        $MUSIC_DATA

        **çµ±åˆé‡ã¿**: $PRIMARY_WEIGHT (image=ç”»åƒé‡è¦–6:4, music=éŸ³æ¥½é‡è¦–4:6, balanced=å‡ç­‰5:5)

        **çµ±åˆã‚¿ã‚¹ã‚¯**:
        1. **æ·±åº¦ãƒ¢ãƒ¼ãƒ‰æ±ºå®š**: normal/enhanced ã®æœ€çµ‚æ±ºå®š
        2. **é›°å›²æ°—çµ±åˆ**: è¤‡æ•°ã®é›°å›²æ°—ã‚’çµ±åˆã—ãŸæœ€çµ‚çš„ãªä¸–ç•Œè¦³
        3. **æ˜Žåº¦ãƒ¬ãƒ™ãƒ«**: Three.jsã®æ˜Žåº¦è¨­å®š (0.3-1.2) ã‚’æ±ºå®š
        4. **å›žè»¢é€Ÿåº¦**: è‡ªå‹•å›žè»¢é€Ÿåº¦ (0.1-2.0) ã‚’æ±ºå®š  
        5. **ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ´»æ€§åº¦**: ãƒžã‚¦ã‚¹é‡åŠ›ç­‰ã®åå¿œåº¦ (0.1-1.0) ã‚’æ±ºå®š
        6. **è‡ªå‹•å›žè»¢**: æœ‰åŠ¹/ç„¡åŠ¹ã®æ±ºå®š

        **çµ±åˆãƒ«ãƒ¼ãƒ«**:
        - **depth-mode**: dynamic/dramatic â†’ enhanced, static â†’ normal
        - **brightness-level**: 
          * peaceful/soft â†’ 0.8-1.0 (æ˜Žã‚‹ã‚)
          * dramatic/mysterious â†’ 0.4-0.6 (æš—ã‚)
          * energetic â†’ 1.0-1.2 (æœ€å¤§æ˜Žåº¦)
        - **rotation-speed**:
          * peaceful â†’ 0.2-0.5 (ã‚†ã£ãã‚Š)
          * energetic â†’ 0.8-1.5 (é€Ÿã‚)
          * dramatic â†’ 0.1-0.3 (éžå¸¸ã«ã‚†ã£ãã‚Š)
        - **particle-energy**:
          * movement-energy 1-3 â†’ 0.2-0.4
          * movement-energy 4-6 â†’ 0.4-0.7  
          * movement-energy 7-10 â†’ 0.7-1.0
        - **auto-rotate**: 
          * static scenes â†’ true (è‡ªå‹•å›žè»¢ã§å¤‰åŒ–ã‚’ã¤ã‘ã‚‹)
          * dynamic scenes â†’ false (æ‰‹å‹•ã§æŽ¢ç´¢)

        **å¿…é ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**:
        1. **$SYNTHESIS_DIR/world-synthesis.json** - æœ€çµ‚è¨­å®šã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
        2. **$SYNTHESIS_DIR/world-synthesis.md** - çµ±åˆéŽç¨‹ã®è©³ç´°è§£èª¬
        3. **$SYNTHESIS_DIR/final-settings.txt** - è¨­å®šå€¤ã®ã¿ (1è¡Œå½¢å¼)

        **JSONãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¾‹**:
        \`\`\`json
        {
          \"depth_mode\": \"enhanced\",
          \"atmosphere\": \"mysterious_peaceful\",
          \"brightness_level\": 0.7,
          \"rotation_speed\": 0.3,
          \"particle_energy\": 0.5,
          \"auto_rotate\": true,
          \"synthesis_confidence\": 0.9,
          \"primary_influence\": \"image\",
          \"reasoning\": \"Image analysis shows dramatic cave scene, music adds peaceful undertones\"
        }
        \`\`\`

        **é‡è¦ãªæ³¨æ„ç‚¹**:
        1. æ•°å€¤ã¯å¿…ãšæŒ‡å®šç¯„å›²å†…ã§è¨­å®šã—ã¦ãã ã•ã„
        2. çµ±åˆéŽç¨‹ã®è«–ç†çš„æ ¹æ‹ ã‚’æ˜Žç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„
        3. ç›¸åã™ã‚‹è¦ç´ ãŒã‚ã‚‹å ´åˆã¯ã€primary-weight ã«å¾“ã£ã¦èª¿æ•´ã—ã¦ãã ã•ã„
        4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
        
        echo "ðŸš€ Starting World Synthesis Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 15 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸçµ±åˆçµæžœã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated synthesis files..."
        
        # JSONçµ±åˆçµæžœã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
        if [ -f "$SYNTHESIS_DIR/world-synthesis.json" ]; then
          echo "::notice::âœ… World synthesis JSON generated"
          
          # JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          DEPTH_MODE=$(grep -o '"depth_mode"[[:space:]]*:[[:space:]]*"[^"]*"' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d'"' -f4)
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d'"' -f4)
          BRIGHTNESS_LEVEL=$(grep -o '"brightness_level"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          ROTATION_SPEED=$(grep -o '"rotation_speed"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          PARTICLE_ENERGY=$(grep -o '"particle_energy"[[:space:]]*:[[:space:]]*[0-9.]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          AUTO_ROTATE=$(grep -o '"auto_rotate"[[:space:]]*:[[:space:]]*[a-z]*' "$SYNTHESIS_DIR/world-synthesis.json" | cut -d':' -f2 | tr -d ' ')
          
          echo "Final depth mode: $DEPTH_MODE"
          echo "Final atmosphere: $ATMOSPHERE"
          echo "Brightness level: $BRIGHTNESS_LEVEL"
          echo "Rotation speed: $ROTATION_SPEED"
          echo "Particle energy: $PARTICLE_ENERGY"
          echo "Auto rotate: $AUTO_ROTATE"
          
          # GitHub Outputã«è¨­å®š
          echo "depth-mode=$DEPTH_MODE" >> $GITHUB_OUTPUT
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "brightness-level=${BRIGHTNESS_LEVEL:-0.8}" >> $GITHUB_OUTPUT
          echo "rotation-speed=${ROTATION_SPEED:-0.5}" >> $GITHUB_OUTPUT
          echo "particle-energy=${PARTICLE_ENERGY:-0.3}" >> $GITHUB_OUTPUT
          echo "auto-rotate=${AUTO_ROTATE:-true}" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ World synthesis JSON file not found"
          exit 1
        fi
        
        # çµ±åˆæ–‡æ›¸ã®ç¢ºèª
        if [ -f "$SYNTHESIS_DIR/world-synthesis.md" ]; then
          echo "::notice::âœ… Synthesis document generated"
          echo "First 10 lines of synthesis:"
          head -10 "$SYNTHESIS_DIR/world-synthesis.md"
        else
          echo "::warning::âš ï¸ Synthesis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push synthesis
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No synthesis files to commit"
        else
          git commit -m "Add world synthesis results"
          git push origin ${{ inputs.branch-name }}
        fi