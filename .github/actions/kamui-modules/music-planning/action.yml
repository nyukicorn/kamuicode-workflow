name: 'Music Video Planning'
description: 'Plan music video creation strategy using Claude Code SDK'
author: 'KamuiCode Workflow'

inputs:
  music-concept:
    description: 'The music concept to plan for'
    required: true
  folder-name:
    description: 'The folder name for storing planning files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  planning-completed:
    description: 'Whether planning was completed successfully'
    value: ${{ steps.planning.outputs.completed }}
  music-prompt:
    description: 'Generated music prompt'
    value: ${{ steps.planning.outputs.music-prompt }}
  image-prompt:
    description: 'Generated image prompt'
    value: ${{ steps.planning.outputs.image-prompt }}
  video-concept:
    description: 'Generated video concept'
    value: ${{ steps.planning.outputs.video-concept }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: planning
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽµ Music Video Planning Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        MUSIC_CONCEPT="${{ inputs.music-concept }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        PLANNING_DIR="$FOLDER_NAME/planning"
        
        echo "Music concept: $MUSIC_CONCEPT"
        echo "Planning folder: $PLANNING_DIR"
        
        # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$PLANNING_DIR" ]; then
          mkdir -p "$PLANNING_DIR"
          echo "ðŸ“ Created planning folder: $PLANNING_DIR"
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯éŸ³æ¥½ä¸»å°Žã®ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªåˆ¶ä½œã®æˆ¦ç•¥çš„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚5ç§’Ã—3ã¤ã®å‹•ç”»ã‚’30-40ç§’ã®éŸ³æ¥½ã«æœ€é©åŒ–ã™ã‚‹æˆ¦ç•¥ã‚’ä¸­å¿ƒã¨ã—ãŸè©³ç´°ãªåˆ¶ä½œè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

        **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
        **é‡è¦åˆ¶ç´„**: å‹•ç”»ã¯5ç§’Ã—3ã¤ã®ã¿ã€éŸ³æ¥½ã¯30-40ç§’

        **æˆ¦ç•¥çš„ã‚¿ã‚¹ã‚¯**:
        1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’åˆ†æžã—ã€Google Lyriaã§ç”Ÿæˆã™ã¹ãéŸ³æ¥½ã®è©³ç´°ãªè¨­å®šã‚’è¨ˆç”»
        2. **ç·¨é›†æˆ¦ç•¥ã®ç­–å®š**: 5ç§’Ã—3å‹•ç”»ã‚’30-40ç§’éŸ³æ¥½ã«æœ€é©åŒ–ã™ã‚‹å…·ä½“çš„æˆ¦ç•¥
        3. **å‹•ç”»å½¹å‰²åˆ†æž**: 3ã¤ã®å‹•ç”»ã®æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®šç¾©
        4. **ä½¿ç”¨é »åº¦è¨ˆç”»**: å„å‹•ç”»ã®éŸ³æ¥½å†…ã§ã®ä½¿ç”¨é »åº¦ãƒ»é…ç½®æˆ¦ç•¥ã‚’è¨­è¨ˆ
        5. ç·¨é›†æˆ¦ç•¥ã«åŸºã¥ã„ãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        6. ãƒ«ãƒ¼ãƒ—ãƒ»é€Ÿåº¦èª¿æ•´ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è€ƒæ…®ã—ãŸå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’å®šç¾©
        7. æˆ¦ç•¥çš„åˆ¶ä½œè¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/music-video-strategy.mdã€ã«ä¿å­˜
        8. éŸ³æ¥½ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜
        9. æˆ¦ç•¥çš„ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/image-prompt.txtã€ã«ä¿å­˜
        10. ç·¨é›†æœ€é©åŒ–å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/video-strategy.txtã€ã«ä¿å­˜

        **éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
        - Google Lyriaã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªéŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        - **é‡è¦**: å…ƒã®éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã§æŒ‡å®šã•ã‚ŒãŸæ¥½å™¨ã¯å¿…ãšä¿æŒã—å¤‰æ›´ã—ãªã„ã“ã¨
        - æ¥½å™¨ã€ãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ„Ÿæƒ…ã‚’æ˜Žç¢ºã«æŒ‡å®šï¼ˆæ¥½å™¨æŒ‡å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’æœ€å„ªå…ˆï¼‰
        - ã‚¸ãƒ£ãƒ³ãƒ«ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…·ä½“çš„ã«è¨˜è¿°
        - ã€ŒçŸ­ã„ã€ã€Œã‚·ãƒ§ãƒ¼ãƒˆã€ã€Œã‚¤ãƒ³ãƒˆãƒ­ã€ç­‰ã®çŸ­æ™‚é–“ã‚’æ„å›³ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€
        - æ¥½å™¨ç½®æ›ã‚„æ¥½å™¨å¤‰æ›´ã¯è¡Œã‚ãšã€æŒ‡å®šã•ã‚ŒãŸæ¥½å™¨ã§ã®è¡¨ç¾ã‚’å„ªå…ˆã™ã‚‹ã“ã¨
        - æ³¨æ„ï¼šGoogle Lyriaã¯é€šå¸¸30-40ç§’ã®éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¾ã™

        **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
        - éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹è¦–è¦šçš„è¡¨ç¾
        - Imagen4 Fastã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        - éŸ³æ¥½ã®é›°å›²æ°—ã‚’è¦–è¦šçš„ã«è¡¨ç¾ã™ã‚‹è‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«
        - 50-80èªžç¨‹åº¦ã®é©åˆ‡ãªé•·ã•

        **æˆ¦ç•¥çš„å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¦ä»¶**:
        - **åˆ¶ç´„èªè­˜**: 5ç§’Ã—3å‹•ç”»ã§30-40ç§’éŸ³æ¥½ã‚’ã‚«ãƒãƒ¼ã™ã‚‹æˆ¦ç•¥çš„è¨­è¨ˆ
        - **å½¹å‰²åˆ†æ‹…æˆ¦ç•¥**:
          * å‹•ç”»1ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰: éŸ³æ¥½ã®50-60%ã§ä½¿ç”¨ã€åŸºæœ¬çš„ãªé›°å›²æ°—ãƒ»ãƒ†ãƒ¼ãƒžè¡¨ç¾
          * å‹•ç”»2ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰: éŸ³æ¥½ã®20-30%ã§ä½¿ç”¨ã€ã‚¯ãƒ©ã‚¤ãƒžãƒƒã‚¯ã‚¹ãƒ»è»¢æ›ç‚¹
          * å‹•ç”»3ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰: éŸ³æ¥½ã®10-20%ã§ä½¿ç”¨ã€ã¤ãªãŽãƒ»å¤‰åŒ–æ¼”å‡º
        - **ç·¨é›†æœ€é©åŒ–è¨­è¨ˆ**:
          * ãƒ«ãƒ¼ãƒ—è€æ€§: å§‹ç‚¹ãƒ»çµ‚ç‚¹ãŒè‡ªç„¶ã«é€£ç¶šã™ã‚‹æ§‹æˆ
          * é€Ÿåº¦å¯å¤‰æ€§: 0.5-2å€é€Ÿå¯¾å¿œå¯èƒ½ãªå‹•ãè¨­è¨ˆ
          * ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé©å¿œ: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³è¿½åŠ å‰æ
        - **æˆ¦ç•¥çš„é…ç½®è¨ˆç”»**:
          * éŸ³æ¥½æ§‹é€ åˆ†æžã«åŸºã¥ãå„å‹•ç”»ã®æœ€é©é…ç½®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
          * ãƒ“ãƒ¼ãƒˆãƒ»ãƒ†ãƒ³ãƒã«åˆã‚ã›ãŸä½¿ç”¨é »åº¦ãƒ»é€Ÿåº¦èª¿æ•´è¨ˆç”»
          * æ„Ÿæƒ…å¤‰åŒ–ã«å¯¾å¿œã—ãŸå‹•ç”»åˆ‡ã‚Šæ›¿ãˆæˆ¦ç•¥
        - **æŠ€è¡“è¦ä»¶**: Hailuo-02 Proæœ€é©åŒ–ï¼ˆ5ç§’åˆ¶é™å†…ã§æœ€å¤§åŠ¹æžœï¼‰

        **é‡è¦**: 
        1. å¿…ãšä»¥ä¸‹ã®7ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
           - $PLANNING_DIR/music-video-strategy.mdï¼ˆæˆ¦ç•¥çš„åˆ¶ä½œè¨ˆç”»ï¼‰
           - $PLANNING_DIR/music-prompt.txt
           - $PLANNING_DIR/music-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
           - $PLANNING_DIR/image-prompt.txtï¼ˆç·¨é›†æˆ¦ç•¥å¯¾å¿œï¼‰
           - $PLANNING_DIR/image-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
           - $PLANNING_DIR/video-strategy.txtï¼ˆç·¨é›†æœ€é©åŒ–ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰
           - $PLANNING_DIR/video-strategy.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
        2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€mdãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨
        3. éŸ³æ¥½â†’ç”»åƒâ†’å‹•ç”»ã®ä¸€è²«ã—ãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ç¶­æŒ
        4. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
        5. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
        
        echo "ðŸš€ Starting Music Video Planning Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œï¼ˆBashãƒ„ãƒ¼ãƒ«è¿½åŠ ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå¯èƒ½ã«ï¼‰
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 25 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated planning files..."
        
        # éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
        if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
          MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt" | tr '\n' ' ')
          echo "::notice::âœ… Music prompt generated"
          echo "Music prompt: $MUSIC_PROMPT"
          echo "music-prompt=$MUSIC_PROMPT" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Music prompt file not found"
          exit 1
        fi
        
        # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
        if [ -f "$PLANNING_DIR/image-prompt.txt" ]; then
          IMAGE_PROMPT=$(cat "$PLANNING_DIR/image-prompt.txt" | tr '\n' ' ')
          echo "::notice::âœ… Image prompt generated"
          echo "Image prompt: $IMAGE_PROMPT"
          echo "image-prompt=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Image prompt file not found"
          exit 1
        fi
        
        # å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
        if [ -f "$PLANNING_DIR/video-strategy.txt" ]; then
          VIDEO_CONCEPT=$(head -5 "$PLANNING_DIR/video-strategy.txt" | tr '\n' ' ')
          echo "::notice::âœ… Video concept generated"
          echo "Video concept: $VIDEO_CONCEPT"
          echo "video-concept=$VIDEO_CONCEPT" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Video concept file not found"
          exit 1
        fi
        
        # è¨ˆç”»æ›¸ã®ç¢ºèª
        if [ -f "$PLANNING_DIR/music-video-strategy.md" ]; then
          echo "::notice::âœ… Music video plan document generated"
          echo "First 10 lines of plan:"
          head -10 "$PLANNING_DIR/music-video-strategy.md"
        else
          echo "::warning::âš ï¸ Music video plan document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push planning
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No planning files to commit"
        else
          git commit -m "Add music video planning for: ${{ inputs.music-concept }}"
          git push origin ${{ inputs.branch-name }}
        fi