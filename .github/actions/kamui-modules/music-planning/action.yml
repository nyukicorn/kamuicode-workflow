name: 'Music Video Planning'
description: 'Plan music video creation strategy using Claude Code SDK'
author: 'KamuiCode Workflow'

inputs:
  music-concept:
    description: 'The music concept to plan for'
    required: true
  folder-name:
    description: 'The folder name for storing planning files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  planning-completed:
    description: 'Whether planning was completed successfully'
    value: ${{ steps.planning.outputs.completed }}
  music-prompt:
    description: 'Generated music prompt'
    value: ${{ steps.planning.outputs.music-prompt }}
  image-prompt:
    description: 'Generated image prompt'
    value: ${{ steps.planning.outputs.image-prompt }}
  video-concept:
    description: 'Generated video concept'
    value: ${{ steps.planning.outputs.video-concept }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: „Éü„É•„Éº„Ç∏„ÉÉ„ÇØ„Éì„Éá„Ç™Ë®àÁîª„Ç®„Éº„Ç∏„Çß„É≥„Éà
      id: planning
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::üéµ Music Video Planning Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # Ë®≠ÂÆö
        MUSIC_CONCEPT="${{ inputs.music-concept }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        PLANNING_DIR="$FOLDER_NAME/planning"
        
        echo "Music concept: $MUSIC_CONCEPT"
        echo "Planning folder: $PLANNING_DIR"
        
        # Ë®àÁîª„Éï„Ç©„É´„ÉÄ„Çí‰∫ãÂâç„Å´‰ΩúÊàê
        if [ ! -d "$PLANNING_DIR" ]; then
          mkdir -p "$PLANNING_DIR"
          echo "üìÅ Created planning folder: $PLANNING_DIR"
        fi
        
        # „Éó„É≠„É≥„Éó„Éà„ÅÆÊßãÁØâ
        PROMPT="„ÅÇ„Å™„Åü„ÅØÈü≥Ê•Ω‰∏ªÂ∞é„ÅÆ„Éü„É•„Éº„Ç∏„ÉÉ„ÇØ„Éì„Éá„Ç™Âà∂‰Ωú„ÅÆÊà¶Áï•ÁöÑ„Éó„É©„É≥„Éä„Éº„Åß„Åô„ÄÇ5Áßí√ó3„Å§„ÅÆÂãïÁîª„Çí30-40Áßí„ÅÆÈü≥Ê•Ω„Å´ÊúÄÈÅ©Âåñ„Åô„ÇãÊà¶Áï•„Çí‰∏≠ÂøÉ„Å®„Åó„ÅüË©≥Á¥∞„Å™Âà∂‰ΩúË®àÁîª„ÇíÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

        **Èü≥Ê•Ω„Ç≥„É≥„Çª„Éó„Éà**: $MUSIC_CONCEPT
        **ÈáçË¶ÅÂà∂Á¥Ñ**: ÂãïÁîª„ÅØ5Áßí√ó3„Å§„ÅÆ„Åø„ÄÅÈü≥Ê•Ω„ÅØ30-40Áßí

        **Êà¶Áï•ÁöÑ„Çø„Çπ„ÇØ**:
        1. Èü≥Ê•Ω„Ç≥„É≥„Çª„Éó„Éà„ÇíÂàÜÊûê„Åó„ÄÅGoogle Lyria„ÅßÁîüÊàê„Åô„Åπ„ÅçÈü≥Ê•Ω„ÅÆË©≥Á¥∞„Å™Ë®≠ÂÆö„ÇíË®àÁîª
        2. **Á∑®ÈõÜÊà¶Áï•„ÅÆÁ≠ñÂÆö**: 5Áßí√ó3ÂãïÁîª„Çí30-40ÁßíÈü≥Ê•Ω„Å´ÊúÄÈÅ©Âåñ„Åô„ÇãÂÖ∑‰ΩìÁöÑÊà¶Áï•
        3. **ÂãïÁîªÂΩπÂâ≤ÂàÜÊûê**: 3„Å§„ÅÆÂãïÁîª„ÅÆÊà¶Áï•ÁöÑÂΩπÂâ≤Ôºà„É°„Ç§„É≥„ÄÅ„Ç¢„ÇØ„Çª„É≥„Éà„ÄÅ„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥Ôºâ„ÇíÂÆöÁæ©
        4. **‰ΩøÁî®È†ªÂ∫¶Ë®àÁîª**: ÂêÑÂãïÁîª„ÅÆÈü≥Ê•ΩÂÜÖ„Åß„ÅÆ‰ΩøÁî®È†ªÂ∫¶„ÉªÈÖçÁΩÆÊà¶Áï•„ÇíË®≠Ë®à
        5. Á∑®ÈõÜÊà¶Áï•„Å´Âü∫„Å•„ÅÑ„ÅüÁîªÂÉèÁîüÊàê„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
        6. „É´„Éº„Éó„ÉªÈÄüÂ∫¶Ë™øÊï¥„Éª„Ç®„Éï„Çß„ÇØ„Éà„ÇíËÄÉÊÖÆ„Åó„ÅüÂãïÁîª„Ç≥„É≥„Çª„Éó„Éà„ÇíÂÆöÁæ©
        7. Êà¶Áï•ÁöÑÂà∂‰ΩúË®àÁîªÊõ∏„Çí„Äå$PLANNING_DIR/music-video-strategy.md„Äç„Å´‰øùÂ≠ò
        8. Èü≥Ê•ΩÁîüÊàêÁî®„Éó„É≠„É≥„Éó„Éà„Çí„Äå$PLANNING_DIR/music-prompt.txt„Äç„Å´‰øùÂ≠ò
        9. Êà¶Áï•ÁöÑÁîªÂÉè„Éó„É≠„É≥„Éó„Éà„Çí„Äå$PLANNING_DIR/image-prompt.txt„Äç„Å´‰øùÂ≠ò
        10. Á∑®ÈõÜÊúÄÈÅ©ÂåñÂãïÁîª„Ç≥„É≥„Çª„Éó„Éà„Çí„Äå$PLANNING_DIR/video-strategy.txt„Äç„Å´‰øùÂ≠ò

        **Èü≥Ê•ΩÁîüÊàê„Éó„É≠„É≥„Éó„Éà„ÅÆË¶Å‰ª∂**:
        - Google Lyria„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË©≥Á¥∞„Å™Èü≥Ê•Ω„Éó„É≠„É≥„Éó„Éà
        - Ê•ΩÂô®„ÄÅ„ÉÜ„É≥„Éù„ÄÅÈõ∞Âõ≤Ê∞ó„ÄÅÊÑüÊÉÖ„ÇíÊòéÁ¢∫„Å´ÊåáÂÆö
        - „Ç∏„É£„É≥„É´„Å®„Çπ„Çø„Ç§„É´„ÇíÂÖ∑‰ΩìÁöÑ„Å´Ë®òËø∞
        - „ÄåÁü≠„ÅÑ„Äç„Äå„Ç∑„Éß„Éº„Éà„Äç„Äå„Ç§„É≥„Éà„É≠„ÄçÁ≠â„ÅÆÁü≠ÊôÇÈñì„ÇíÊÑèÂõ≥„Åô„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂê´„ÇÄ
        - Ê≥®ÊÑèÔºöGoogle Lyria„ÅØÈÄöÂ∏∏30-40Áßí„ÅÆÈü≥Ê•Ω„ÇíÁîüÊàê„Åó„Åæ„Åô

        **ÁîªÂÉèÁîüÊàê„Éó„É≠„É≥„Éó„Éà„ÅÆË¶Å‰ª∂**:
        - Èü≥Ê•Ω„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„Å®ÂÆåÂÖ®„Å´‰∏ÄËá¥„Åô„ÇãË¶ñË¶öÁöÑË°®Áèæ
        - Imagen4 Fast„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË©≥Á¥∞„Å™„Éó„É≠„É≥„Éó„Éà
        - Èü≥Ê•Ω„ÅÆÈõ∞Âõ≤Ê∞ó„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Áèæ„Åô„ÇãËâ≤ÂΩ©„ÄÅÊßãÂõ≥„ÄÅ„Çπ„Çø„Ç§„É´
        - 50-80Ë™ûÁ®ãÂ∫¶„ÅÆÈÅ©Âàá„Å™Èï∑„Åï

        **Êà¶Áï•ÁöÑÂãïÁîª„Ç≥„É≥„Çª„Éó„Éà„ÅÆË¶Å‰ª∂**:
        - **Âà∂Á¥ÑË™çË≠ò**: 5Áßí√ó3ÂãïÁîª„Åß30-40ÁßíÈü≥Ê•Ω„Çí„Ç´„Éê„Éº„Åô„ÇãÊà¶Áï•ÁöÑË®≠Ë®à
        - **ÂΩπÂâ≤ÂàÜÊãÖÊà¶Áï•**:
          * ÂãïÁîª1Ôºà„É°„Ç§„É≥Ôºâ: Èü≥Ê•Ω„ÅÆ50-60%„Åß‰ΩøÁî®„ÄÅÂü∫Êú¨ÁöÑ„Å™Èõ∞Âõ≤Ê∞ó„Éª„ÉÜ„Éº„ÉûË°®Áèæ
          * ÂãïÁîª2Ôºà„Ç¢„ÇØ„Çª„É≥„ÉàÔºâ: Èü≥Ê•Ω„ÅÆ20-30%„Åß‰ΩøÁî®„ÄÅ„ÇØ„É©„Ç§„Éû„ÉÉ„ÇØ„Çπ„ÉªËª¢ÊèõÁÇπ
          * ÂãïÁîª3Ôºà„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥Ôºâ: Èü≥Ê•Ω„ÅÆ10-20%„Åß‰ΩøÁî®„ÄÅ„Å§„Å™„Åé„ÉªÂ§âÂåñÊºîÂá∫
        - **Á∑®ÈõÜÊúÄÈÅ©ÂåñË®≠Ë®à**:
          * „É´„Éº„ÉóËÄêÊÄß: ÂßãÁÇπ„ÉªÁµÇÁÇπ„ÅåËá™ÁÑ∂„Å´ÈÄ£Á∂ö„Åô„ÇãÊßãÊàê
          * ÈÄüÂ∫¶ÂèØÂ§âÊÄß: 0.5-2ÂÄçÈÄüÂØæÂøúÂèØËÉΩ„Å™Âãï„ÅçË®≠Ë®à
          * „Ç®„Éï„Çß„ÇØ„ÉàÈÅ©Âøú: „Éï„Ç£„É´„Çø„Éº„Éª„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ËøΩÂä†ÂâçÊèê
        - **Êà¶Áï•ÁöÑÈÖçÁΩÆË®àÁîª**:
          * Èü≥Ê•ΩÊßãÈÄ†ÂàÜÊûê„Å´Âü∫„Å•„ÅèÂêÑÂãïÁîª„ÅÆÊúÄÈÅ©ÈÖçÁΩÆ„Çø„Ç§„Éü„É≥„Ç∞
          * „Éì„Éº„Éà„Éª„ÉÜ„É≥„Éù„Å´Âêà„Çè„Åõ„Åü‰ΩøÁî®È†ªÂ∫¶„ÉªÈÄüÂ∫¶Ë™øÊï¥Ë®àÁîª
          * ÊÑüÊÉÖÂ§âÂåñ„Å´ÂØæÂøú„Åó„ÅüÂãïÁîªÂàá„ÇäÊõø„ÅàÊà¶Áï•
        - **ÊäÄË°ìË¶Å‰ª∂**: Hailuo-02 ProÊúÄÈÅ©ÂåñÔºà5ÁßíÂà∂ÈôêÂÜÖ„ÅßÊúÄÂ§ßÂäπÊûúÔºâ

        **ÈáçË¶Å**: 
        1. ÂøÖ„Åö‰ª•‰∏ã„ÅÆ7„Å§„ÅÆ„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
           - $PLANNING_DIR/music-video-strategy.mdÔºàÊà¶Áï•ÁöÑÂà∂‰ΩúË®àÁîªÔºâ
           - $PLANNING_DIR/music-prompt.txt
           - $PLANNING_DIR/music-prompt.mdÔºà„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™çÁî®Ôºâ
           - $PLANNING_DIR/image-prompt.txtÔºàÁ∑®ÈõÜÊà¶Áï•ÂØæÂøúÔºâ
           - $PLANNING_DIR/image-prompt.mdÔºà„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™çÁî®Ôºâ
           - $PLANNING_DIR/video-strategy.txtÔºàÁ∑®ÈõÜÊúÄÈÅ©Âåñ„Ç≥„É≥„Çª„Éó„ÉàÔºâ
           - $PLANNING_DIR/video-strategy.mdÔºà„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™çÁî®Ôºâ
        2. txt„Éï„Ç°„Ç§„É´„ÅØÊ©üÊ¢∞Âá¶ÁêÜÁî®Ôºà1Ë°å„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÅmd„Éï„Ç°„Ç§„É´„ÅØ„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™çÁî®
        3. Èü≥Ê•Ω‚ÜíÁîªÂÉè‚ÜíÂãïÁîª„ÅÆ‰∏ÄË≤´„Åó„Åü„Ç≥„É≥„Çª„Éó„Éà„ÇíÁ∂≠ÊåÅ
        4. ÂêÑ„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÅØÂÖ∑‰ΩìÁöÑ„ÅßË©≥Á¥∞„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        5. „Éï„Ç°„Ç§„É´‰ΩúÊàêÂæå„ÄÅÂøÖ„Åö„Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÁ¢∫Ë™ç„ÉªÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        
        echo "üöÄ Starting Music Video Planning Agent Claude Code CLI..."
        echo "üìù Prompt length: ${#PROMPT}"
        
        # Claude Code CLI„ÅÆÂÆüË°å
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit" \
          --max-turns 25 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::‚ùå Claude Code CLI execution failed"
            exit 1
          }
        
        # ÁîüÊàê„Åï„Çå„ÅüË®àÁîª„ÅÆÁ¢∫Ë™ç
        echo ""
        echo "üìã Checking generated planning files..."
        
        # Èü≥Ê•Ω„Éó„É≠„É≥„Éó„Éà„ÅÆÁ¢∫Ë™ç
        if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
          MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt" | tr '\n' ' ')
          echo "::notice::‚úÖ Music prompt generated"
          echo "Music prompt: $MUSIC_PROMPT"
          echo "music-prompt=$MUSIC_PROMPT" >> $GITHUB_OUTPUT
        else
          echo "::error::‚ùå Music prompt file not found"
          exit 1
        fi
        
        # ÁîªÂÉè„Éó„É≠„É≥„Éó„Éà„ÅÆÁ¢∫Ë™ç
        if [ -f "$PLANNING_DIR/image-prompt.txt" ]; then
          IMAGE_PROMPT=$(cat "$PLANNING_DIR/image-prompt.txt" | tr '\n' ' ')
          echo "::notice::‚úÖ Image prompt generated"
          echo "Image prompt: $IMAGE_PROMPT"
          echo "image-prompt=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
        else
          echo "::error::‚ùå Image prompt file not found"
          exit 1
        fi
        
        # ÂãïÁîª„Ç≥„É≥„Çª„Éó„Éà„ÅÆÁ¢∫Ë™ç
        if [ -f "$PLANNING_DIR/video-strategy.txt" ]; then
          VIDEO_CONCEPT=$(head -5 "$PLANNING_DIR/video-strategy.txt" | tr '\n' ' ')
          echo "::notice::‚úÖ Video concept generated"
          echo "Video concept: $VIDEO_CONCEPT"
          echo "video-concept=$VIDEO_CONCEPT" >> $GITHUB_OUTPUT
        else
          echo "::error::‚ùå Video concept file not found"
          exit 1
        fi
        
        # Ë®àÁîªÊõ∏„ÅÆÁ¢∫Ë™ç
        if [ -f "$PLANNING_DIR/music-video-strategy.md" ]; then
          echo "::notice::‚úÖ Music video plan document generated"
          echo "First 10 lines of plan:"
          head -10 "$PLANNING_DIR/music-video-strategy.md"
        else
          echo "::warning::‚ö†Ô∏è Music video plan document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit and push planning
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token || github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No planning files to commit"
        else
          git commit -m "Add music video planning for: ${{ inputs.music-concept }}"
          
          # Push with retry
          for i in {1..5}; do
            echo "Push attempt $i/5..."
            if git push; then
              echo "‚úÖ Push successful on attempt $i"
              break
            else
              echo "Push failed on attempt $i"
              if [ $i -eq 5 ]; then
                echo "‚ùå All push attempts failed"
                exit 1
              fi
              sleep $((i * 2))
              git pull --rebase origin ${{ inputs.branch-name }}
            fi
          done
        fi