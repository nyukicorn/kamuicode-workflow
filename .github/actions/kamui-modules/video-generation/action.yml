name: 'Video Generation'
description: 'Generate videos using Hailuo-02 Pro via KamuiCode MCP'
author: 'KamuiCode Workflow'

inputs:
  video-prompt:
    description: 'The video generation prompt'
    required: true
  google-image-url:
    description: 'Google URL of the source image'
    required: true
  folder-name:
    description: 'The folder name for storing video files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true
  mcp-config:
    description: 'MCP configuration JSON'
    required: true
  segment-number:
    description: 'Video segment number (default: 1)'
    required: false
    default: '1'

outputs:
  video-completed:
    description: 'Whether video generation was completed successfully'
    value: ${{ steps.video.outputs.completed }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: å‹•ç”»ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Hailuo-02 Pro)
      id: video
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¬ Video Generation (Hailuo-02 Pro)"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        VIDEO_PROMPT="${{ inputs.video-prompt }}"
        GOOGLE_IMAGE_URL="${{ inputs.google-image-url }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        SEGMENT_NUMBER="${{ inputs.segment-number }}"
        VIDEOS_DIR="$FOLDER_NAME/videos"
        
        echo "Video prompt: $VIDEO_PROMPT"
        echo "Google image URL: $GOOGLE_IMAGE_URL"
        echo "Segment number: $SEGMENT_NUMBER"
        echo "Target folder: $VIDEOS_DIR"
        
        # å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$VIDEOS_DIR" ]; then
          mkdir -p "$VIDEOS_DIR"
          echo "ðŸ“ Created videos folder: $VIDEOS_DIR"
        fi
        
        # MCPè¨­å®šã®ç¢ºèª
        MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
        MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
        
        echo "ðŸ“‹ MCP Configuration Check:"
        echo "Working directory: $(pwd)"
        echo "MCP config path: $MCP_CONFIG_PATH"
        echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
        echo "Allowed tools: mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash"
        
        # Create MCP config file from GitHub Secret
        mkdir -p .claude
        echo '${{ inputs.mcp-config }}' > "$MCP_CONFIG_ABS_PATH"
        echo "âœ… MCP config file created from GitHub Secret"
        
        # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
          echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
          echo "MCP servers configured:"
          jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" || true
        else
          echo "âŒ MCP config file creation failed"
          exit 1
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ$SEGMENT_NUMBER ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
        **Googleç”»åƒURL**: $GOOGLE_IMAGE_URL
        **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $VIDEO_PROMPT
        **å®Ÿè¡Œæ‰‹é †**:
        1. æä¾›ã•ã‚ŒãŸGoogleç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ä½¿ç”¨
        2. å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$VIDEO_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Hailuo-02 Proã§å‹•ç”»ç”Ÿæˆ
        3. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
        4. **å¾…æ©Ÿå‡¦ç†**: Bashãƒ„ãƒ¼ãƒ«ã§ã€Œsleep 120ã€ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦120ç§’å¾…æ©Ÿ
        5. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œcompletedã€ã§ãªã„å ´åˆã€å†åº¦ã€Œsleep 120ã€ã§å¾…æ©Ÿã—ã¦å†ç¢ºèªï¼ˆæœ€å¤§10å›žï¼‰
        7. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_result\`ã§çµæžœå–å¾—
        8. å‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/segment-$SEGMENT_NUMBER.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
        
        **é‡è¦ãªå®Ÿè¡Œæ‰‹é †**:
        1. å‹•ç”»ç”Ÿæˆã‚’submitã§é–‹å§‹
        2. 120ç§’å¾…æ©Ÿï¼ˆsleep 120ï¼‰ã—ã¦ã‹ã‚‰statusã§ç¢ºèª
        3. \"completed\"ã«ãªã‚‹ã¾ã§120ç§’é–“éš”ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚’ç¹°ã‚Šè¿”ã™
        4. å®Œäº†å¾Œã«resultã§å‹•ç”»URLã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        5. å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œ$VIDEOS_DIR/segment-$SEGMENT_NUMBER.mp4ã€ã¨ã—ã¦ä¿å­˜
        
        **æ³¨æ„äº‹é …**:
        - Google URLã¯æœ‰åŠ¹æœŸé™ãŒã‚ã‚‹ãŸã‚ã€å¿…ãšæœ‰åŠ¹ãªURLã‚’ä½¿ç”¨
        - å‹•ç”»ç”Ÿæˆã«ã¯é€šå¸¸3-5åˆ†ã‹ã‹ã‚‹ãŸã‚ã€é©åˆ‡ãªå¾…æ©Ÿæ™‚é–“ã‚’è¨­ã‘ã‚‹
        - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã¯æœ€å¤§10å›žã¾ã§å®Ÿè¡Œ"
        
        echo "ðŸš€ Starting Video Generation Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --mcp-config="$MCP_CONFIG_ABS_PATH" \
          --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
          --max-turns 70 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã®ç¢ºèª
        echo ""
        echo "ðŸŽ¬ Checking generated videos..."
        if [ -d "$VIDEOS_DIR" ]; then
          VIDEO_COUNT=$(find "$VIDEOS_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | wc -l)
          echo "::notice::ðŸŽ¬ Generated $VIDEO_COUNT video files"
          if [ "$VIDEO_COUNT" -gt 0 ]; then
            echo "Video files:"
            SEGMENT_VIDEO=$(find "$VIDEOS_DIR" -name "segment-$SEGMENT_NUMBER.mp4" | head -1)
            if [ -f "$SEGMENT_VIDEO" ]; then
              echo "Segment $SEGMENT_NUMBER video: $SEGMENT_VIDEO"
            else
              echo "::warning::âš ï¸ Segment $SEGMENT_NUMBER video not found, checking all videos"
              find "$VIDEOS_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi"
            fi
          else
            echo "::error::âŒ No video files were generated"
            exit 1
          fi
        else
          echo "::error::âŒ Videos directory not found"
          exit 1
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit and push video
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No video files to commit"
        else
          git commit -m "Add video segment ${{ inputs.segment-number }}: ${{ inputs.video-prompt }}"
          git push origin ${{ inputs.branch-name }}
        fi