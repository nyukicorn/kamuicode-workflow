name: 'Three.js Scene Generation'
description: 'Generate Three.js 3D scenes with panorama and particles using Three.js MCP'
author: 'KamuiCode Workflow'

inputs:
  experience-concept:
    description: 'The 3D experience concept'
    required: true
  panorama-image-url:
    description: 'Google URL of the panorama image'
    required: true
  include-music:
    description: 'Whether to include music controls'
    required: false
    default: 'false'
  music-url:
    description: 'Google URL of the background music (if applicable)'
    required: false
  folder-name:
    description: 'The folder name for storing Three.js files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  threejs-completed:
    description: 'Whether Three.js scene generation was completed successfully'
    value: ${{ steps.threejs.outputs.completed }}
  scene-files-created:
    description: 'Number of scene files created'
    value: ${{ steps.threejs.outputs.scene-files-created }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: Three.js Scene Generation Agent
      id: threejs
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¨ Three.js Scene Generation"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        EXPERIENCE_CONCEPT="${{ inputs.experience-concept }}"
        PANORAMA_URL="${{ inputs.panorama-image-url }}"
        INCLUDE_MUSIC="${{ inputs.include-music }}"
        MUSIC_URL="${{ inputs.music-url }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        SRC_DIR="$FOLDER_NAME/src"
        ASSETS_DIR="$FOLDER_NAME/assets"
        
        echo "Experience concept: $EXPERIENCE_CONCEPT"
        echo "Panorama URL: $PANORAMA_URL"
        echo "Include music: $INCLUDE_MUSIC"
        echo "Target folders: $SRC_DIR, $ASSETS_DIR"
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’äº‹å‰ã«ä½œæˆ
        mkdir -p "$SRC_DIR/js"
        mkdir -p "$SRC_DIR/css"
        mkdir -p "$SRC_DIR/libs"
        mkdir -p "$ASSETS_DIR"
        echo "ðŸ“ Created directory structure"
        
        # Three.js MCPè¨­å®šã®ç¢ºèª
        MCP_CONFIG_PATH=".claude/mcp-threejs.json"
        MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
        
        echo "ðŸ“‹ Three.js MCP Configuration Check:"
        echo "Working directory: $(pwd)"
        echo "MCP config path: $MCP_CONFIG_PATH"
        echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
        
        # Three.js MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if [ ! -f "$MCP_CONFIG_ABS_PATH" ]; then
          echo "Creating Three.js MCP configuration..."
          mkdir -p .claude
          cat > "$MCP_CONFIG_ABS_PATH" << 'EOF'
{
  "mcpServers": {
    "threejs": {
      "type": "http",
      "url": "https://www.pulsemcp.com/servers/locchung-three-js",
      "description": "Three.js MCP Server by Loc Chung for 3D scene manipulation"
    }
  }
}
EOF
          echo "âœ… Three.js MCP config file created"
        else
          echo "âœ… Three.js MCP config file already exists"
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        MUSIC_INTEGRATION=""
        if [ "$INCLUDE_MUSIC" == "true" ] && [ -n "$MUSIC_URL" ]; then
          MUSIC_INTEGRATION="
        **éŸ³æ¥½çµ±åˆ**:
        - BGM URL: $MUSIC_URL
        - éŸ³æ¥½ã®ã‚ªãƒ³/ã‚ªãƒ•ãƒœã‚¿ãƒ³ã‚’å®Ÿè£…
        - Web Audio APIã§ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
        - ãƒœãƒªãƒ¥ãƒ¼ãƒ åˆ¶å¾¡æ©Ÿèƒ½"
        fi
        
        PROMPT="Three.js 3Dä½“é¨“ã‚·ãƒ¼ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
        
        **ä½“é¨“ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $EXPERIENCE_CONCEPT
        **ãƒ‘ãƒŽãƒ©ãƒžç”»åƒURL**: $PANORAMA_URL
        
        **å®Ÿè¡Œæ‰‹é †**:
        1. ãƒ‘ãƒŽãƒ©ãƒžç”»åƒã‚’$ASSETS_DIR/panorama.jpgã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
        2. Three.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’$SRC_DIR/libsã«é…ç½®
        3. ãƒ¡ã‚¤ãƒ³HTMLãƒ•ã‚¡ã‚¤ãƒ«($SRC_DIR/index.html)ã‚’ä½œæˆ:
           - Three.js WebGLRendererè¨­å®š
           - ãƒ‘ãƒŽãƒ©ãƒžç”»åƒã‚’SphereGeometryã«ãƒžãƒƒãƒ”ãƒ³ã‚°
           - OrbitControlsã§ãƒžã‚¦ã‚¹æ“ä½œ
           - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
           - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
        4. JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ:
           - $SRC_DIR/js/main.js: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
           - $SRC_DIR/js/scene.js: 3Dã‚·ãƒ¼ãƒ³è¨­å®š
           - $SRC_DIR/js/particles.js: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¢ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
           - $SRC_DIR/js/controls.js: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œåˆ¶å¾¡
        5. CSSãƒ•ã‚¡ã‚¤ãƒ«($SRC_DIR/css/style.css)ã‚’ä½œæˆ:
           - ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º
           - UIåˆ¶å¾¡ãƒ‘ãƒãƒ«
           - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
        $MUSIC_INTEGRATION
        
        **æŠ€è¡“ä»•æ§˜**:
        - ãƒ‘ãƒŽãƒ©ãƒž: Equirectangular â†’ SphereGeometryå†…å´ãƒ†ã‚¯ã‚¹ãƒãƒ£
        - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«: Points/ParticleSystemã§ã€Œ$EXPERIENCE_CONCEPTã€ãƒ†ãƒ¼ãƒž
        - æ“ä½œ: ãƒžã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚«ãƒ¡ãƒ©å›žè»¢ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
        - æœ€é©åŒ–: requestAnimationFrameã€é©åˆ‡ãªãƒ‡ã‚£ã‚¹ãƒãƒ¼ã‚º
        
        **é‡è¦ãªæ³¨æ„ç‚¹**:
        - ãƒ‘ãƒŽãƒ©ãƒžç”»åƒã¯Google URLã‹ã‚‰ç¢ºå®Ÿã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        - Three.jsã¯CDNç‰ˆã‚’ä½¿ç”¨ï¼ˆæœ€æ–°å®‰å®šç‰ˆï¼‰
        - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«é…ç½®
        - WebGLå¯¾å¿œãƒã‚§ãƒƒã‚¯ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
        - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ã‚¿ãƒƒãƒæ“ä½œ
        
        **ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ **:
        $SRC_DIR/
        â”œâ”€â”€ index.html
        â”œâ”€â”€ js/
        â”‚   â”œâ”€â”€ main.js
        â”‚   â”œâ”€â”€ scene.js  
        â”‚   â”œâ”€â”€ particles.js
        â”‚   â””â”€â”€ controls.js
        â”œâ”€â”€ css/
        â”‚   â””â”€â”€ style.css
        â””â”€â”€ libs/
            â””â”€â”€ three.min.js
        $ASSETS_DIR/
        â””â”€â”€ panorama.jpg"
        
        echo "ðŸš€ Starting Three.js Scene Generation Agent..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --mcp-config="$MCP_CONFIG_ABS_PATH" \
          --allowedTools "Bash" \
          --max-turns 30 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        echo ""
        echo "ðŸ“¸ Checking generated Three.js files..."
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$SRC_DIR/index.html" ]; then
          echo "âœ… Main HTML file created: $SRC_DIR/index.html"
        else
          echo "::error::âŒ Main HTML file not found"
          exit 1
        fi
        
        # JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        JS_COUNT=$(find "$SRC_DIR/js" -name "*.js" 2>/dev/null | wc -l)
        echo "âœ… JavaScript files created: $JS_COUNT"
        
        # CSSãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$SRC_DIR/css/style.css" ]; then
          echo "âœ… CSS file created: $SRC_DIR/css/style.css"
        else
          echo "::warning::âš ï¸ CSS file not found"
        fi
        
        # ãƒ‘ãƒŽãƒ©ãƒžç”»åƒã®ç¢ºèª
        if [ -f "$ASSETS_DIR/panorama.jpg" ]; then
          echo "âœ… Panorama image downloaded: $ASSETS_DIR/panorama.jpg"
        else
          echo "::warning::âš ï¸ Panorama image not found"
        fi
        
        # ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        TOTAL_FILES=$(find "$SRC_DIR" -type f | wc -l)
        echo "scene-files-created=$TOTAL_FILES" >> $GITHUB_OUTPUT
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Commit and push Three.js files
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No Three.js files to commit"
        else
          git commit -m "Add Three.js scene: ${{ inputs.experience-concept }}"
          git push origin ${{ inputs.branch-name }}
        fi