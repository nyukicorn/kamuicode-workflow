name: 'Three.js Integration & Packaging'
description: 'Integrate and package Three.js experience for distribution'
author: 'KamuiCode Workflow'

inputs:
  experience-concept:
    description: 'The 3D experience concept'
    required: true
  include-music:
    description: 'Whether music was included'
    required: false
    default: 'false'
  folder-name:
    description: 'The folder name containing Three.js files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  integration-completed:
    description: 'Whether integration was completed successfully'
    value: ${{ steps.integration.outputs.completed }}
  final-package-path:
    description: 'Path to the final package'
    value: ${{ steps.integration.outputs.final-package-path }}
  package-size:
    description: 'Size of the final package'
    value: ${{ steps.integration.outputs.package-size }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: Three.js Integration & Packaging Agent
      id: integration
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ğŸ“¦ Three.js Integration & Packaging"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        EXPERIENCE_CONCEPT="${{ inputs.experience-concept }}"
        INCLUDE_MUSIC="${{ inputs.include-music }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        SRC_DIR="$FOLDER_NAME/src"
        ASSETS_DIR="$FOLDER_NAME/assets"
        FINAL_DIR="$FOLDER_NAME/final"
        
        echo "Experience concept: $EXPERIENCE_CONCEPT"
        echo "Include music: $INCLUDE_MUSIC"
        echo "Source folder: $FOLDER_NAME"
        
        # finalãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p "$FINAL_DIR"
        echo "ğŸ“ Created final directory: $FINAL_DIR"
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ğŸ” Checking generated files..."
        if [ ! -d "$SRC_DIR" ]; then
          echo "::error::âŒ Source directory not found: $SRC_DIR"
          exit 1
        fi
        
        if [ ! -f "$SRC_DIR/index.html" ]; then
          echo "::error::âŒ Main HTML file not found: $SRC_DIR/index.html"
          exit 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ
        HTML_COUNT=$(find "$SRC_DIR" -name "*.html" | wc -l)
        JS_COUNT=$(find "$SRC_DIR" -name "*.js" | wc -l)
        CSS_COUNT=$(find "$SRC_DIR" -name "*.css" | wc -l)
        ASSET_COUNT=$(find "$ASSETS_DIR" -type f 2>/dev/null | wc -l)
        
        echo "ğŸ“Š Generated files summary:"
        echo "  HTML files: $HTML_COUNT"
        echo "  JavaScript files: $JS_COUNT"  
        echo "  CSS files: $CSS_COUNT"
        echo "  Asset files: $ASSET_COUNT"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        MUSIC_INFO=""
        if [ "$INCLUDE_MUSIC" == "true" ]; then
          MUSIC_INFO="- éŸ³æ¥½çµ±åˆæ©Ÿèƒ½ä»˜ãï¼ˆBGMã‚ªãƒ³/ã‚ªãƒ•åˆ¶å¾¡ï¼‰"
        else
          MUSIC_INFO="- éŸ³æ¥½ãªã—ï¼ˆãƒ‘ãƒãƒ©ãƒ+ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ã¿ï¼‰"
        fi
        
        PROMPT="Three.jsä½“é¨“ã®æœ€çµ‚çµ±åˆã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
        
        **ä½“é¨“ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $EXPERIENCE_CONCEPT
        **éŸ³æ¥½çµ±åˆ**: $INCLUDE_MUSIC
        $MUSIC_INFO
        
        **å®Ÿè¡Œæ‰‹é †**:
        1. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªãƒã‚§ãƒƒã‚¯:
           - $SRC_DIR/index.htmlã®æ§‹æ–‡ç¢ºèª
           - JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
           - CSSãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ç¢ºèª
           - ãƒ‘ãƒãƒ©ãƒç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
        
        2. READMEãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ($FOLDER_NAME/README.md):
           - ä½“é¨“ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®èª¬æ˜
           - æ“ä½œæ–¹æ³•ï¼ˆãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒæ“ä½œï¼‰
           - æŠ€è¡“ä»•æ§˜ï¼ˆThree.js, WebGLè¦ä»¶ï¼‰
           - ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ–¹æ³•
           - å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
           - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
        
        3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–:
           - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
           - ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
           - HTMLã®minificationç¢ºèª
        
        4. æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ:
           - $FINAL_DIR/threejs-experience.zipã«å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®
           - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…å®¹ã®ç¢ºèª
           - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è¨˜éŒ²
        
        **å“è³ªãƒã‚§ãƒƒã‚¯é …ç›®**:
        - WebGLå¯¾å¿œãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…ç¢ºèª
        - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®å®Ÿè£…ç¢ºèª
        - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…ç¢ºèª
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®å®Ÿè£…ç¢ºèª
        - ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®ç¢ºèª
        
        **æœ€çµ‚æˆæœç‰©**:
        - å®Œå…¨å‹•ä½œã™ã‚‹Three.jsä½“é¨“
        - è©³ç´°ãªREADMEæ–‡æ›¸
        - é…å¸ƒç”¨zipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
        - å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ
        
        **é‡è¦ãªæ³¨æ„ç‚¹**:
        - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒç›¸å¯¾ãƒ‘ã‚¹ã§æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        - å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã®ç¢ºèªï¼ˆCDNãƒªãƒ³ã‚¯ãªã©ï¼‰
        - ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã®å‹•ä½œç¢ºèªè¦ä»¶ã®è¨˜è¼‰
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ç¢ºèª"
        
        echo "ğŸš€ Starting Integration & Packaging Agent..."
        echo "ğŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Bash" \
          --max-turns 25 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # æœ€çµ‚çµæœã®ç¢ºèª
        echo ""
        echo "ğŸ“¦ Checking final package..."
        
        # READMEãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$FOLDER_NAME/README.md" ]; then
          echo "âœ… README file created: $FOLDER_NAME/README.md"
          README_SIZE=$(wc -c < "$FOLDER_NAME/README.md")
          echo "  README size: $README_SIZE bytes"
        else
          echo "::warning::âš ï¸ README file not found"
        fi
        
        # zipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª
        ZIP_PATH="$FINAL_DIR/threejs-experience.zip"
        if [ -f "$ZIP_PATH" ]; then
          echo "âœ… Final package created: $ZIP_PATH"
          PACKAGE_SIZE=$(wc -c < "$ZIP_PATH")
          PACKAGE_SIZE_MB=$((PACKAGE_SIZE / 1024 / 1024))
          echo "  Package size: $PACKAGE_SIZE bytes ($PACKAGE_SIZE_MB MB)"
          echo "final-package-path=$ZIP_PATH" >> $GITHUB_OUTPUT
          echo "package-size=${PACKAGE_SIZE_MB}MB" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Final package not found"
          exit 1
        fi
        
        # å…¨ä½“ã‚µãƒãƒªãƒ¼
        TOTAL_FILES=$(find "$FOLDER_NAME" -type f | wc -l)
        echo ""
        echo "ğŸ‰ Integration completed successfully!"
        echo "  Total files: $TOTAL_FILES"
        echo "  Final package: $ZIP_PATH"
        echo "  Package size: ${PACKAGE_SIZE_MB}MB"
        
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: Setup docs folder for GitHub Pages
      shell: bash
      run: |
        echo "::group::ğŸ“ Setup docs folder"
        
        FOLDER_NAME="${{ inputs.folder-name }}"
        DOCS_DIR="docs/$FOLDER_NAME"
        
        # docs/ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ä½œæˆ
        mkdir -p "$DOCS_DIR"
        
        # src/index.htmlã‚’docsé…ä¸‹ã«ã‚³ãƒ”ãƒ¼
        if [ -f "$FOLDER_NAME/src/index.html" ]; then
          cp "$FOLDER_NAME/src/index.html" "$DOCS_DIR/"
          echo "âœ… Copied index.html to docs"
        fi
        
        # ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ã‚³ãƒ”ãƒ¼
        if [ -f "$FOLDER_NAME/src/panorama.jpg" ]; then
          cp "$FOLDER_NAME/src/panorama.jpg" "$DOCS_DIR/"
          echo "âœ… Copied panorama.jpg to docs"
        fi
        
        # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -f "$FOLDER_NAME/src/generated-music.wav" ]; then
          cp "$FOLDER_NAME/src/generated-music.wav" "$DOCS_DIR/"
          echo "âœ… Copied music file to docs"
        fi
        
        # GitHub Pagesç”¨ã®index.htmlãŒãªã‘ã‚Œã°ä½œæˆ
        if [ ! -f "docs/index.html" ]; then
          cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>KamuiCode Three.js Experiences</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .experience { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
            .experience h2 { margin-top: 0; }
            .experience a { color: #0066cc; text-decoration: none; }
            .experience a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <h1>ğŸ¯ KamuiCode Three.js Experiences</h1>
          <p>Generated 3D experiences with panorama backgrounds and particle effects.</p>
          <div id="experiences">
            <!-- Experiences will be listed here -->
          </div>
        </body>
        </html>
        EOF
          echo "âœ… Created main docs/index.html"
        fi
        
        echo "::endgroup::"
    
    - name: Commit and push integration files
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ãƒ•ã‚©ãƒ«ãƒ€ã¨docsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
        git add ${{ inputs.folder-name }}/
        git add docs/
        
        if git diff --cached --quiet; then
          echo "No integration files to commit"
        else
          git commit -m "Add final Three.js experience package: ${{ inputs.experience-concept }}"
          git push origin ${{ inputs.branch-name }}
        fi