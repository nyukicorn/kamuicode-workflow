name: 'Music World Analysis'
description: 'Analyze music (prompts/URLs/files) to extract comprehensive world characteristics and temporal emotion curves'
author: 'KamuiCode Workflow'

inputs:
  music-prompt:
    description: 'The music prompt to analyze for world building'
    required: false
  music-url:
    description: 'URL of music to analyze for world characteristics'
    required: false
  music-file:
    description: 'Path to local music file for analysis'
    required: false
  folder-name:
    description: 'The folder name for storing analysis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  analysis-completed:
    description: 'Whether analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  atmosphere:
    description: 'Overall atmosphere (peaceful/energetic/mysterious/etc)'
    value: ${{ steps.analysis.outputs.atmosphere }}
  genre:
    description: 'Musical genre (classical/electronic/ambient/rock/etc)'
    value: ${{ steps.analysis.outputs.genre }}
  instrumentation:
    description: 'Primary instruments (piano/strings/vocals/synth/etc)'
    value: ${{ steps.analysis.outputs.instrumentation }}
  tempo:
    description: 'Tempo classification (slow/moderate/fast/variable)'
    value: ${{ steps.analysis.outputs.tempo }}
  energy:
    description: 'Energy level (1-10 scale)'
    value: ${{ steps.analysis.outputs.energy }}
  mood:
    description: 'Emotional mood (happy/melancholic/dramatic/serene/etc)'
    value: ${{ steps.analysis.outputs.mood }}
  color-temperature:
    description: 'Musical color temperature (warm/cool/neutral)'
    value: ${{ steps.analysis.outputs.color-temperature }}
  acoustic-space:
    description: 'Acoustic space feel (intimate/spacious/vast)'
    value: ${{ steps.analysis.outputs.acoustic-space }}
  complexity-level:
    description: 'Musical complexity (simple/moderate/complex)'
    value: ${{ steps.analysis.outputs.complexity-level }}
  regional-style:
    description: 'Regional style (western/eastern/global/fusion)'
    value: ${{ steps.analysis.outputs.regional-style }}
  era-style:
    description: 'Era style (vintage/contemporary/futuristic)'
    value: ${{ steps.analysis.outputs.era-style }}
  production-quality:
    description: 'Production quality (lo-fi/hi-fi/professional)'
    value: ${{ steps.analysis.outputs.production-quality }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: éŸ³æ¥½ä¸–ç•Œè¦³åˆ†æžã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽµ Music World Analysis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®šã¨å…¥åŠ›å½¢å¼åˆ¤å®š
        MUSIC_PROMPT="${{ inputs.music-prompt }}"
        MUSIC_URL="${{ inputs.music-url }}"
        MUSIC_FILE="${{ inputs.music-file }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        ANALYSIS_DIR="$FOLDER_NAME/world-analysis"
        
        # å…¥åŠ›å½¢å¼ã®åˆ¤å®š
        INPUT_TYPE=""
        INPUT_SOURCE=""
        if [ -n "$MUSIC_PROMPT" ]; then
          INPUT_TYPE="prompt"
          INPUT_SOURCE="$MUSIC_PROMPT"
          echo "Input type: Text prompt"
          echo "Music prompt: $MUSIC_PROMPT"
        elif [ -n "$MUSIC_URL" ]; then
          INPUT_TYPE="url"
          INPUT_SOURCE="$MUSIC_URL"
          echo "Input type: Music URL"
          echo "Music URL: $MUSIC_URL"
        elif [ -n "$MUSIC_FILE" ]; then
          INPUT_TYPE="file"
          INPUT_SOURCE="$MUSIC_FILE"
          echo "Input type: Music file"
          echo "Music file: $MUSIC_FILE"
        else
          echo "::error::âŒ No input provided. Please specify music-prompt, music-url, or music-file"
          exit 1
        fi
        
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # åˆ†æžãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "ðŸ“ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯éŸ³æ¥½ã‹ã‚‰åŒ…æ‹¬çš„ãªä¸–ç•Œè¦³ç‰¹æ€§ã¨æ„Ÿæƒ…ã®æ™‚ç³»åˆ—å¤‰åŒ–ã‚’æŠ½å‡ºã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚å…¥åŠ›å½¢å¼ã«å¿œã˜ã¦é©åˆ‡ã«åˆ†æžã—ã€æ±Žç”¨çš„ãªéŸ³æ¥½ä¸–ç•Œè¦³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

        **å…¥åŠ›æƒ…å ±**:
        - **å…¥åŠ›å½¢å¼**: $INPUT_TYPE ($INPUT_TYPE = prompt/url/file)
        - **åˆ†æžå¯¾è±¡**: $INPUT_SOURCE

        **åŒ…æ‹¬çš„åˆ†æžã‚¿ã‚¹ã‚¯**:
        
        **åŸºæœ¬ä¸–ç•Œè¦³ç‰¹æ€§**:
        1. **é›°å›²æ°—**: peaceful/energetic/mysterious/dramatic/romantic/adventurousç­‰ã‚’ç‰¹å®š
        2. **ã‚¸ãƒ£ãƒ³ãƒ«**: classical/electronic/ambient/rock/jazz/folkç­‰ã‚’åˆ¤å®š
        3. **æ¥½å™¨æ§‹æˆ**: piano/strings/vocals/synth/drums/guitarç­‰ã®ä¸»è¦æ¥½å™¨
        4. **ãƒ†ãƒ³ãƒ**: slow/moderate/fast/variable ã®ãƒ†ãƒ³ãƒåˆ†é¡ž
        5. **ã‚¨ãƒãƒ«ã‚®ãƒ¼**: 1-10ã®ã‚¹ã‚±ãƒ¼ãƒ«ã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¬ãƒ™ãƒ«ã‚’è©•ä¾¡
        6. **ãƒ ãƒ¼ãƒ‰**: happy/melancholic/dramatic/serene/tenseç­‰ã®æ„Ÿæƒ…çš„ãƒ ãƒ¼ãƒ‰
        7. **è‰²æ¸©åº¦**: warm(æš–ã‹ã„)/cool(ã‚¯ãƒ¼ãƒ«)/neutral(ä¸­æ€§)ã®éŸ³è‰²æ¸©åº¦

        **æ–°è¦è¿½åŠ åˆ†æžè¦ç´ **:
        8. **ç©ºé–“ç‰¹æ€§**: 
           - acoustic_space: intimate/spacious/vast (éŸ³éŸ¿ç©ºé–“ã®åºƒãŒã‚Š)
           - reverb_depth: dry/moderate/deep (æ®‹éŸ¿ã®æ·±ã•)
           - distance_feel: close/medium/distant (éŸ³æºã¨ã®è·é›¢æ„Ÿ)
        9. **å‹•çš„ç‰¹æ€§**:
           - complexity_level: simple/moderate/complex (éŸ³æ¥½çš„è¤‡é›‘åº¦)
           - change_rate: gradual/sudden/rhythmic (å¤‰åŒ–ã®é€Ÿåº¦)
           - predictability: predictable/surprising/chaotic (äºˆæ¸¬å¯èƒ½æ€§)
        10. **æ–‡åŒ–ç‰¹æ€§**:
            - regional_style: western/eastern/global/fusion (åœ°åŸŸçš„ã‚¹ã‚¿ã‚¤ãƒ«)
            - era_style: vintage/contemporary/futuristic (æ™‚ä»£çš„ã‚¹ã‚¿ã‚¤ãƒ«)
            - artistic_style: commercial/artistic/experimental (èŠ¸è¡“æ€§)
        11. **æŠ€è¡“ç‰¹æ€§**:
            - production_quality: lo-fi/hi-fi/professional (åˆ¶ä½œå“è³ª)
            - processing_level: natural/processed/heavily_modified (åŠ å·¥åº¦)

        **æ™‚ç³»åˆ—æ„Ÿæƒ…æ›²ç·šåˆ†æž**:
        12. **æ„Ÿæƒ…ã‚¢ãƒ¼ã‚¯**: æ™‚é–“è»¸ã§ã®æ„Ÿæƒ…å¤‰åŒ–ã‚’SRTå½¢å¼ã§è¨˜éŒ²
        13. **ã‚¨ãƒãƒ«ã‚®ãƒ¼æ›²ç·š**: ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¬ãƒ™ãƒ«ã®æ™‚ç³»åˆ—å¤‰åŒ–
        14. **ãƒ†ãƒ³ãƒæ›²ç·š**: ãƒ†ãƒ³ãƒå¤‰åŒ–ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
        15. **å¼·åº¦æ›²ç·š**: éŸ³æ¥½çš„å¼·åº¦ã®æ™‚ç³»åˆ—å¤‰åŒ–

        **å…¥åŠ›å½¢å¼åˆ¥å‡¦ç†**:
        - **prompt**: ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‹ã‚‰éŸ³æ¥½ä¸–ç•Œè¦³ã‚’æŽ¨è«–ãƒ»æ„Ÿæƒ…ã‚¢ãƒ¼ã‚¯æƒ³å®š
        - **url**: æŒ‡å®šURLã®éŸ³æºã‚’å–å¾—ãƒ»åˆ†æžï¼ˆå¯èƒ½ãªå ´åˆï¼‰
        - **file**: æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®éŸ³æºã‚’åˆ†æžï¼ˆå¯èƒ½ãªå ´åˆï¼‰

        **ã‚¨ãƒ©ãƒ¼è€æ€§**: åˆ†æžå›°é›£ãªè¦ç´ ã¯\"moderate\"ã‚„\"unknown\"ç­‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        
        **å¿…é ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**:
        1. **$ANALYSIS_DIR/music-analysis.json** - æ©Ÿæ¢°å‡¦ç†ç”¨ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
        2. **$ANALYSIS_DIR/music-analysis.md** - äººé–“ç¢ºèªç”¨ã®è©³ç´°åˆ†æžçµæžœ
        3. **$ANALYSIS_DIR/emotion-curves.srt** - æ„Ÿæƒ…æ›²ç·šã®SRTå½¢å¼æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
        4. **$ANALYSIS_DIR/emotion-curves.json** - æ„Ÿæƒ…æ›²ç·šã®JSONå½¢å¼æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
        5. **$ANALYSIS_DIR/recommendations.txt** - è¨­å®šæŽ¨å¥¨å€¤ï¼ˆ1è¡Œå½¢å¼ï¼‰

        **JSONãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¾‹**:
        \`\`\`json
        {
          \"atmosphere\": \"peaceful\",
          \"genre\": \"ambient\",
          \"instrumentation\": \"piano,strings\",
          \"tempo\": \"slow\",
          \"energy\": 3,
          \"mood\": \"serene\",
          \"color_temperature\": \"warm\",
          \"acoustic_space\": \"spacious\",
          \"reverb_depth\": \"moderate\",
          \"distance_feel\": \"medium\",
          \"complexity_level\": \"simple\",
          \"change_rate\": \"gradual\",
          \"predictability\": \"predictable\",
          \"regional_style\": \"western\",
          \"era_style\": \"contemporary\",
          \"artistic_style\": \"artistic\",
          \"production_quality\": \"hi-fi\",
          \"processing_level\": \"natural\",
          \"confidence\": 0.85,
          \"input_type\": \"$INPUT_TYPE\"
        }
        \`\`\`

        **SRTæ„Ÿæƒ…æ›²ç·šãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¾‹**:
        \`\`\`srt
        1
        00:00:00,000 --> 00:00:10,000
        energy: 2, mood: serene, atmosphere: peaceful

        2
        00:00:10,000 --> 00:00:20,000
        energy: 4, mood: uplifting, atmosphere: hopeful
        \`\`\`

        **é‡è¦ãªæ³¨æ„ç‚¹**:
        1. å¿…ãš5ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã™ã¹ã¦ã‚’ä½œæˆã—ã¦ãã ã•ã„
        2. JSONå½¢å¼ã¯åŽ³å¯†ã«å¾“ã£ã¦ãã ã•ã„ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨ï¼‰
        3. SRTå½¢å¼ã§æ™‚ç³»åˆ—ã®æ„Ÿæƒ…å¤‰åŒ–ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„
        4. åˆ†æžç†ç”±ã‚’æ˜Žç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„
        5. æ±Žç”¨çš„ãªç”¨é€”ã§æ´»ç”¨å¯èƒ½ãªç‰¹æ€§ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„
        6. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
        
        echo "ðŸš€ Starting Music World Analysis Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 20 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸåˆ†æžçµæžœã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated analysis files..."
        
        # JSONåˆ†æžçµæžœã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
        if [ -f "$ANALYSIS_DIR/music-analysis.json" ]; then
          echo "::notice::âœ… Music analysis JSON generated"
          
          # jqãŒãªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µã§JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          GENRE=$(grep -o '"genre"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          INSTRUMENTATION=$(grep -o '"instrumentation"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          TEMPO=$(grep -o '"tempo"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          ENERGY=$(grep -o '"energy"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/music-analysis.json" | cut -d':' -f2 | tr -d ' ')
          MOOD=$(grep -o '"mood"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          COLOR_TEMPERATURE=$(grep -o '"color_temperature"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          
          # æ–°è¦è¿½åŠ è¦ç´ ã®æŠ½å‡º
          ACOUSTIC_SPACE=$(grep -o '"acoustic_space"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          COMPLEXITY_LEVEL=$(grep -o '"complexity_level"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          REGIONAL_STYLE=$(grep -o '"regional_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          ERA_STYLE=$(grep -o '"era_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          PRODUCTION_QUALITY=$(grep -o '"production_quality"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/music-analysis.json" | cut -d'"' -f4)
          
          echo "Atmosphere: $ATMOSPHERE"
          echo "Genre: $GENRE"
          echo "Instrumentation: $INSTRUMENTATION"
          echo "Tempo: $TEMPO"
          echo "Energy: $ENERGY"
          echo "Mood: $MOOD"
          echo "Color temperature: $COLOR_TEMPERATURE"
          echo "Acoustic space: $ACOUSTIC_SPACE"
          echo "Complexity level: $COMPLEXITY_LEVEL"
          echo "Regional style: $REGIONAL_STYLE"
          echo "Era style: $ERA_STYLE"
          echo "Production quality: $PRODUCTION_QUALITY"
          
          # GitHub Outputã«è¨­å®šï¼ˆåŸºæœ¬è¦ç´ ï¼‰
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "genre=$GENRE" >> $GITHUB_OUTPUT
          echo "instrumentation=$INSTRUMENTATION" >> $GITHUB_OUTPUT
          echo "tempo=$TEMPO" >> $GITHUB_OUTPUT
          echo "energy=$ENERGY" >> $GITHUB_OUTPUT
          echo "mood=$MOOD" >> $GITHUB_OUTPUT
          echo "color-temperature=$COLOR_TEMPERATURE" >> $GITHUB_OUTPUT
          
          # GitHub Outputã«è¨­å®šï¼ˆæ–°è¦è¿½åŠ è¦ç´ ï¼‰
          echo "acoustic-space=${ACOUSTIC_SPACE:-spacious}" >> $GITHUB_OUTPUT
          echo "complexity-level=${COMPLEXITY_LEVEL:-moderate}" >> $GITHUB_OUTPUT
          echo "regional-style=${REGIONAL_STYLE:-global}" >> $GITHUB_OUTPUT
          echo "era-style=${ERA_STYLE:-contemporary}" >> $GITHUB_OUTPUT
          echo "production-quality=${PRODUCTION_QUALITY:-hi-fi}" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Music analysis JSON file not found"
          exit 1
        fi
        
        # æ„Ÿæƒ…æ›²ç·šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/emotion-curves.srt" ]; then
          echo "::notice::âœ… Emotion curves SRT generated"
          echo "First 10 lines of emotion curves:"
          head -10 "$ANALYSIS_DIR/emotion-curves.srt"
        else
          echo "::warning::âš ï¸ Emotion curves SRT not found"
        fi
        
        if [ -f "$ANALYSIS_DIR/emotion-curves.json" ]; then
          echo "::notice::âœ… Emotion curves JSON generated"
        else
          echo "::warning::âš ï¸ Emotion curves JSON not found"
        fi
        
        # æŽ¨å¥¨è¨­å®šã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/recommendations.txt" ]; then
          echo "::notice::âœ… Recommendations generated"
          echo "Recommendations:"
          cat "$ANALYSIS_DIR/recommendations.txt"
        else
          echo "::warning::âš ï¸ Recommendations file not found"
        fi
        
        # åˆ†æžæ–‡æ›¸ã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/music-analysis.md" ]; then
          echo "::notice::âœ… Analysis document generated"
          echo "First 10 lines of analysis:"
          head -10 "$ANALYSIS_DIR/music-analysis.md"
        else
          echo "::warning::âš ï¸ Analysis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push analysis
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          if [ -n "${{ inputs.music-prompt }}" ]; then
            git commit -m "Add music world analysis for prompt: ${{ inputs.music-prompt }}"
          elif [ -n "${{ inputs.music-url }}" ]; then
            git commit -m "Add music world analysis for URL: ${{ inputs.music-url }}"
          else
            git commit -m "Add music world analysis for file: ${{ inputs.music-file }}"
          fi
          # Pull before push to handle concurrent commits
          for i in {1..3}; do
            git add . && git pull origin ${{ inputs.branch-name }} --rebase && git push origin ${{ inputs.branch-name }} && break
            echo "Push attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
        fi