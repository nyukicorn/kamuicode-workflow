name: 'Image World Analysis'
description: 'Analyze image prompts to extract world atmosphere and visual characteristics'
author: 'KamuiCode Workflow'

inputs:
  image-prompt:
    description: 'The image prompt to analyze for world building'
    required: true
  folder-name:
    description: 'The folder name for storing analysis files'
    required: true
  branch-name:
    description: 'The branch to work on'
    required: true
  oauth-token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  analysis-completed:
    description: 'Whether analysis was completed successfully'
    value: ${{ steps.analysis.outputs.completed }}
  scene-type:
    description: 'Analyzed scene type (static/dynamic/dramatic)'
    value: ${{ steps.analysis.outputs.scene-type }}
  atmosphere:
    description: 'Overall atmosphere (peaceful/energetic/mysterious/etc)'
    value: ${{ steps.analysis.outputs.atmosphere }}
  depth-mode:
    description: 'Recommended depth enhancement (normal/enhanced)'
    value: ${{ steps.analysis.outputs.depth-mode }}
  lighting-style:
    description: 'Lighting characteristics (soft/bright/dramatic/etc)'
    value: ${{ steps.analysis.outputs.lighting-style }}
  movement-energy:
    description: 'Movement energy level (1-10 scale)'
    value: ${{ steps.analysis.outputs.movement-energy }}
  color-temperature:
    description: 'Color temperature (warm/cool/neutral)'
    value: ${{ steps.analysis.outputs.color-temperature }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch-name }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      shell: bash
      run: npm install @anthropic-ai/claude-code
    
    - name: ç”»åƒä¸–ç•Œè¦³åˆ†æžã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
      id: analysis
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.oauth-token }}
      run: |
        echo "::group::ðŸŽ¨ Image World Analysis Agent Execution"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # è¨­å®š
        IMAGE_PROMPT="${{ inputs.image-prompt }}"
        FOLDER_NAME="${{ inputs.folder-name }}"
        ANALYSIS_DIR="$FOLDER_NAME/world-analysis"
        
        echo "Image prompt: $IMAGE_PROMPT"
        echo "Analysis folder: $ANALYSIS_DIR"
        
        # åˆ†æžãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
        if [ ! -d "$ANALYSIS_DIR" ]; then
          mkdir -p "$ANALYSIS_DIR"
          echo "ðŸ“ Created analysis folder: $ANALYSIS_DIR"
        fi
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
        PROMPT="ã‚ãªãŸã¯ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ä¸–ç•Œè¦³ã‚’åˆ†æžã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚ä¸Žãˆã‚‰ã‚ŒãŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è©³ç´°ã«åˆ†æžã—ã€3Dãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ä½“é¨“ã«æœ€é©ãªè¨­å®šã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

        **åˆ†æžå¯¾è±¡ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $IMAGE_PROMPT

        **åˆ†æžã‚¿ã‚¹ã‚¯**:
        1. **ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—åˆ†æž**: é™çš„(static)/å‹•çš„(dynamic)/åŠ‡çš„(dramatic)ã®ã„ãšã‚Œã‹ã‚’åˆ¤å®š
        2. **é›°å›²æ°—åˆ†æž**: peaceful/energetic/mysterious/dramatic/romantic/adventurousç­‰ã‚’ç‰¹å®š
        3. **æ·±åº¦æŽ¨å¥¨**: normal(æ¨™æº–)/enhanced(å¼·èª¿)ã®ã©ã¡ã‚‰ãŒé©åˆ‡ã‹ã‚’åˆ¤å®š
        4. **å…‰ã®ç‰¹æ€§**: soft/bright/dramatic/dim/warm/coolç­‰ã®ç…§æ˜Žã‚¹ã‚¿ã‚¤ãƒ«
        5. **å‹•ãã®ã‚¨ãƒãƒ«ã‚®ãƒ¼**: 1-10ã®ã‚¹ã‚±ãƒ¼ãƒ«ã§å‹•ãã®æ¿€ã—ã•ã‚’è©•ä¾¡
        6. **è‰²æ¸©åº¦**: warm(æš–è‰²ç³»)/cool(å¯’è‰²ç³»)/neutral(ä¸­æ€§)ã‚’åˆ¤å®š

        **åˆ†æžåŸºæº–**:
        - **é™çš„ã‚·ãƒ¼ãƒ³**: åº­åœ’ã€å»ºç¯‰ç‰©ã€é™ç‰©ç­‰ â†’ depth: normal
        - **å‹•çš„ã‚·ãƒ¼ãƒ³**: æµ·ã€é¢¨æ™¯ã€è‡ªç„¶ç¾è±¡ç­‰ â†’ depth: enhanced
        - **åŠ‡çš„ã‚·ãƒ¼ãƒ³**: æ´žçªŸã€å³¡è°·ã€å±±å²³ç­‰ â†’ depth: enhanced
        
        **å¿…é ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**:
        1. **$ANALYSIS_DIR/image-analysis.json** - æ©Ÿæ¢°å‡¦ç†ç”¨ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
        2. **$ANALYSIS_DIR/image-analysis.md** - äººé–“ç¢ºèªç”¨ã®è©³ç´°åˆ†æžçµæžœ
        3. **$ANALYSIS_DIR/recommendations.txt** - è¨­å®šæŽ¨å¥¨å€¤ï¼ˆ1è¡Œå½¢å¼ï¼‰

        **JSONãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¾‹**:
        ```json
        {
          \"scene_type\": \"dynamic\",
          \"atmosphere\": \"peaceful\",
          \"depth_mode\": \"enhanced\",
          \"lighting_style\": \"soft\",
          \"movement_energy\": 3,
          \"color_temperature\": \"warm\",
          \"confidence\": 0.85
        }
        ```

        **é‡è¦ãªæ³¨æ„ç‚¹**:
        1. å¿…ãš3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã™ã¹ã¦ã‚’ä½œæˆã—ã¦ãã ã•ã„
        2. JSONå½¢å¼ã¯åŽ³å¯†ã«å¾“ã£ã¦ãã ã•ã„ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨ï¼‰
        3. åˆ†æžç†ç”±ã‚’æ˜Žç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„
        4. 360åº¦ãƒ‘ãƒŽãƒ©ãƒžãƒ»ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ä½“é¨“ã«æœ€é©åŒ–ã—ãŸæŽ¨å¥¨ã‚’è¡Œã£ã¦ãã ã•ã„
        5. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
        
        echo "ðŸš€ Starting Image World Analysis Agent Claude Code CLI..."
        echo "ðŸ“ Prompt length: ${#PROMPT}"
        
        # Claude Code CLIã®å®Ÿè¡Œ
        npx @anthropic-ai/claude-code \
          --allowedTools "Read,Write,Edit,Bash" \
          --max-turns 15 \
          --verbose \
          --permission-mode "bypassPermissions" \
          -p "$PROMPT" || {
            echo "::error::âŒ Claude Code CLI execution failed"
            exit 1
          }
        
        # ç”Ÿæˆã•ã‚ŒãŸåˆ†æžçµæžœã®ç¢ºèª
        echo ""
        echo "ðŸ“‹ Checking generated analysis files..."
        
        # JSONåˆ†æžçµæžœã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
        if [ -f "$ANALYSIS_DIR/image-analysis.json" ]; then
          echo "::notice::âœ… Image analysis JSON generated"
          
          # jqãŒãªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µã§JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          SCENE_TYPE=$(grep -o '"scene_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          ATMOSPHERE=$(grep -o '"atmosphere"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          DEPTH_MODE=$(grep -o '"depth_mode"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          LIGHTING_STYLE=$(grep -o '"lighting_style"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          MOVEMENT_ENERGY=$(grep -o '"movement_energy"[[:space:]]*:[[:space:]]*[0-9]*' "$ANALYSIS_DIR/image-analysis.json" | cut -d':' -f2 | tr -d ' ')
          COLOR_TEMPERATURE=$(grep -o '"color_temperature"[[:space:]]*:[[:space:]]*"[^"]*"' "$ANALYSIS_DIR/image-analysis.json" | cut -d'"' -f4)
          
          echo "Scene type: $SCENE_TYPE"
          echo "Atmosphere: $ATMOSPHERE"
          echo "Depth mode: $DEPTH_MODE"
          echo "Lighting style: $LIGHTING_STYLE"
          echo "Movement energy: $MOVEMENT_ENERGY"
          echo "Color temperature: $COLOR_TEMPERATURE"
          
          # GitHub Outputã«è¨­å®š
          echo "scene-type=$SCENE_TYPE" >> $GITHUB_OUTPUT
          echo "atmosphere=$ATMOSPHERE" >> $GITHUB_OUTPUT
          echo "depth-mode=$DEPTH_MODE" >> $GITHUB_OUTPUT
          echo "lighting-style=$LIGHTING_STYLE" >> $GITHUB_OUTPUT
          echo "movement-energy=$MOVEMENT_ENERGY" >> $GITHUB_OUTPUT
          echo "color-temperature=$COLOR_TEMPERATURE" >> $GITHUB_OUTPUT
        else
          echo "::error::âŒ Image analysis JSON file not found"
          exit 1
        fi
        
        # æŽ¨å¥¨è¨­å®šã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/recommendations.txt" ]; then
          echo "::notice::âœ… Recommendations generated"
          echo "Recommendations:"
          cat "$ANALYSIS_DIR/recommendations.txt"
        else
          echo "::warning::âš ï¸ Recommendations file not found"
        fi
        
        # åˆ†æžæ–‡æ›¸ã®ç¢ºèª
        if [ -f "$ANALYSIS_DIR/image-analysis.md" ]; then
          echo "::notice::âœ… Analysis document generated"
          echo "First 10 lines of analysis:"
          head -10 "$ANALYSIS_DIR/image-analysis.md"
        else
          echo "::warning::âš ï¸ Analysis document not found"
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"
    
    - name: Commit and push analysis
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add ${{ inputs.folder-name }}/
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          git commit -m "Add image world analysis for: ${{ inputs.image-prompt }}"
          git push origin ${{ inputs.branch-name }}
        fi