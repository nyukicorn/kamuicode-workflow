name: Creative Art Studio

on:
  workflow_dispatch:
    inputs:
      art_vision:
        description: 'ä½œå“ã®ãƒ“ã‚¸ãƒ§ãƒ³ï¼ˆè©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„ï¼‰'
        required: true
        type: string
        # ä¾‹: "æ¡œã®å­£ç¯€ã®äº¬éƒ½ã®åº­åœ’ã§ã€ç€ç‰©ã‚’ç€ãŸå¥³æ€§ãŒé™ã‹ã«èŒ¶ã‚’ç‚¹ã¦ã¦ã„ã‚‹ã€‚èƒŒæ™¯ã¯å¤ã„èŒ¶å®¤ã§ã€å¤–ã¯æº€é–‹ã®æ¡œã€‚æ™‚é–“ã¯å¤•æ–¹ã€æŸ”ã‚‰ã‹ãªå…‰ãŒå·®ã—è¾¼ã‚€..."
        
      proven_mcps:
        description: 'ãƒ†ã‚¹ãƒˆæ¸ˆã¿MCPï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: true
        type: string
        default: 'imagen4-fast,google-lyria,hailuo-02-pro'
        # ä¾‹: "imagen4-fast,google-lyria,hailuo-02-pro,threejs-stable"
        
      quality_level:
        description: 'å“è³ªãƒ¬ãƒ™ãƒ«'
        type: choice
        options:
          - 'exhibition'    # å±•ç¤ºãƒ¬ãƒ™ãƒ«
          - 'portfolio'     # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ¬ãƒ™ãƒ«
          - 'personal'      # å€‹äººç”¨ãƒ¬ãƒ™ãƒ«
        default: 'exhibition'
        
      reference_experiments:
        description: 'å‚è€ƒã«ã™ã‚‹å®Ÿé¨“IDï¼ˆä»»æ„ï¼‰'
        type: string
        required: false
        # ä¾‹: "exp-20250117-120000,exp-20250116-150000"
        
      target_duration:
        description: 'ç›®æ¨™åˆ¶ä½œæ™‚é–“ï¼ˆåˆ†ï¼‰'
        type: choice
        options:
          - '60'    # 1æ™‚é–“
          - '120'   # 2æ™‚é–“  
          - '180'   # 3æ™‚é–“
          - '240'   # 4æ™‚é–“
          - '300'   # 5æ™‚é–“
        default: '180'

jobs:
  preparation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      project-id: ${{ steps.setup.outputs.project-id }}
      project-dir: ${{ steps.setup.outputs.project-dir }}
      analysis-result: ${{ steps.analyze.outputs.analysis-result }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup art project
        id: setup
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ä¸€æ„ãªIDã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          PROJECT_ID="art-$(date +%Y%m%d-%H%M%S)"
          PROJECT_DIR="art-studio-works/${PROJECT_ID}"
          
          mkdir -p "$PROJECT_DIR"/{drafts,iterations,final,references,logs}
          
          echo "project-id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "project-dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          
          echo "ğŸ¨ ã‚¢ãƒ¼ãƒˆåˆ¶ä½œé–‹å§‹: $PROJECT_ID"
          echo "ğŸ“ åˆ¶ä½œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PROJECT_DIR"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æƒ…å ±ã‚’è¨˜éŒ²
          cat > "$PROJECT_DIR/project-info.json" << EOF
          {
            "project_id": "$PROJECT_ID",
            "started_at": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "art_vision": "${{ inputs.art_vision }}",
            "quality_level": "${{ inputs.quality_level }}",
            "proven_mcps": "${{ inputs.proven_mcps }}",
            "reference_experiments": "${{ inputs.reference_experiments }}",
            "target_duration": "${{ inputs.target_duration }}",
            "status": "started"
          }
          EOF
          
          # ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³ã‚’è©³ç´°è¨˜éŒ²
          cat > "$PROJECT_DIR/vision.md" << 'EOF'
          # ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³
          
          ${{ inputs.art_vision }}
          
          ## æŠ€è¡“è¦ä»¶
          - ä½¿ç”¨MCP: ${{ inputs.proven_mcps }}
          - å“è³ªãƒ¬ãƒ™ãƒ«: ${{ inputs.quality_level }}
          - åˆ¶ä½œæ™‚é–“: ${{ inputs.target_duration }}åˆ†
          
          ## åˆ¶ä½œå·¥ç¨‹
          1. ãƒ“ã‚¸ãƒ§ãƒ³åˆ†æ
          2. æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã®æ¤œè¨¼
          3. æ®µéšçš„åˆ¶ä½œ
          4. å“è³ªå‘ä¸Šã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          5. æœ€çµ‚èª¿æ•´
          
          EOF
      
      - name: Analyze art vision
        id: analyze
        run: |
          echo "ğŸ” ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³ã‚’åˆ†æä¸­..."
          
          ART_VISION="${{ inputs.art_vision }}"
          PROVEN_MCPS="${{ inputs.proven_mcps }}"
          
          # ãƒ“ã‚¸ãƒ§ãƒ³ã‹ã‚‰æŠ€è¡“çš„è¦ä»¶ã‚’æŠ½å‡º
          ANALYSIS_RESULT=""
          
          # ç”»åƒç”Ÿæˆã®å¿…è¦æ€§ã‚’åˆ¤å®š
          if [[ "$ART_VISION" =~ ç”»åƒ|å†™çœŸ|çµµ|é¢¨æ™¯|äººç‰©|è‰²å½©|æ§‹å›³ ]]; then
            ANALYSIS_RESULT="$ANALYSIS_RESULT,image_generation_required"
          fi
          
          # éŸ³æ¥½ç”Ÿæˆã®å¿…è¦æ€§ã‚’åˆ¤å®š
          if [[ "$ART_VISION" =~ éŸ³æ¥½|éŸ³|ãƒ¡ãƒ­ãƒ‡ã‚£|ãƒªã‚ºãƒ |æ¥½å™¨|BGM ]]; then
            ANALYSIS_RESULT="$ANALYSIS_RESULT,music_generation_required"
          fi
          
          # å‹•ç”»ç”Ÿæˆã®å¿…è¦æ€§ã‚’åˆ¤å®š
          if [[ "$ART_VISION" =~ å‹•ç”»|æ˜ åƒ|ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³|å‹•ã|æ™‚é–“ ]]; then
            ANALYSIS_RESULT="$ANALYSIS_RESULT,video_generation_required"
          fi
          
          # 3Dè¦ç´ ã®å¿…è¦æ€§ã‚’åˆ¤å®š
          if [[ "$ART_VISION" =~ ç«‹ä½“|3[dD]|ç©ºé–“|360|ãƒ‘ãƒãƒ©ãƒ|ç’°å¢ƒ ]]; then
            ANALYSIS_RESULT="$ANALYSIS_RESULT,3d_elements_required"
          fi
          
          # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã®å¿…è¦æ€§ã‚’åˆ¤å®š
          if [[ "$ART_VISION" =~ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–|æ“ä½œ|ã‚¯ãƒªãƒƒã‚¯|ãƒœã‚¿ãƒ³|UI ]]; then
            ANALYSIS_RESULT="$ANALYSIS_RESULT,interactive_elements_required"
          fi
          
          # æœ€åˆã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          ANALYSIS_RESULT=${ANALYSIS_RESULT#,}
          
          echo "analysis-result=$ANALYSIS_RESULT" >> $GITHUB_OUTPUT
          echo "ğŸ¯ åˆ†æçµæœ: $ANALYSIS_RESULT"
          
          # åˆ†æçµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > "${{ steps.setup.outputs.project-dir }}/analysis.json" << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "art_vision": "$ART_VISION",
            "technical_requirements": "$ANALYSIS_RESULT",
            "available_mcps": "$PROVEN_MCPS",
            "complexity_level": "$(echo "$ANALYSIS_RESULT" | tr ',' '\n' | wc -l)",
            "estimated_iterations": 3
          }
          EOF
      
      - name: Validate MCP availability
        run: |
          echo "ğŸ”§ MCPå¯ç”¨æ€§ã‚’ç¢ºèªä¸­..."
          
          PROVEN_MCPS="${{ inputs.proven_mcps }}"
          PROJECT_DIR="${{ steps.setup.outputs.project-dir }}"
          
          # åŸºæœ¬MCPã®å­˜åœ¨ç¢ºèª
          if [[ "$PROVEN_MCPS" =~ imagen4-fast ]]; then
            echo "âœ… imagen4-fast: åˆ©ç”¨å¯èƒ½"
          else
            echo "âš ï¸ imagen4-fast: æœªæŒ‡å®š"
          fi
          
          if [[ "$PROVEN_MCPS" =~ google-lyria ]]; then
            echo "âœ… google-lyria: åˆ©ç”¨å¯èƒ½"
          else
            echo "âš ï¸ google-lyria: æœªæŒ‡å®š"
          fi
          
          if [[ "$PROVEN_MCPS" =~ hailuo-02-pro ]]; then
            echo "âœ… hailuo-02-pro: åˆ©ç”¨å¯èƒ½"
          else
            echo "âš ï¸ hailuo-02-pro: æœªæŒ‡å®š"
          fi
          
          # å®Ÿé¨“çµæœã®å‚ç…§
          REFERENCE_EXPERIMENTS="${{ inputs.reference_experiments }}"
          if [[ -n "$REFERENCE_EXPERIMENTS" ]]; then
            echo "ğŸ“‹ å‚è€ƒå®Ÿé¨“ã‚’ç¢ºèªä¸­..."
            
            # å‚è€ƒå®Ÿé¨“ã®å­˜åœ¨ç¢ºèª
            IFS=',' read -ra REFS <<< "$REFERENCE_EXPERIMENTS"
            for ref in "${REFS[@]}"; do
              if [ -d "experiment-results/$ref" ]; then
                echo "âœ… å‚è€ƒå®Ÿé¨“ $ref: è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
                # å®Ÿé¨“çµæœã‚’ã‚³ãƒ”ãƒ¼
                cp -r "experiment-results/$ref" "$PROJECT_DIR/references/"
              else
                echo "âš ï¸ å‚è€ƒå®Ÿé¨“ $ref: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
            done
          fi

  art-creation:
    needs: [preparation]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Prepare MCP configuration
        run: |
          PROJECT_DIR="${{ needs.preparation.outputs.project-dir }}"
          
          # æœ¬ç•ªç”¨ã®MCPè¨­å®šã‚’æº–å‚™
          cp .claude/mcp-kamuicode.json "$PROJECT_DIR/mcp-production.json"
          
          echo "ğŸ”§ æœ¬ç•ªç”¨MCPè¨­å®šã‚’æº–å‚™ã—ã¾ã—ãŸ"
      
      - name: Create art project (Coming Soon)
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          PROJECT_DIR="${{ needs.preparation.outputs.project-dir }}"
          PROJECT_ID="${{ needs.preparation.outputs.project-id }}"
          
          echo "::group::ğŸ¨ ã‚¢ãƒ¼ãƒˆåˆ¶ä½œå®Ÿè¡Œä¸­"
          echo "é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_ID"
          echo "å“è³ªãƒ¬ãƒ™ãƒ«: ${{ inputs.quality_level }}"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
          exec 1> >(tee -a "$PROJECT_DIR/logs/creation.log")
          exec 2> >(tee -a "$PROJECT_DIR/logs/error.log")
          
          # ç¾åœ¨ã¯æº–å‚™æ®µéšã®ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
          cat > "$PROJECT_DIR/drafts/placeholder.md" << 'EOF'
          # ã‚¢ãƒ¼ãƒˆåˆ¶ä½œãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          
          ## ç¾åœ¨ã®çŠ¶æ³
          Creative Art Studio ã¯ã¾ã é–‹ç™ºä¸­ã§ã™ã€‚
          
          ## è¨ˆç”»ã•ã‚ŒãŸæ©Ÿèƒ½
          1. è©³ç´°ãªãƒ“ã‚¸ãƒ§ãƒ³åˆ†æ
          2. æ®µéšçš„ãªåˆ¶ä½œãƒ—ãƒ­ã‚»ã‚¹
          3. å“è³ªå‘ä¸Šã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          4. æœ€çµ‚çš„ãªä½œå“ã®å®Œæˆ
          
          ## ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³
          ${{ inputs.art_vision }}
          
          ## ä½¿ç”¨äºˆå®šMCP
          ${{ inputs.proven_mcps }}
          
          ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          - Creative Test Lab ã§ã®ååˆ†ãªå®Ÿé¨“
          - æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®è“„ç©
          - æœ¬æ ¼çš„ãªã‚¢ãƒ¼ãƒˆåˆ¶ä½œæ©Ÿèƒ½ã®å®Ÿè£…
          
          EOF
          
          echo "ğŸ“ ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
          echo "ğŸ”„ å°†æ¥ã®å®Ÿè£…: æœ¬æ ¼çš„ãªã‚¢ãƒ¼ãƒˆåˆ¶ä½œæ©Ÿèƒ½"
          echo "çµ‚äº†æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          echo "::endgroup::"
      
      - name: Update project status
        run: |
          PROJECT_DIR="${{ needs.preparation.outputs.project-dir }}"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’æ›´æ–°
          jq '.status = "placeholder_created" | .completed_at = now | .completed_at_iso = (now | strftime("%Y-%m-%dT%H:%M:%SZ"))' \
            "$PROJECT_DIR/project-info.json" > "$PROJECT_DIR/project-info.json.tmp"
          mv "$PROJECT_DIR/project-info.json.tmp" "$PROJECT_DIR/project-info.json"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
          cat > "$PROJECT_DIR/README.md" << EOF
          # ã‚¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${{ needs.preparation.outputs.project-id }}
          
          ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
          - **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID**: ${{ needs.preparation.outputs.project-id }}
          - **é–‹å§‹æ—¥æ™‚**: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          - **å“è³ªãƒ¬ãƒ™ãƒ«**: ${{ inputs.quality_level }}
          - **åˆ¶ä½œæ™‚é–“**: ${{ inputs.target_duration }}åˆ†
          
          ## ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³
          ${{ inputs.art_vision }}
          
          ## æŠ€è¡“çš„è¦ä»¶
          - **ä½¿ç”¨MCP**: ${{ inputs.proven_mcps }}
          - **åˆ†æçµæœ**: ${{ needs.preparation.outputs.analysis-result }}
          
          ## ç¾åœ¨ã®çŠ¶æ³
          ğŸš§ **é–‹ç™ºä¸­**: Creative Art Studio ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚
          
          ### å®Œæˆäºˆå®šæ©Ÿèƒ½
          - è©³ç´°ãªãƒ“ã‚¸ãƒ§ãƒ³åˆ†æ
          - æ®µéšçš„åˆ¶ä½œãƒ—ãƒ­ã‚»ã‚¹
          - å“è³ªå‘ä¸Šã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          - æœ€çµ‚ä½œå“ã®å®Œæˆ
          
          ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. Creative Test Lab ã§ã®ååˆ†ãªå®Ÿé¨“
          2. æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®è“„ç©ã¨åˆ†æ
          3. æœ¬æ ¼çš„ãªã‚¢ãƒ¼ãƒˆåˆ¶ä½œæ©Ÿèƒ½ã®å®Ÿè£…
          4. é«˜å“è³ªä½œå“ã®åˆ¶ä½œé–‹å§‹
          
          ## é–¢é€£å®Ÿé¨“
          EOF
          
          # å‚è€ƒå®Ÿé¨“ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if [[ -n "${{ inputs.reference_experiments }}" ]]; then
            echo "- å‚è€ƒå®Ÿé¨“: ${{ inputs.reference_experiments }}" >> "$PROJECT_DIR/README.md"
          else
            echo "- å‚è€ƒå®Ÿé¨“: ãªã—" >> "$PROJECT_DIR/README.md"
          fi
          
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"
      
      - name: Commit art project
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add art-studio-works/
          
          if git diff --cached --quiet; then
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "Add art project: ${{ needs.preparation.outputs.project-id }}

          ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³: ${{ inputs.art_vision }}
          å“è³ªãƒ¬ãƒ™ãƒ«: ${{ inputs.quality_level }}
          ä½¿ç”¨MCP: ${{ inputs.proven_mcps }}
          
          ğŸ¨ Generated with Creative Art Studio (Preview)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi
      
      - name: Project summary
        run: |
          PROJECT_ID="${{ needs.preparation.outputs.project-id }}"
          echo "::notice::ğŸ¨ ã‚¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: $PROJECT_ID"
          echo "::notice::ğŸ“‹ ä½œå“ãƒ“ã‚¸ãƒ§ãƒ³: ${{ inputs.art_vision }}"
          echo "::notice::ğŸ¯ å“è³ªãƒ¬ãƒ™ãƒ«: ${{ inputs.quality_level }}"
          echo "::notice::ğŸ”§ ä½¿ç”¨MCP: ${{ inputs.proven_mcps }}"
          echo "::notice::ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: art-studio-works/$PROJECT_ID/"
          echo "::notice::ğŸš§ ç¾åœ¨ã¯é–‹ç™ºä¸­ - æœ¬æ ¼å®Ÿè£…ã¯å®Ÿé¨“å®Œäº†å¾Œ"
          echo "::notice::ğŸ§ª ã¾ãšã¯ Creative Test Lab ã§å®Ÿé¨“ã‚’é‡ã­ã¦ãã ã•ã„"