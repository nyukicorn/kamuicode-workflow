name: Creative Test Lab Phase1

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'å®Ÿé¨“å†…å®¹ï¼ˆä¾‹ï¼šæ¡œã®é¢¨æ™¯ç”»åƒã‚’ä½œã£ã¦ï¼‰'
        required: true
        type: string

jobs:
  phase1-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup experiment
        id: setup
        run: |
          EXPERIMENT_ID="phase1-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          mkdir -p "$EXPERIMENT_DIR"/{output,logs}
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
          echo "ðŸ§ª Phase 1ãƒ†ã‚¹ãƒˆé–‹å§‹: $EXPERIMENT_ID"
      
      - name: Prepare MCP config
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          if [ -n "$MCP_CONFIG" ]; then
            echo "$MCP_CONFIG" > "$EXPERIMENT_DIR/mcp-config.json"
            echo "âœ… MCPè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
            echo "ðŸ“Š MCPè¨­å®šã‚µãƒ¼ãƒãƒ¼æ•°: $(echo "$MCP_CONFIG" | jq '.mcpServers | length' 2>/dev/null || echo 'JSONè§£æžã‚¨ãƒ©ãƒ¼')"
            echo "ðŸ” imagen4-fastè¨­å®šç¢ºèª: $(echo "$MCP_CONFIG" | jq '.mcpServers | has("t2i-fal-imagen4-fast")' 2>/dev/null || echo 'false')"
          else
            echo "âŒ MCP_CONFIG secretãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
      
      - name: Test imagen4-fast
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          DESCRIPTION="${{ inputs.experiment_description }}"
          
          echo "ðŸš€ imagen4-fastç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆé–‹å§‹"
          echo "ðŸ“ æ—¥æœ¬èªžæŒ‡ç¤º: $DESCRIPTION"
          
          # è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›
          if [[ "$DESCRIPTION" =~ æ¡œ ]]; then
            ENGLISH_PROMPT="Beautiful cherry blossoms in full bloom"
          elif [[ "$DESCRIPTION" =~ èŠ± ]]; then
            ENGLISH_PROMPT="Beautiful colorful flowers in garden"
          else
            ENGLISH_PROMPT="Beautiful landscape artwork"
          fi
          
          echo "ðŸ”„ è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGLISH_PROMPT"
          
          # Claude Codeå®Ÿè¡Œï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
          echo "ðŸ¤– Claude Codeå®Ÿè¡Œä¸­..."
          echo "ðŸ“ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: $EXPERIMENT_DIR/mcp-config.json"
          echo "ðŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: Use mcp__t2i-fal-imagen4-fast__generate to create: $ENGLISH_PROMPT. Save as generated-image.png"
          
          # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          mkdir -p "$EXPERIMENT_DIR/logs"
          
          # Claude Codeå®Ÿè¡Œ
          npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/mcp-config.json" \
            --message="Use mcp__t2i-fal-imagen4-fast__generate to create: $ENGLISH_PROMPT. Save as generated-image.png" \
            > "$EXPERIMENT_DIR/logs/claude-output.log" 2>&1
          
          EXIT_CODE=$?
          echo "ðŸ“Š Claude Codeçµ‚äº†ã‚³ãƒ¼ãƒ‰: $EXIT_CODE"
          
          # ãƒ­ã‚°å†…å®¹ã‚’è¡¨ç¤º
          echo "ðŸ“‹ Claude Codeå®Ÿè¡Œãƒ­ã‚°ï¼ˆæœ€å¾Œã®10è¡Œï¼‰:"
          tail -10 "$EXPERIMENT_DIR/logs/claude-output.log" 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # çµæžœç¢ºèª
          if ls *.png *.jpg 2>/dev/null; then
            echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸï¼"
            mv *.png *.jpg "$EXPERIMENT_DIR/output/" 2>/dev/null || true
          else
            echo "âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          ls -la "$EXPERIMENT_DIR/output/" || echo "outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
      
      - name: Save results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          # ç°¡å˜ãªãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          echo "# Phase 1ãƒ†ã‚¹ãƒˆçµæžœ: $EXPERIMENT_ID" > "$EXPERIMENT_DIR/README.md"
          echo "å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}" >> "$EXPERIMENT_DIR/README.md"
          echo "å®Ÿè¡Œæ—¥æ™‚: $(date)" >> "$EXPERIMENT_DIR/README.md"
          
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A $EXPERIMENT_DIR/output)" ]; then
            echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æˆåŠŸ" >> "$EXPERIMENT_DIR/README.md"
            for img in "$EXPERIMENT_DIR/output"/*; do
              if [ -f "$img" ]; then
                filename=$(basename "$img")
                echo "![Generated Image](output/$filename)" >> "$EXPERIMENT_DIR/README.md"
              fi
            done
          else
            echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âŒ å¤±æ•—" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # Git commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add experiment-results/
          git diff --cached --quiet || git commit -m "Phase 1ãƒ†ã‚¹ãƒˆ: $EXPERIMENT_ID" && git push