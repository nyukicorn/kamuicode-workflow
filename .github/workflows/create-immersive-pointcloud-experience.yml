name: 'Create Immersive Pointcloud Experience'

on:
  workflow_dispatch:
    inputs:
      image-prompt:
        description: 'ç”Ÿæˆã™ã‚‹ç”»åƒã®è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
        default: 'A beautiful Japanese garden with cherry blossoms, serene pond with koi fish, traditional stone lantern'
      
      image-model:
        description: 'ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: false
        type: choice
        options:
          - 'auto'
          - 'imagen4-ultra'
          - 'imagen4-fast'
          - 'imagen3'
          - 'flux-schnell'
          - 'photo-flux'
        default: 'imagen4-ultra'
      
      music-prompt:
        description: 'èƒŒæ™¯éŸ³æ¥½ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string
        default: 'Ambient, peaceful, zen garden atmosphere, soft piano and nature sounds'
      
      enable-music:
        description: 'èƒŒæ™¯éŸ³æ¥½ã‚’ç”Ÿæˆã™ã‚‹'
        required: false
        type: boolean
        default: true
      
      viewer-title:
        description: 'ãƒ“ãƒ¥ãƒ¼ã‚¢ã®ã‚¿ã‚¤ãƒˆãƒ«'
        required: false
        type: string
        default: 'Immersive 3D Point Cloud Experience'
      
      background-style:
        description: 'èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«'
        required: false
        type: choice
        options:
          - 'solid-black'
          - 'solid-dark-gray'
          - 'dark-blue'
          - 'gradient-dark'
          - 'gradient-cosmic'
        default: 'solid-black'
      
      depth-model:
        description: 'æ·±åº¦æŽ¨å®šãƒ¢ãƒ‡ãƒ«'
        required: false
        type: choice
        options:
          - 'midas_v21_small'
          - 'midas_v21'
        default: 'midas_v21'
      
      point-size:
        description: 'ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ã®ã‚µã‚¤ã‚º'
        required: false
        type: string
        default: '1.5'
      
      auto-rotate:
        description: 'è‡ªå‹•å›žè»¢ã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "immersive-pointcloud"
  cancel-in-progress: false

jobs:
  create-immersive-experience:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Translate Image Prompt to English
        id: image-translation
        uses: ./.github/actions/kamui-modules/prompt-translation
        with:
          japanese-prompt: ${{ inputs.image-prompt }}
          oauth-token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
      
      - name: Generate Image with AI
        id: image
        uses: ./.github/actions/kamui-modules/image-generation
        with:
          image-prompt: ${{ steps.image-translation.outputs.english-prompt }}
          image-model: ${{ inputs.image-model }}
          folder-name: 'immersive-pointcloud-${{ steps.timestamp.outputs.value }}'
          branch-name: 'main'
          oauth-token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}
      
      - name: Translate Music Prompt to English
        id: music-translation
        if: inputs.enable-music == true
        uses: ./.github/actions/kamui-modules/prompt-translation
        with:
          japanese-prompt: ${{ inputs.music-prompt }}
          oauth-token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
      
      - name: Generate Background Music (Optional)
        id: music
        if: inputs.enable-music == true
        uses: ./.github/actions/kamui-modules/music-generation
        with:
          music-concept: ${{ steps.music-translation.outputs.english-prompt }}
          music-prompt: ${{ steps.music-translation.outputs.english-prompt }}
          folder-name: 'immersive-pointcloud-${{ steps.timestamp.outputs.value }}'
          branch-name: 'main'
          oauth-token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}
      
      - name: Save music path
        id: save-music
        if: inputs.enable-music == true
        run: |
          # Find the generated music (avoiding duplicated paths)
          MUSIC_FILE=$(find immersive-pointcloud-${{ steps.timestamp.outputs.value }} -name "*.wav" -o -name "*.mp3" | head -1)
          if [ -n "$MUSIC_FILE" ]; then
            # Clean up duplicated path segments
            CLEAN_MUSIC_FILE=$(echo "$MUSIC_FILE" | sed 's|immersive-pointcloud-[0-9]\{8\}-[0-9]\{6\}/music/immersive-pointcloud-[0-9]\{8\}-[0-9]\{6\}/music/|immersive-pointcloud-${{ steps.timestamp.outputs.value }}/music/|g')
            
            # If the cleaned path is different, move the file to correct location
            if [ "$MUSIC_FILE" != "$CLEAN_MUSIC_FILE" ]; then
              echo "ðŸ”§ Fixing duplicated music path..."
              echo "Original: $MUSIC_FILE"
              echo "Fixed: $CLEAN_MUSIC_FILE"
              mkdir -p "$(dirname "$CLEAN_MUSIC_FILE")"
              mv "$MUSIC_FILE" "$CLEAN_MUSIC_FILE"
              MUSIC_FILE="$CLEAN_MUSIC_FILE"
            fi
            
            echo "music-path=$MUSIC_FILE" >> $GITHUB_OUTPUT
            echo "music-completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Generated music: $MUSIC_FILE"
          else
            echo "music-completed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Music generation skipped or failed"
          fi
      
      - name: Generate 3D Point Cloud
        id: pointcloud
        uses: ./.github/actions/kamui-modules/pointcloud-generation
        with:
          input-image-path: 'immersive-pointcloud-${{ steps.timestamp.outputs.value }}/images/generated-image.png'
          output-folder: 'immersive-pointcloud-${{ steps.timestamp.outputs.value }}'
          branch-name: 'main'
          depth-model: ${{ inputs.depth-model }}
      
      - name: Set background color
        id: bg-color
        run: |
          case "${{ inputs.background-style }}" in
            "solid-black")
              echo "color=#000000" >> $GITHUB_OUTPUT
              ;;
            "solid-dark-gray")
              echo "color=#222222" >> $GITHUB_OUTPUT
              ;;
            "dark-blue")
              echo "color=#0a0a2a" >> $GITHUB_OUTPUT
              ;;
            "gradient-dark")
              echo "color=#1a1a1a" >> $GITHUB_OUTPUT
              ;;
            "gradient-cosmic")
              echo "color=#0a0a2a" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "color=#000000" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Create Enhanced Three.js Viewer
        id: viewer
        uses: ./.github/actions/kamui-modules/threejs-pointcloud-viewer
        with:
          ply-file-path: ${{ steps.pointcloud.outputs.ply-file-path }}
          output-folder: 'docs/immersive-pointcloud-${{ steps.timestamp.outputs.value }}'
          viewer-title: ${{ inputs.viewer-title }}
          camera-position: '0,0,150'
          auto-rotate: ${{ inputs.auto-rotate }}
          background-color: ${{ steps.bg-color.outputs.color }}
          point-size: ${{ inputs.point-size }}
          animation-speed: '1.0'
          music-file: ${{ inputs.enable-music == true && steps.save-music.outputs.music-path || '' }}
          branch-name: 'main'
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Experience Summary
        run: |
          echo "## ðŸŽ¨ Immersive Pointcloud Experience Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Prompt (Original)**: ${{ inputs.image-prompt }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Prompt (English)**: ${{ steps.image-translation.outputs.english-prompt }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Model**: ${{ inputs.image-model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Music Enabled**: ${{ inputs.enable-music }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable-music }}" = "true" ]; then
            echo "- **Music Prompt (Original)**: ${{ inputs.music-prompt }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Music Prompt (English)**: ${{ steps.music-translation.outputs.english-prompt }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Background Style**: ${{ inputs.background-style }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Generated**: ${{ steps.image.outputs.image-completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Music Generated**: ${{ steps.save-music.outputs.music-completed || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pointcloud Generated**: ${{ steps.pointcloud.outputs.pointcloud-completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Viewer Created**: ${{ steps.viewer.outputs.viewer-completed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deployment.conclusion }}" = "success" ]; then
            echo "### ðŸš€ Live Experience" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status**: Successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Experience URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/immersive-pointcloud-${{ steps.timestamp.outputs.value }}/" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed or was skipped" >> $GITHUB_STEP_SUMMARY
          fi