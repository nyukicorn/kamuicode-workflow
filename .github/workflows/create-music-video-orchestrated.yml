name: Create Music Video Orchestrated (Experimental)

on:
  workflow_dispatch:
    inputs:
      music_concept:
        description: 'éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆä¾‹ï¼šé™ã‹ãªå¤œã®ãƒ”ã‚¢ãƒæ›²ï¼‰'
        required: true
        type: string

jobs:
  create-music-video-orchestrated:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Branch
        id: setup
        uses: ./.github/actions/kamui-modules/setup-branch
      
      - name: Music Planning (Intent-to-Prompt)
        id: planning
        uses: ./.github/actions/kamui-modules/music-planning
        with:
          music-concept: ${{ inputs.music_concept }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Music Generation (Intent-to-Prompt)
        id: music
        uses: ./.github/actions/kamui-modules/music-generation
        with:
          music-concept: ${{ inputs.music_concept }}
          music-prompt: ${{ steps.planning.outputs.music-prompt }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}
      
      - name: Music Analysis
        id: analysis
        uses: ./.github/actions/kamui-modules/music-analysis
        with:
          music-concept: ${{ inputs.music_concept }}
          original-image-prompt: ${{ steps.planning.outputs.image-prompt }}
          original-video-prompt: ${{ steps.planning.outputs.video-concept }}
          music-url: ${{ steps.music.outputs.music-url }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Image Generation (Intent-to-Prompt)
        id: image
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Intent-to-Prompt Image Generation"
          echo "Starting experimental image generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          OPTIMIZED_PROMPT="${{ steps.analysis.outputs.image-prompt-1 }}"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Optimized prompt from analysis: $OPTIMIZED_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$IMAGES_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > "$MCP_CONFIG_PATH"
          
          # Setup Node.js and Claude Code SDK
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          npm install @anthropic-ai/claude-code
          
          # Intent-to-Prompt: éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨åˆ†æçµæœã‚’ç·åˆçš„ã«è€ƒæ…®
          SMART_PROMPT="éŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **éŸ³æ¥½åˆ†æã«ã‚ˆã‚‹æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $OPTIMIZED_PROMPT
          
          **ã‚ãªãŸã®åˆ¤æ–­ã§è¡Œã£ã¦ãã ã•ã„**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·åˆçš„ã«åˆ†æ
          2. ã‚ˆã‚Šé­…åŠ›çš„ã§éŸ³æ¥½ã«èª¿å’Œã™ã‚‹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªç”±ã«æ§‹ç¯‰
          3. æ—¥æœ¬èªã®å ´åˆã¯è‹±èªã«ç¿»è¨³ã—ã¦ã‹ã‚‰Imagen4 Fastã§å®Ÿè¡Œ
          4. æŠ€è¡“çš„ãªè©³ç´°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã€URLç®¡ç†ç­‰ï¼‰ã‚‚æœ€é©ãªæ–¹æ³•ã§å®Ÿè¡Œ
          
          **åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«**: Imagen4 Fast MCP, Bash
          **ä¿å­˜å…ˆ**: $IMAGES_DIR/generated-image.png
          **URLä¿å­˜**: $FOLDER_NAME/google-image-url.txt
          
          **é‡è¦**: ã‚ãªãŸã®å‰µé€ æ€§ã¨åˆ¤æ–­åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã€
          éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«æœ€ã‚‚èª¿å’Œã™ã‚‹ç¾ã—ã„ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Intent-to-Prompt Image Generation..."
          
          # Claude Code SDKå®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$SMART_PROMPT" || {
              echo "::error::âŒ Intent-to-Prompt Image generation failed"
              exit 1
            }
          
          # çµæœç¢ºèª
          if [ -f "$FOLDER_NAME/google-image-url.txt" ]; then
            GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url.txt")
            echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            echo "image-completed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Image generation output not found"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Video Generation (Intent-to-Prompt)
        id: video
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¬ Intent-to-Prompt Video Generation"
          echo "Starting experimental video generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          GOOGLE_IMAGE_URL="${{ steps.image.outputs.google-image-url }}"
          OPTIMIZED_VIDEO_PROMPT="${{ steps.analysis.outputs.video-prompt-1 }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Image URL: $GOOGLE_IMAGE_URL"
          echo "Optimized video prompt: $OPTIMIZED_VIDEO_PROMPT"
          
          # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$VIDEOS_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > "$MCP_CONFIG_PATH"
          
          # Intent-to-Prompt: éŸ³æ¥½ã€ç”»åƒã€åˆ†æçµæœã‚’ç·åˆè€ƒæ…®
          SMART_PROMPT="éŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®å‹•ç”»ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”Ÿæˆæ¸ˆã¿ç”»åƒURL**: $GOOGLE_IMAGE_URL
          **éŸ³æ¥½åˆ†æã«ã‚ˆã‚‹æœ€é©åŒ–æ¸ˆã¿å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $OPTIMIZED_VIDEO_PROMPT
          
          **ã‚ãªãŸã®åˆ¤æ–­ã§è¡Œã£ã¦ãã ã•ã„**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€ç”»åƒã®å†…å®¹ã€æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·åˆçš„ã«åˆ†æ
          2. ã‚ˆã‚Šé­…åŠ›çš„ã§ä¸€è²«æ€§ã®ã‚ã‚‹å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªç”±ã«æ§‹ç¯‰
          3. ç”»åƒã¨éŸ³æ¥½ã®èª¿å’Œã‚’æœ€é‡è¦–ã—ãŸå‹•ç”»ã‚’ç”Ÿæˆ
          4. Hailuo-02 Proã§5ç§’ã®é«˜å“è³ªå‹•ç”»ã‚’ä½œæˆ
          5. æŠ€è¡“çš„ãªè©³ç´°ã‚‚æœ€é©ãªæ–¹æ³•ã§å®Ÿè¡Œ
          
          **åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«**: Hailuo-02 Pro MCP, Bash
          **ä¿å­˜å…ˆ**: $VIDEOS_DIR/segment-1.mp4
          
          **é‡è¦**: éŸ³æ¥½ã®é›°å›²æ°—ã¨ç”»åƒã®ç¾ã—ã•ã‚’æœ€å¤§é™ã«æ´»ã‹ã—ã€
          è¦–è´è€…ãŒæ„Ÿå‹•ã™ã‚‹å‹•ç”»ã‚’å‰µé€ ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Intent-to-Prompt Video Generation..."
          
          # Claude Code SDKå®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$SMART_PROMPT" || {
              echo "::error::âŒ Intent-to-Prompt Video generation failed"
              exit 1
            }
          
          # çµæœç¢ºèª
          if [ -f "$VIDEOS_DIR/segment-1.mp4" ]; then
            echo "video-completed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Video generation output not found"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Video Adjustment
        id: adjustment
        uses: ./.github/actions/kamui-modules/video-adjustment
        with:
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          video-prompt-1: ${{ steps.analysis.outputs.video-prompt-1 }}
          video-prompt-2: ${{ steps.analysis.outputs.video-prompt-2 }}
          video-prompt-3: ${{ steps.analysis.outputs.video-prompt-3 }}
      
      - name: Video Concatenation & Music Integration
        id: concatenation
        uses: ./.github/actions/kamui-modules/video-concatenation
        with:
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Summary (Experimental Results)
        run: |
          echo "ğŸ¯ Music Video Creation Summary (ORCHESTRATED VERSION - EXPERIMENTAL):"
          echo "================================================"
          echo "ğŸ“ Concept: ${{ inputs.music_concept }}"
          echo "ğŸŒ¿ Branch: ${{ steps.setup.outputs.branch-name }}"
          echo "ğŸ“ Folder: ${{ steps.setup.outputs.folder-name }}"
          echo ""
          echo "ğŸ§ª EXPERIMENTAL FEATURES USED:"
          echo "  - Intent-to-Prompt Image Generation"
          echo "  - Intent-to-Prompt Video Generation"
          echo "  - Claude Code SDK Autonomous Decision Making"
          echo ""
          echo "âœ… Planning Status: ${{ steps.planning.outputs.planning-completed }}"
          echo "ğŸµ Music Prompt: ${{ steps.planning.outputs.music-prompt }}"
          echo "ğŸ–¼ï¸ Image Prompt: ${{ steps.planning.outputs.image-prompt }}"
          echo ""
          echo "âœ… Music Generation: ${{ steps.music.outputs.music-completed }}"
          echo "ğŸ¶ Music URL: ${{ steps.music.outputs.music-url }}"
          echo ""
          echo "âœ… Music Analysis: ${{ steps.analysis.outputs.analysis-completed }}"
          echo "ğŸ” Optimized Image Prompt: ${{ steps.analysis.outputs.image-prompt-1 }}"
          echo "ğŸ­ Optimized Video Prompt: ${{ steps.analysis.outputs.video-prompt-1 }}"
          echo ""
          echo "ğŸ§ª Intent-to-Prompt Image Generation: ${{ steps.image.outputs.image-completed }}"
          echo "ğŸ–¼ï¸ Google Image URL: ${{ steps.image.outputs.google-image-url }}"
          echo ""
          echo "ğŸ§ª Intent-to-Prompt Video Generation: ${{ steps.video.outputs.video-completed }}"
          echo ""
          echo "âœ… Video Adjustment: ${{ steps.adjustment.outputs.adjustment-completed }}"
          echo "ğŸ­ Adjusted Video Prompts: Generated for 3 segments"
          echo ""
          echo "âœ… Video Concatenation & Music Integration: ${{ steps.concatenation.outputs.concatenation-completed }}"
          echo "ğŸ¬ Final Music Video: ${{ steps.concatenation.outputs.final-video-path }}"
          echo ""
          echo "ğŸ‰ EXPERIMENTAL Music Video Pipeline Success!"
          echo "ğŸ“Š Generated: Music + Analysis + Intent-to-Prompt Image/Video + Final Integration"
          echo "ğŸ§ª Claude Code SDK Autonomous Creativity: ACTIVATED"
          echo "================================================"
      
      - name: Final Status
        run: |
          echo "âœ… Experimental Orchestrated Workflow completed successfully!"
          echo "Branch: ${{ steps.setup.outputs.branch-name }}"
          echo "ğŸ§ª Compare results with standard modular workflow"
          echo "Check the branch for generated files."