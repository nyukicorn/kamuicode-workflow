name: Creative Test Lab v2

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'ä»Šæ—¥è©¦ã—ãŸã„ã“ã¨ï¼ˆä¾‹ï¼šæ–°ã—ã„éŸ³æ¥½MCP + ç”»åƒã§å‹•ç”»ä½œæˆï¼‰'
        required: true
        type: string
      
      mcp_to_test:
        description: 'ãƒ†ã‚¹ãƒˆã—ãŸã„MCPï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
        default: 'auto-detect'
      
      output_type:
        description: 'æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ'
        type: choice
        options:
          - 'auto-detect'
          - 'image'
          - 'video' 
          - 'music'
          - 'threejs-scene'
          - 'mixed-media'
        default: 'auto-detect'
      
      quick_notes:
        description: 'è¿½åŠ ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

jobs:
  run-experiment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup experiment
        id: setup
        run: |
          # å®Ÿé¨“ç”¨ã®ä¸€æ„ãªIDã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          EXPERIMENT_ID="exp-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          
          mkdir -p "$EXPERIMENT_DIR"/{output,logs,config}
          
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
          
          echo "ğŸ§ª å®Ÿé¨“é–‹å§‹: $EXPERIMENT_ID"
      
      - name: Prepare MCP configuration
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          # MCPè¨­å®šã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          if [ -n "$MCP_CONFIG" ]; then
            echo "$MCP_CONFIG" > "$EXPERIMENT_DIR/config/mcp-config.json"
          else
            echo '{"mcpServers":{}}' > "$EXPERIMENT_DIR/config/mcp-config.json"
          fi
      
      - name: Run experiment
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          echo "ğŸš€ å®Ÿé¨“å®Ÿè¡Œä¸­..."
          
          # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p "$EXPERIMENT_DIR/logs"
          
          # å®Ÿé¨“æŒ‡ç¤ºã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}" > "$EXPERIMENT_DIR/instructions.txt"
          echo "æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ: ${{ inputs.output_type }}" >> "$EXPERIMENT_DIR/instructions.txt"
          echo "MCP: ${{ inputs.mcp_to_test }}" >> "$EXPERIMENT_DIR/instructions.txt"
          
          # Claude Codeã¸ã®è©³ç´°ãªæŒ‡ç¤ºã‚’ä½œæˆ
          cat > "$EXPERIMENT_DIR/claude-instructions.txt" << EOF
          ä»¥ä¸‹ã®å®Ÿé¨“ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ: ${{ inputs.output_type }}
          ä½¿ç”¨MCP: ${{ inputs.mcp_to_test }}

          æ‰‹é †:
          1. å®Ÿé¨“å†…å®¹ã‚’åˆ†æã—ã¦é©åˆ‡ãªMCPãƒ„ãƒ¼ãƒ«ã‚’é¸æŠ
          2. ç”»åƒç”Ÿæˆã®å ´åˆã¯ã€ç¾ã—ã„é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆ
          3. ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšä¿å­˜ï¼ˆç”»åƒã®å ´åˆã¯.pngå½¢å¼ã§ï¼‰
          4. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨å†…å®¹ã‚’æ˜ç¢ºã«è¨˜éŒ²
          5. å®Ÿé¨“çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ

          é‡è¦: 
          - å¿…ãšå®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„
          - ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã«ã¯å®Ÿé¨“IDã‚’å«ã‚ã¦ãã ã•ã„
          - å¤±æ•—ã—ãŸå ´åˆã‚‚è©³ç´°ãªãƒ­ã‚°ã‚’æ®‹ã—ã¦ãã ã•ã„

          ä»Šã™ãå®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          EOF

          # Claude Codeã‚’å®Ÿè¡Œ
          echo "Claude Codeå®Ÿè¡Œé–‹å§‹: $(date)"
          timeout 1800 npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/config/mcp-config.json" \
            --message="$(cat $EXPERIMENT_DIR/claude-instructions.txt)" \
            > "$EXPERIMENT_DIR/logs/claude-output.log" 2>&1 || echo "Claude Codeå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ç§»å‹•
          echo "ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
          if ls *.png *.jpg *.jpeg *.mp4 *.mp3 *.wav *.glb *.obj 2>/dev/null; then
            echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ä¸­..."
            mv *.png *.jpg *.jpeg *.mp4 *.mp3 *.wav *.glb *.obj "$EXPERIMENT_DIR/output/" 2>/dev/null || true
          fi
          
          # outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ç¢ºèª
          echo "=== ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ===" | tee -a "$EXPERIMENT_DIR/logs/experiment.log"
          ls -la "$EXPERIMENT_DIR/output/" 2>/dev/null | tee -a "$EXPERIMENT_DIR/logs/experiment.log" || echo "outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          echo "âœ… å®Ÿé¨“å®Œäº†: $(date)"
      
      - name: Save results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          # çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          echo "# å®Ÿé¨“çµæœ: $EXPERIMENT_ID" > "$EXPERIMENT_DIR/README.md"
          echo "" >> "$EXPERIMENT_DIR/README.md"
          echo "## å®Ÿé¨“æ¦‚è¦" >> "$EXPERIMENT_DIR/README.md"
          echo "- **å®Ÿé¨“å†…å®¹**: ${{ inputs.experiment_description }}" >> "$EXPERIMENT_DIR/README.md"
          echo "- **æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**: ${{ inputs.output_type }}" >> "$EXPERIMENT_DIR/README.md"
          echo "- **ä½¿ç”¨MCP**: ${{ inputs.mcp_to_test }}" >> "$EXPERIMENT_DIR/README.md"
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date)" >> "$EXPERIMENT_DIR/README.md"
          echo "- **ãƒ¡ãƒ¢**: ${{ inputs.quick_notes }}" >> "$EXPERIMENT_DIR/README.md"
          echo "" >> "$EXPERIMENT_DIR/README.md"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’è¿½åŠ 
          echo "## ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«" >> "$EXPERIMENT_DIR/README.md"
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A $EXPERIMENT_DIR/output)" ]; then
            echo "```" >> "$EXPERIMENT_DIR/README.md"
            ls -la "$EXPERIMENT_DIR/output/" >> "$EXPERIMENT_DIR/README.md"
            echo "```" >> "$EXPERIMENT_DIR/README.md"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€README.mdã«è¡¨ç¤º
            for img in "$EXPERIMENT_DIR/output"/*.png "$EXPERIMENT_DIR/output"/*.jpg "$EXPERIMENT_DIR/output"/*.jpeg; do
              if [ -f "$img" ]; then
                filename=$(basename "$img")
                echo "" >> "$EXPERIMENT_DIR/README.md"
                echo "### ç”Ÿæˆç”»åƒ: $filename" >> "$EXPERIMENT_DIR/README.md"
                echo "![Generated Image](output/$filename)" >> "$EXPERIMENT_DIR/README.md"
              fi
            done
          else
            echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          echo "" >> "$EXPERIMENT_DIR/README.md"
          echo "## ãƒ­ã‚°" >> "$EXPERIMENT_DIR/README.md"
          if [ -f "$EXPERIMENT_DIR/logs/claude-output.log" ]; then
            echo "Claude Codeå®Ÿè¡Œãƒ­ã‚°:" >> "$EXPERIMENT_DIR/README.md"
            echo "```" >> "$EXPERIMENT_DIR/README.md"
            tail -20 "$EXPERIMENT_DIR/logs/claude-output.log" >> "$EXPERIMENT_DIR/README.md"
            echo "```" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add experiment-results/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ§ª Add experiment results: $EXPERIMENT_ID

å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ: ${{ inputs.output_type }}
MCP: ${{ inputs.mcp_to_test }}

ğŸ¤– Generated with [Claude Code](https://claude.ai/code) via Creative Test Lab"
            git push
          fi