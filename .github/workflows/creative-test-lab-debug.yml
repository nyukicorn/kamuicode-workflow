name: Creative Test Lab Debug

on:
  workflow_dispatch:

jobs:
  debug-mcp:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Debug MCP and Claude
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          echo "ðŸ”§ ç’°å¢ƒæƒ…å ±:"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "PWD: $(pwd)"
          
          echo ""
          echo "ðŸ” ç’°å¢ƒå¤‰æ•°ç¢ºèª:"
          echo "CLAUDE_ACCESS_TOKEN: $([ -n "$CLAUDE_ACCESS_TOKEN" ] && echo 'Set' || echo 'Not set')"
          echo "CLAUDE_REFRESH_TOKEN: $([ -n "$CLAUDE_REFRESH_TOKEN" ] && echo 'Set' || echo 'Not set')"
          echo "CLAUDE_EXPIRES_AT: $([ -n "$CLAUDE_EXPIRES_AT" ] && echo 'Set' || echo 'Not set')"
          echo "MCP_CONFIG: $([ -n "$MCP_CONFIG" ] && echo 'Set' || echo 'Not set')"
          
          echo ""
          echo "ðŸ“¦ claude-codeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±:"
          npm info @anthropic-ai/claude-code version 2>/dev/null || echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±å–å¾—å¤±æ•—"
          
          echo ""
          echo "ðŸ§ª ã‚·ãƒ³ãƒ—ãƒ«ãªClaude Codeå®Ÿè¡Œãƒ†ã‚¹ãƒˆ:"
          echo '{"mcpServers":{}}' > test-mcp.json
          
          # æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆ
          npx @anthropic-ai/claude-code --version || echo "Claude Code ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªå¤±æ•—"
          
          echo ""
          echo "ðŸ“‹ MCPè¨­å®šå†…å®¹ç¢ºèª:"
          if [ -n "$MCP_CONFIG" ]; then
            echo "$MCP_CONFIG" > mcp-config.json
            echo "MCPã‚µãƒ¼ãƒãƒ¼æ•°: $(echo "$MCP_CONFIG" | jq '.mcpServers | length' 2>/dev/null || echo '0')"
            echo "imagen4-fastå­˜åœ¨ç¢ºèª: $(echo "$MCP_CONFIG" | jq '.mcpServers."t2i-fal-imagen4-fast"' 2>/dev/null | head -3)"
          fi
          
          echo ""
          echo "ðŸŽ¯ æœ€å°é™ã®Claude Codeå®Ÿè¡Œ:"
          npx @anthropic-ai/claude-code --non-interactive \
            --message="Hello, can you confirm MCP is working?" \
            2>&1 || echo "åŸºæœ¬å®Ÿè¡Œå¤±æ•—"