name: Create 360Â° Panorama 3JS Experience

on:
  workflow_dispatch:
    inputs:
      panorama_scene:
        description: 'ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³ã®èª¬æ˜ï¼ˆä¾‹ï¼šæ¡œæº€é–‹ã®äº¬éƒ½åº­åœ’ã€å¤•æ–¹ã®æš–ã‹ã„å…‰ï¼‰'
        required: true
        type: string
      music_style:
        description: 'éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¬æ˜ï¼ˆä¾‹ï¼šç©ã‚„ã‹ãªã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ã€è‡ªç„¶ã®éŸ³ã‚’å«ã‚€ï¼‰'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for panorama experience
        id: create-branch
        run: |
          BRANCH_NAME="panorama/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="panorama-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      panorama-prompt: ${{ steps.planning.outputs.panorama-prompt }}
      music-prompt: ${{ steps.planning.outputs.music-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒ‘ãƒãƒ©ãƒ3JSè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ“‹ Panorama 3JS Planning Agent Execution"
          
          # è¨­å®š
          PANORAMA_SCENE="${{ inputs.panorama_scene }}"
          MUSIC_STYLE="${{ inputs.music_style }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          mkdir -p "$PLANNING_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯360åº¦ãƒ‘ãƒãƒ©ãƒ3JSä½“é¨“ã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æŒ‡ç¤ºã‹ã‚‰æœ€é©ãªãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º**:
          - ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³: $PANORAMA_SCENE
          - éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«: $MUSIC_STYLE

          **ã‚¿ã‚¹ã‚¯**:
          1. 360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆï¼ˆã€Œ360 degree panoramic view, equirectangular formatã€ã‚’å«ã‚€ï¼‰
          2. éŸ³æ¥½ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          3. è¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/panorama-plan.mdã€ã«ä¿å­˜
          4. ãƒ‘ãƒãƒ©ãƒç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/panorama-prompt.txtã€ã«ä¿å­˜
          5. éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜

          **é‡è¦**: å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Write,Edit" \
            --max-turns 15 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # çµæœã®ç¢ºèª
          if [ -f "$PLANNING_DIR/panorama-prompt.txt" ]; then
            PANORAMA_PROMPT=$(cat "$PLANNING_DIR/panorama-prompt.txt" | tr '\n' ' ')
            echo "panorama-prompt=$PANORAMA_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Panorama prompt file not found"
            exit 1
          fi
          
          if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
            MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt" | tr '\n' ' ')
            echo "music-prompt=$MUSIC_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Music prompt file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if ! git diff --cached --quiet; then
            git commit -m "Add panorama planning: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  panorama-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      panorama-completed: ${{ steps.panorama.outputs.completed }}
      google-panorama-url: ${{ steps.panorama.outputs.google-panorama-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: 360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: panorama
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸŒ Panorama Generation Agent Execution"
          
          # è¨­å®š
          PLANNED_PANORAMA_PROMPT="${{ needs.planning.outputs.panorama-prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PANORAMA_DIR="$FOLDER_NAME/panorama"
          
          # ãƒ‘ãƒãƒ©ãƒãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          mkdir -p "$PANORAMA_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="Imagen4 Ultraã§360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_PANORAMA_PROMPT

          **æ‰‹é †**:
          1. mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submitã§ç”»åƒç”Ÿæˆé–‹å§‹
          2. mcp__t2i-fal-imagen4-ultra__imagen4_ultra_statusã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          3. mcp__t2i-fal-imagen4-ultra__imagen4_ultra_resultã§çµæœå–å¾—
          4. Google URLã‚’ã€Œ$FOLDER_NAME/google-panorama-url.txtã€ã«ä¿å­˜
          5. Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$PANORAMA_DIR/generated-panorama.jpgã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # çµæœã®ç¢ºèª
          if [ -f "$FOLDER_NAME/google-panorama-url.txt" ]; then
            GOOGLE_URL=$(cat "$FOLDER_NAME/google-panorama-url.txt")
            echo "google-panorama-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Google panorama URL not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push panorama
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if ! git diff --cached --quiet; then
            git commit -m "Add panorama images: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  music-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      music-completed: ${{ steps.music.outputs.completed }}
      google-music-url: ${{ steps.music.outputs.google-music-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: music
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Music Generation Agent Execution"
          
          # è¨­å®š
          PLANNED_MUSIC_PROMPT="${{ needs.planning.outputs.music-prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          # éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          mkdir -p "$MUSIC_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="Google Lyriaã§éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_MUSIC_PROMPT

          **æ‰‹é †**:
          1. mcp__t2m-google-lyria__lyria_submitã§éŸ³æ¥½ç”Ÿæˆé–‹å§‹
          2. mcp__t2m-google-lyria__lyria_statusã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          3. mcp__t2m-google-lyria__lyria_resultã§çµæœå–å¾—
          4. Google URLã‚’ã€Œ$FOLDER_NAME/google-music-url.txtã€ã«ä¿å­˜
          5. Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$MUSIC_DIR/generated-music.wavã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2m-google-lyria__lyria_submit,mcp__t2m-google-lyria__lyria_status,mcp__t2m-google-lyria__lyria_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # çµæœã®ç¢ºèª
          if [ -f "$FOLDER_NAME/google-music-url.txt" ]; then
            GOOGLE_URL=$(cat "$FOLDER_NAME/google-music-url.txt")
            echo "google-music-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Google music URL not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push music
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if ! git diff --cached --quiet; then
            git commit -m "Add music: ${{ inputs.music_style }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  threejs-integration:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, panorama-generation, music-generation]
    permissions:
      contents: write
    outputs:
      integration-completed: ${{ steps.integration.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: 3JSçµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: integration
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸŒ 3JS Integration Agent Execution"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PANORAMA_DIR="$FOLDER_NAME/panorama"
          MUSIC_DIR="$FOLDER_NAME/music"
          THREEJS_DIR="$FOLDER_NAME/3js-experience"
          
          # 3JSãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          mkdir -p "$THREEJS_DIR/assets"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’çµ±åˆã—ãŸ3JSä½“é¨“ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ**:
          - ãƒ‘ãƒãƒ©ãƒç”»åƒ: $PANORAMA_DIRå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«
          - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: $MUSIC_DIRå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«

          **ä½œæˆã™ã‚‹3JSä½“é¨“**:
          1. ãƒ‘ãƒãƒ©ãƒç”»åƒã¨éŸ³æ¥½ã‚’ã€Œ$THREEJS_DIR/assets/ã€ã«ã‚³ãƒ”ãƒ¼
          2. Three.js CDNã‚’ä½¿ç”¨ã—ãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$THREEJS_DIR/index.htmlã€ã«ä½œæˆ
          3. 360åº¦ãƒ‘ãƒãƒ©ãƒè¡¨ç¤ºã€éŸ³æ¥½å†ç”Ÿã€ãƒã‚¦ã‚¹æ“ä½œå¯¾å¿œ
          4. éŸ³æ¥½å†ç”Ÿ/åœæ­¢ãƒœã‚¿ãƒ³ã¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã‚’å®Ÿè£…

          **HTMLã®è¦ä»¶**:
          - Three.jsã§ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’çƒé¢ã«ãƒãƒƒãƒ”ãƒ³ã‚°
          - éŸ³æ¥½ã®å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
          - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
          - ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã§ã®è¦–ç‚¹æ“ä½œ"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # çµæœã®ç¢ºèª
          if [ -f "$THREEJS_DIR/index.html" ]; then
            echo "::notice::âœ… 3JS experience created"
          else
            echo "::error::âŒ 3JS experience HTML not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push 3JS experience
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if ! git diff --cached --quiet; then
            git commit -m "Add 3JS panorama experience: ${{ inputs.panorama_scene }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, panorama-generation, music-generation, threejs-integration]
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ needs.setup-branch.outputs.branch-name }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          
          # æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FOLDER_NAME/"
          
          if ! git diff --cached --quiet; then
            git commit -m "Complete 360Â° Panorama 3JS Experience: ${{ inputs.panorama_scene }}"
            git push origin $BRANCH_NAME
          fi
          
          # PRãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸŒ Claude Code SDK & kamuicode MCPã‚’ä½¿ç”¨ã—ãŸ360åº¦ãƒ‘ãƒãƒ©ãƒ3JSä½“é¨“ã§ã™ã€‚

          **ãƒ‘ãƒãƒ©ãƒã‚·ãƒ¼ãƒ³**: ${{ inputs.panorama_scene }}
          **éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«**: ${{ inputs.music_style }}

          **ç”Ÿæˆãƒ•ãƒ­ãƒ¼**:
          1. ğŸŒ Imagen4 Ultra ã§360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆ
          2. ğŸµ Google Lyria ã§éŸ³æ¥½ç”Ÿæˆ
          3. ğŸŒ Three.js ã§çµ±åˆä½“é¨“æ§‹ç¯‰

          **ä½¿ç”¨æ–¹æ³•**:
          1. \`$FOLDER_NAME/3js-experience/index.html\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
          3. 360åº¦ãƒ‘ãƒãƒ©ãƒä½“é¨“ã‚’æ¥½ã—ã‚€

          ---
          ğŸŒ Generated with Claude Code SDK & kamuicode MCP"
          
          # PRä½œæˆ
          gh pr create \
            --title "æ–°ã—ã„360Â° Panorama 3JS Experience: ${{ inputs.panorama_scene }}" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME