name: Creative Test Lab

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'ä»Šæ—¥è©¦ã—ãŸã„ã“ã¨ï¼ˆä¾‹ï¼šæ–°ã—ã„éŸ³æ¥½MCP + ç”»åƒã§å‹•ç”»ä½œæˆï¼‰'
        required: true
        type: string
      
      mcp_to_test:
        description: 'ãƒ†ã‚¹ãƒˆã—ãŸã„MCPï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
        default: 'auto-detect'
      
      output_type:
        description: 'æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ'
        type: choice
        options:
          - 'auto-detect'
          - 'image'
          - 'video' 
          - 'music'
          - 'threejs-scene'
          - 'mixed-media'
        default: 'auto-detect'
      
      quick_notes:
        description: 'è¿½åŠ ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

jobs:
  setup-experiment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      experiment-id: ${{ steps.setup.outputs.experiment-id }}
      experiment-dir: ${{ steps.setup.outputs.experiment-dir }}
      detected-mcps: ${{ steps.analyze.outputs.detected-mcps }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup experiment environment
        id: setup
        run: |
          # å®Ÿé¨“ç”¨ã®ä¸€æ„ãªIDã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          EXPERIMENT_ID="exp-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          
          mkdir -p "$EXPERIMENT_DIR"/{output,logs,config}
          
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
          
          echo "ğŸ§ª å®Ÿé¨“é–‹å§‹: $EXPERIMENT_ID"
          echo "ğŸ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $EXPERIMENT_DIR"
          
          # å®Ÿé¨“ã®åŸºæœ¬æƒ…å ±ã‚’è¨˜éŒ²
          cat > "$EXPERIMENT_DIR/experiment-info.json" << EOF
          {
            "experiment_id": "$EXPERIMENT_ID",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "description": "${{ inputs.experiment_description }}",
            "mcp_to_test": "${{ inputs.mcp_to_test }}",
            "output_type": "${{ inputs.output_type }}",
            "notes": "${{ inputs.quick_notes }}",
            "status": "started"
          }
          EOF
      
      - name: Analyze experiment requirements
        id: analyze
        run: |
          DESCRIPTION="${{ inputs.experiment_description }}"
          MCP_TO_TEST="${{ inputs.mcp_to_test }}"
          
          echo "ğŸ” å®Ÿé¨“å†…å®¹ã‚’åˆ†æä¸­..."
          echo "èª¬æ˜: $DESCRIPTION"
          
          # å®Ÿé¨“å†…å®¹ã‹ã‚‰å¿…è¦ãªMCPã‚’æ¨æ¸¬
          DETECTED_MCPS=""
          
          if [[ "$DESCRIPTION" =~ [iI]mage|ç”»åƒ ]] || [[ "$MCP_TO_TEST" =~ image|imagen ]]; then
            DETECTED_MCPS="$DETECTED_MCPS,imagen4-fast"
          fi
          
          if [[ "$DESCRIPTION" =~ [mM]usic|éŸ³æ¥½ ]] || [[ "$MCP_TO_TEST" =~ music|lyria ]]; then
            DETECTED_MCPS="$DETECTED_MCPS,google-lyria"
          fi
          
          if [[ "$DESCRIPTION" =~ [vV]ideo|å‹•ç”» ]] || [[ "$MCP_TO_TEST" =~ video|hailuo ]]; then
            DETECTED_MCPS="$DETECTED_MCPS,hailuo-02-pro"
          fi
          
          if [[ "$DESCRIPTION" =~ [tT]hree|3[dD]|3[jJ][sS] ]] || [[ "$MCP_TO_TEST" =~ three|3d ]]; then
            DETECTED_MCPS="$DETECTED_MCPS,threejs-experimental"
          fi
          
          # æœ€åˆã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          DETECTED_MCPS=${DETECTED_MCPS#,}
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆMCPã‚’è¨­å®š
          if [[ -z "$DETECTED_MCPS" ]]; then
            DETECTED_MCPS="imagen4-fast"
          fi
          
          echo "detected-mcps=$DETECTED_MCPS" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æ¤œå‡ºã•ã‚ŒãŸMCP: $DETECTED_MCPS"

  rapid-experiment:
    needs: [setup-experiment]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup MCP configuration
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          EXPERIMENT_DIR="${{ needs.setup-experiment.outputs.experiment-dir }}"
          
          # Secretsã‹ã‚‰åŸºæœ¬è¨­å®šã‚’å–å¾—
          if [ -n "$MCP_CONFIG" ]; then
            echo "ğŸ”§ Secretsã‹ã‚‰MCPè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­..."
            echo "$MCP_CONFIG" > temp-configs/experiment-config.json
            echo "âœ… MCPè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            echo "âŒ MCP_CONFIG secretãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªè¨­å®šã‚’ä½œæˆ
            cat > temp-configs/experiment-config.json << 'EOF'
{
  "mcpServers": {
    "t2i-fal-imagen4-fast": {
      "type": "http",
      "url": "https://mcp-flux-kontext-only-20250716-020022-44f00679-zl3xx5lsaq-uc.a.run.app/t2i/fal/imagen4/fast",
      "description": "Fal.ai Imagen4 Fast Text-to-Image (Speed Optimized)"
    }
  }
}
EOF
            echo "âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆMCPè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™"
          fi
          
          # å®Ÿé¨“ç”¨è¨­å®šã‚’è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          MCP_TO_TEST="${{ inputs.mcp_to_test }}"
          if [[ "$MCP_TO_TEST" == "threejs" ]] || [[ "$MCP_TO_TEST" == "3js" ]]; then
            echo "ğŸ”§ Three.js MCPè¨­å®šã‚’è¿½åŠ ä¸­..."
            # å°†æ¥çš„ã«Three.js MCPè¨­å®šã‚’å‹•çš„ã«è¿½åŠ 
            echo "Three.js MCPè¨­å®šã¯å¾Œã§å®Ÿè£…" >> "$EXPERIMENT_DIR/logs/setup.log"
          fi
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿé¨“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          cp temp-configs/experiment-config.json "$EXPERIMENT_DIR/config/"
          
          # è¨­å®šå†…å®¹ã‚’ç¢ºèªï¼ˆæ©Ÿå¯†æƒ…å ±ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          echo "ğŸ“‹ MCPè¨­å®šã®ç¢ºèª:"
          jq -r '.mcpServers | keys[]' "$EXPERIMENT_DIR/config/experiment-config.json" || echo "JSONè§£æã‚¨ãƒ©ãƒ¼"
      
      - name: Execute rapid experiment
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          EXPERIMENT_DIR="${{ needs.setup-experiment.outputs.experiment-dir }}"
          DETECTED_MCPS="${{ needs.setup-experiment.outputs.detected-mcps }}"
          
          echo "::group::ğŸš€ å®Ÿé¨“å®Ÿè¡Œä¸­"
          echo "é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          echo "ä½¿ç”¨MCP: $DETECTED_MCPS"
          
          # å®Ÿé¨“å®Ÿè¡Œã®ãƒ­ã‚°ã‚’é–‹å§‹
          exec 1> >(tee -a "$EXPERIMENT_DIR/logs/experiment.log")
          exec 2> >(tee -a "$EXPERIMENT_DIR/logs/error.log")
          
          # Claude Codeã¸ã®æŒ‡ç¤ºå†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > "$EXPERIMENT_DIR/claude-instructions.txt" << EOF
          å®Ÿé¨“ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
          å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ: ${{ inputs.output_type }}
          ä½¿ç”¨äºˆå®šMCP: $DETECTED_MCPS
          
          ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿé¨“ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          1. å®Ÿé¨“å†…å®¹ã‚’åˆ†æ
          2. é©åˆ‡ãªMCPã‚’é¸æŠ
          3. åŸºæœ¬çš„ãªã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ç”Ÿæˆ
          4. çµæœã‚’ $EXPERIMENT_DIR/output/ ã«ä¿å­˜
          5. ç°¡å˜ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
          
          å“è³ªã‚ˆã‚Šã‚‚ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã€ã¨ã«ã‹ãä½•ã‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          å¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚
          EOF
          
          # Claude Code ã‚’ä½¿ç”¨ã—ã¦å®Ÿé¨“ã‚’å®Ÿè¡Œ
          timeout 1800 npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/config/experiment-config.json" \
            --message="$(cat $EXPERIMENT_DIR/claude-instructions.txt)" \
            || echo "å®Ÿé¨“ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ã¾ã—ãŸ" >> "$EXPERIMENT_DIR/logs/error.log"
          
          echo "çµ‚äº†æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          echo "::endgroup::"
      
      - name: Package experiment results
        run: |
          EXPERIMENT_DIR="${{ needs.setup-experiment.outputs.experiment-dir }}"
          EXPERIMENT_ID="${{ needs.setup-experiment.outputs.experiment-id }}"
          
          echo "ğŸ“¦ å®Ÿé¨“çµæœã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸­..."
          
          # å®Ÿé¨“å®Œäº†æƒ…å ±ã‚’æ›´æ–°
          jq '.status = "completed" | .completed_at = now | .completed_at_iso = (now | strftime("%Y-%m-%dT%H:%M:%SZ"))' \
            "$EXPERIMENT_DIR/experiment-info.json" > "$EXPERIMENT_DIR/experiment-info.json.tmp"
          mv "$EXPERIMENT_DIR/experiment-info.json.tmp" "$EXPERIMENT_DIR/experiment-info.json"
          
          # å®Ÿé¨“çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          cat > "$EXPERIMENT_DIR/README.md" << EOF
          # å®Ÿé¨“çµæœ: $EXPERIMENT_ID
          
          ## å®Ÿé¨“æ¦‚è¦
          - **å®Ÿé¨“ID**: $EXPERIMENT_ID
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          - **å®Ÿé¨“å†…å®¹**: ${{ inputs.experiment_description }}
          - **ä½¿ç”¨MCP**: ${{ needs.setup-experiment.outputs.detected-mcps }}
          - **æœŸå¾…ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**: ${{ inputs.output_type }}
          
          ## å®Ÿé¨“çµæœ
          
          ### ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          EOF
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A "$EXPERIMENT_DIR/output")" ]; then
            echo "- ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> "$EXPERIMENT_DIR/README.md"
            ls -la "$EXPERIMENT_DIR/output/" >> "$EXPERIMENT_DIR/README.md"
          else
            echo "- ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ãªã—" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # å®Ÿé¨“çµæœã‚’åœ§ç¸®
          cd experiment-results
          zip -r "${EXPERIMENT_ID}-results.zip" "$EXPERIMENT_ID/"
          
          # å®Ÿé¨“ãƒ­ã‚°ã‚’ experiments/README.md ã«è¿½åŠ 
          cat >> ../experiments/README.md << EOF
          
          ### $(date +%Y-%m-%d)
          - å®Ÿé¨“: ${{ inputs.experiment_description }}
          - MCP: ${{ needs.setup-experiment.outputs.detected-mcps }}
          - çµæœ: å®Ÿè¡Œå®Œäº†
          - ãƒ•ã‚¡ã‚¤ãƒ«: experiment-results/${EXPERIMENT_ID}-results.zip
          - æ‰€è¦æ™‚é–“: ç´„30åˆ†
          - æ¬¡å›: çµæœã‚’ç¢ºèªã—ã¦æ¬¡ã®å®Ÿé¨“ã‚’è¨ˆç”»
          - ãƒ¡ãƒ¢: ${{ inputs.quick_notes }}
          EOF
          
          echo "âœ… å®Ÿé¨“å®Œäº†ï¼çµæœã¯ experiment-results/${EXPERIMENT_ID}/ ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨: experiment-results/${EXPERIMENT_ID}-results.zip"
      
      - name: Upload experiment results
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ needs.setup-experiment.outputs.experiment-id }}
          path: experiment-results/${{ needs.setup-experiment.outputs.experiment-id }}-results.zip
          retention-days: 30
      
      - name: Commit experiment results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add experiment-results/
          git add experiments/README.md
          git add temp-configs/
          
          if git diff --cached --quiet; then
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "Add experiment results: ${{ needs.setup-experiment.outputs.experiment-id }}

          å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          ä½¿ç”¨MCP: ${{ needs.setup-experiment.outputs.detected-mcps }}
          
          ğŸ§ª Generated with Creative Test Lab
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi
      
      - name: Cleanup temporary files
        run: |
          # ä¸€æ™‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f temp-configs/experiment-config.json
          echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
      
      - name: Experiment summary
        run: |
          EXPERIMENT_ID="${{ needs.setup-experiment.outputs.experiment-id }}"
          echo "::notice::ğŸ‰ å®Ÿé¨“å®Œäº†: $EXPERIMENT_ID"
          echo "::notice::ğŸ“‹ å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}"
          echo "::notice::ğŸ”§ ä½¿ç”¨MCP: ${{ needs.setup-experiment.outputs.detected-mcps }}"
          echo "::notice::ğŸ“ çµæœ: experiment-results/${EXPERIMENT_ID}/"
          echo "::notice::ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: Actions ã® Artifacts ã‹ã‚‰å–å¾—å¯èƒ½"
          echo "::notice::ğŸš€ æ¬¡å›: çµæœã‚’ç¢ºèªã—ã¦ã‚¢ãƒ¼ãƒˆå·¥æˆ¿ã§ã®æœ¬æ ¼åˆ¶ä½œã‚’æ¤œè¨"