name: 'Music Video Creation - Multi Image Test'

on:
  workflow_dispatch:
    inputs:
      music_concept:
        description: 'éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ (ä¾‹: ç¾ã—ã„ãƒãƒ©ã®èŠ±æŸ)'
        required: true
        default: 'ç¾ã—ã„ãƒãƒ©ã®èŠ±æŸ'
      image_count:
        description: 'ç”Ÿæˆã™ã‚‹ç”»åƒã®æšæ•° (1-10)'
        required: false
        default: '3'
      models:
        description: 'ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ« (auto/imagen4-ultra/imagen4-fast/flux-schnell)'
        required: false
        default: 'auto'
      enable_comparison:
        description: 'ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        default: 'false'

jobs:
  create-multi-image-music-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Branch
        id: setup
        uses: ./.github/actions/kamui-modules/setup-branch
        
      - name: Music Planning (Intent-to-Prompt)
        id: planning
        uses: ./.github/actions/kamui-modules/music-planning
        with:
          music-concept: ${{ inputs.music_concept }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Music Generation (Intent-to-Prompt)
        id: music
        uses: ./.github/actions/kamui-modules/music-generation
        with:
          music-prompt: ${{ steps.planning.outputs.music-prompt }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Music Analysis
        id: analysis
        uses: ./.github/actions/kamui-modules/music-analysis
        with:
          original-image-prompt: ${{ steps.planning.outputs.image-prompt }}
          original-video-prompt: ${{ steps.planning.outputs.video-concept }}
          music-url: ${{ steps.music.outputs.music-url }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Multi Image Generation ğŸ¨
        id: image
        uses: ./.github/actions/kamui-modules/image-generation-multi
        with:
          image-prompt: "${{ steps.analysis.outputs.image-prompt-1 }}"
          image-count: ${{ inputs.image_count }}
          models: ${{ inputs.models }}
          enable-comparison: ${{ inputs.enable_comparison }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}

      - name: Video Generation (Intent-to-Prompt)
        id: video
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¬ Video Generation with Multi Images"
          echo "Starting video generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT='${{ inputs.music_concept }}'
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          GOOGLE_IMAGE_URL="${{ steps.image.outputs.google-image-url }}"
          OPTIMIZED_VIDEO_PROMPT="${{ steps.analysis.outputs.video-prompt-1 }}"
          IMAGE_COUNT="${{ steps.image.outputs.images-completed }}"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Generated images: $IMAGE_COUNT"
          echo "First image URL: $GOOGLE_IMAGE_URL"
          echo "Optimized video prompt: $OPTIMIZED_VIDEO_PROMPT"
          
          # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$VIDEOS_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > "$MCP_CONFIG_PATH"
          
          # Setup Node.js and Claude Code SDK
          echo "ğŸ”§ Installing Node.js and npm..."
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y nodejs npm > /dev/null 2>&1
          echo "âœ… Node.js and npm installed successfully"
          
          echo "ğŸ“¦ Installing Claude Code SDK..."
          npm install @anthropic-ai/claude-code
          echo "âœ… Claude Code SDK ready"
          
          # ãƒãƒ«ãƒç”»åƒå¯¾å¿œã®ãƒ“ãƒ‡ã‚ªç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          SMART_PROMPT="ãƒãƒ«ãƒç”»åƒéŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®å‹•ç”»ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”Ÿæˆæ¸ˆã¿ç”»åƒæ•°**: $IMAGE_COUNTæš
          **ãƒ¡ã‚¤ãƒ³ç”»åƒURL**: $GOOGLE_IMAGE_URL
          **æœ€é©åŒ–æ¸ˆã¿å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $OPTIMIZED_VIDEO_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨è¤‡æ•°ç”»åƒã‚’è€ƒæ…®ã—ãŸé­…åŠ›çš„ãªå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
          2. ãƒ¡ã‚¤ãƒ³ç”»åƒã‚’ä½¿ç”¨ã—ã¦i2v-fal-hailuo-02-proã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
          3. ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–å¾…æ©Ÿå‡¦ç†ã§çµæœã‚’å–å¾—
          4. å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜: '$VIDEOS_DIR/segment-1.mp4'ã«ä¿å­˜
          
          **é‡è¦**: è¤‡æ•°ç”»åƒãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚ˆã‚Šè±Šã‹ãªè¡¨ç¾ã®å‹•ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"

          echo "ğŸš€ Starting Multi-Image Video Generation..."
          
          # Claude Code SDKå®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$SMART_PROMPT" || {
              echo "::error::âŒ Video generation failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Auto-Generate Web Player & Deploy ğŸŒ
        id: web-player
        uses: ./.github/actions/kamui-modules/web-player-generation
        with:
          folder-name: ${{ steps.setup.outputs.folder-name }}
          music-concept: ${{ inputs.music_concept }}
          branch-name: main
          image-count: ${{ steps.image.outputs.images-completed }}

      - name: Summary
        run: |
          echo "ğŸ¯ Multi-Image Music Video Creation Summary:"
          echo "Music Concept: ${{ inputs.music_concept }}"
          echo "Images Generated: ${{ steps.image.outputs.images-completed }}"
          echo "Models Used: ${{ steps.image.outputs.models-used }}"
          echo "Web Player: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.setup.outputs.folder-name }}/"
          
          if [ "${{ inputs.enable_comparison }}" == "true" ]; then
            echo "Comparison Report: ${{ steps.image.outputs.comparison-report }}"
          fi