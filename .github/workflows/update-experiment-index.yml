name: Update Experiment Index

on:
  workflow_run:
    workflows: ["Creative Test Lab"]
    types: [completed]
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶çš„ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°'
        type: boolean
        default: false

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Update experiment index
        run: |
          echo "ğŸ“Š å®Ÿé¨“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ä¸­..."
          
          # å®Ÿé¨“çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
          EXPERIMENT_RESULTS_DIR="experiment-results"
          INDEX_FILE="$EXPERIMENT_RESULTS_DIR/index.md"
          
          if [ ! -d "$EXPERIMENT_RESULTS_DIR" ]; then
            echo "å®Ÿé¨“çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # å®Ÿé¨“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          TOTAL_EXPERIMENTS=$(find "$EXPERIMENT_RESULTS_DIR" -maxdepth 1 -type d -name "exp-*" | wc -l)
          
          # æˆåŠŸãƒ»å¤±æ•—ã®å®Ÿé¨“ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          SUCCESS_COUNT=0
          FAILURE_COUNT=0
          
          # MCPä½¿ç”¨é »åº¦ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          declare -A MCP_USAGE
          MCP_USAGE["imagen4-fast"]=0
          MCP_USAGE["google-lyria"]=0
          MCP_USAGE["hailuo-02-pro"]=0
          MCP_USAGE["threejs-experimental"]=0
          
          # å‡ºåŠ›ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          declare -A OUTPUT_TYPES
          OUTPUT_TYPES["image"]=0
          OUTPUT_TYPES["video"]=0
          OUTPUT_TYPES["music"]=0
          OUTPUT_TYPES["threejs-scene"]=0
          OUTPUT_TYPES["mixed-media"]=0
          
          # å®Ÿé¨“çµæœã‚’åˆ†æ
          for experiment_dir in "$EXPERIMENT_RESULTS_DIR"/exp-*; do
            if [ -d "$experiment_dir" ]; then
              experiment_name=$(basename "$experiment_dir")
              
              # å®Ÿé¨“æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
              if [ -f "$experiment_dir/experiment-info.json" ]; then
                # æˆåŠŸãƒ»å¤±æ•—ã®åˆ¤å®š
                if [ -d "$experiment_dir/output" ] && [ "$(ls -A "$experiment_dir/output")" ]; then
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  status="âœ… æˆåŠŸ"
                else
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
                  status="âŒ å¤±æ•—"
                fi
                
                # JSONã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                description=$(jq -r '.description // "N/A"' "$experiment_dir/experiment-info.json")
                output_type=$(jq -r '.output_type // "auto-detect"' "$experiment_dir/experiment-info.json")
                timestamp=$(jq -r '.timestamp // "N/A"' "$experiment_dir/experiment-info.json")
                
                # MCPä½¿ç”¨é »åº¦ã‚’æ›´æ–°ï¼ˆç°¡æ˜“çš„ãªå®Ÿè£…ï¼‰
                if [[ "$description" =~ [iI]mage|ç”»åƒ ]]; then
                  MCP_USAGE["imagen4-fast"]=$((${MCP_USAGE["imagen4-fast"]} + 1))
                fi
                if [[ "$description" =~ [mM]usic|éŸ³æ¥½ ]]; then
                  MCP_USAGE["google-lyria"]=$((${MCP_USAGE["google-lyria"]} + 1))
                fi
                if [[ "$description" =~ [vV]ideo|å‹•ç”» ]]; then
                  MCP_USAGE["hailuo-02-pro"]=$((${MCP_USAGE["hailuo-02-pro"]} + 1))
                fi
                if [[ "$description" =~ [tT]hree|3[dD]|3[jJ][sS] ]]; then
                  MCP_USAGE["threejs-experimental"]=$((${MCP_USAGE["threejs-experimental"]} + 1))
                fi
                
                # å‡ºåŠ›ã‚¿ã‚¤ãƒ—ã®æ›´æ–°
                case "$output_type" in
                  "image") OUTPUT_TYPES["image"]=$((${OUTPUT_TYPES["image"]} + 1)) ;;
                  "video") OUTPUT_TYPES["video"]=$((${OUTPUT_TYPES["video"]} + 1)) ;;
                  "music") OUTPUT_TYPES["music"]=$((${OUTPUT_TYPES["music"]} + 1)) ;;
                  "threejs-scene") OUTPUT_TYPES["threejs-scene"]=$((${OUTPUT_TYPES["threejs-scene"]} + 1)) ;;
                  *) OUTPUT_TYPES["mixed-media"]=$((${OUTPUT_TYPES["mixed-media"]} + 1)) ;;
                esac
                
                # å®Ÿé¨“å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
                experiment_date=$(date -d "$timestamp" +"%Y-%m-%d" 2>/dev/null || echo "Unknown")
                echo "- **$experiment_name** ($experiment_date): $description - $status" >> temp_experiments.md
              fi
            fi
          done
          
          # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          cat > "$INDEX_FILE" << 'EOF'
# å®Ÿé¨“çµæœã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Ÿé¨“çµæœã®ç´¢å¼•ã¨ã—ã¦è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚

## æœ€æ–°ã®å®Ÿé¨“

EOF
          
          # æœ€æ–°ã®å®Ÿé¨“ã‚’è¿½åŠ 
          if [ -f temp_experiments.md ]; then
            tail -10 temp_experiments.md >> "$INDEX_FILE"
          else
            echo "*ã¾ã å®Ÿé¨“çµæœãŒã‚ã‚Šã¾ã›ã‚“*" >> "$INDEX_FILE"
          fi
          
          cat >> "$INDEX_FILE" << EOF

---

## å®Ÿé¨“çµæœã®è¦‹æ–¹

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
\`\`\`
exp-YYYYMMDD-HHMMSS/
â”œâ”€â”€ experiment-info.json    # å®Ÿé¨“ã®åŸºæœ¬æƒ…å ±
â”œâ”€â”€ README.md              # å®Ÿé¨“çµæœãƒ¬ãƒãƒ¼ãƒˆ
â”œâ”€â”€ output/                # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ images/           # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ videos/           # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ audio/            # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â””â”€â”€ scenes/           # Three.jsç­‰ã®ã‚·ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ logs/                  # å®Ÿè¡Œãƒ­ã‚°
â”‚   â”œâ”€â”€ experiment.log    # å®Ÿé¨“å®Ÿè¡Œãƒ­ã‚°
â”‚   â””â”€â”€ error.log         # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
â””â”€â”€ config/               # ä½¿ç”¨ã—ãŸè¨­å®š
    â””â”€â”€ experiment-config.json
\`\`\`

### å®Ÿé¨“çµæœã®è©•ä¾¡

å„å®Ÿé¨“ã¯ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã•ã‚Œã¾ã™ï¼š

#### æŠ€è¡“çš„æˆåŠŸåº¦
- âœ… **å®Œå…¨æˆåŠŸ**: æœŸå¾…é€šã‚Šã®çµæœãŒå¾—ã‚‰ã‚ŒãŸ
- âš ï¸ **éƒ¨åˆ†æˆåŠŸ**: ä¸€éƒ¨ã®æ©Ÿèƒ½ãŒå‹•ä½œã—ãŸ
- âŒ **å¤±æ•—**: æœŸå¾…ã—ãŸçµæœãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸ

#### å‰µä½œã¸ã®å¿œç”¨å¯èƒ½æ€§
- ğŸ¨ **ã‚¢ãƒ¼ãƒˆå·¥æˆ¿å€™è£œ**: é«˜å“è³ªãªä½œå“åˆ¶ä½œã«ä½¿ç”¨å¯èƒ½
- ğŸ”§ **æ”¹è‰¯å¿…è¦**: èª¿æ•´ã™ã‚Œã°ä½¿ç”¨å¯èƒ½
- ğŸš« **ä½¿ç”¨å›°é›£**: ç¾çŠ¶ã§ã¯å‰µä½œã«é©ã•ãªã„

#### å®Ÿé¨“ã®ç¨®é¡
- ğŸ§ª **æ–°MCPæ¤œè¨¼**: æ–°ã—ã„MCPã‚µãƒ¼ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆ
- ğŸ”„ **çµ„ã¿åˆã‚ã›å®Ÿé¨“**: è¤‡æ•°MCPã®çµ„ã¿åˆã‚ã›ãƒ†ã‚¹ãƒˆ
- ğŸ¯ **ç‰¹å®šæ©Ÿèƒ½æ¤œè¨¼**: ç‰¹å®šã®æ©Ÿèƒ½ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ
- ğŸ’¡ **ã‚¢ã‚¤ãƒ‡ã‚¢å®Ÿé¨“**: æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã®æ¤œè¨¼

---

## çµ±è¨ˆæƒ…å ±

### å®Ÿé¨“å›æ•°
- ç·å®Ÿé¨“æ•°: $TOTAL_EXPERIMENTS
- æˆåŠŸå®Ÿé¨“: $SUCCESS_COUNT
- å¤±æ•—å®Ÿé¨“: $FAILURE_COUNT

### MCPä½¿ç”¨é »åº¦
- imagen4-fast: ${MCP_USAGE["imagen4-fast"]}å›
- google-lyria: ${MCP_USAGE["google-lyria"]}å›
- hailuo-02-pro: ${MCP_USAGE["hailuo-02-pro"]}å›
- threejs-experimental: ${MCP_USAGE["threejs-experimental"]}å›

### å‡ºåŠ›ã‚¿ã‚¤ãƒ—åˆ¥
- ç”»åƒ: ${OUTPUT_TYPES["image"]}å›
- å‹•ç”»: ${OUTPUT_TYPES["video"]}å›
- éŸ³æ¥½: ${OUTPUT_TYPES["music"]}å›
- Three.js: ${OUTPUT_TYPES["threejs-scene"]}å›
- æ··åˆãƒ¡ãƒ‡ã‚£ã‚¢: ${OUTPUT_TYPES["mixed-media"]}å›

*çµ±è¨ˆã¯å®Ÿé¨“å®Ÿè¡Œæ™‚ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™*

---

## å®Ÿé¨“å±¥æ­´

EOF
          
          # å…¨å®Ÿé¨“å±¥æ­´ã‚’è¿½åŠ 
          if [ -f temp_experiments.md ]; then
            cat temp_experiments.md >> "$INDEX_FILE"
          else
            echo "### 2025-01-17" >> "$INDEX_FILE"
            echo "- å®Ÿé¨“çµæœè¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–" >> "$INDEX_FILE"
            echo "- Creative Test Lab ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æº–å‚™" >> "$INDEX_FILE"
            echo "- æœ€åˆã®å®Ÿé¨“å®Ÿè¡Œã‚’å¾…æ©Ÿä¸­" >> "$INDEX_FILE"
          fi
          
          cat >> "$INDEX_FILE" << 'EOF'

---

## ä»Šå¾Œã®äºˆå®š

### çŸ­æœŸç›®æ¨™ï¼ˆ1é€±é–“ï¼‰
- [ ] æœ€åˆã®å®Ÿé¨“å®Ÿè¡Œ
- [ ] åŸºæœ¬çš„ãªMCPã®å‹•ä½œç¢ºèª
- [ ] å®Ÿé¨“çµæœã®è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰

### ä¸­æœŸç›®æ¨™ï¼ˆ1ãƒ¶æœˆï¼‰
- [ ] 10å›ä»¥ä¸Šã®å®Ÿé¨“å®Ÿè¡Œ
- [ ] æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š
- [ ] ã‚¢ãƒ¼ãƒˆå·¥æˆ¿ã¸ã®ç§»è¡Œæº–å‚™

### é•·æœŸç›®æ¨™ï¼ˆ3ãƒ¶æœˆï¼‰
- [ ] å®Ÿé¨“çµæœã®è‡ªå‹•åˆ†æ
- [ ] æ¨å¥¨å®Ÿé¨“ã®è‡ªå‹•ææ¡ˆ
- [ ] å®Ÿé¨“ã‹ã‚‰ã‚¢ãƒ¼ãƒˆã¸ã®è‡ªå‹•ç§»è¡Œ

---

## æ³¨æ„äº‹é …

1. **å®Ÿé¨“çµæœã®ä¿å­˜æœŸé–“**: 30æ—¥é–“ï¼ˆGitHub Actions artifactsï¼‰
2. **æ‰‹å‹•å‰Šé™¤ã®ç¦æ­¢**: å®Ÿé¨“çµæœã¯è‡ªå‹•ç®¡ç†ã•ã‚Œã¾ã™
3. **æ©Ÿå¯†æƒ…å ±ã®æ³¨æ„**: å®Ÿé¨“çµæœã«å€‹äººæƒ…å ±ã‚’å«ã‚ãªã„ã§ãã ã•ã„
4. **å®¹é‡åˆ¶é™**: å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•åœ§ç¸®ã•ã‚Œã¾ã™

---

*ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Creative Test Lab ã«ã‚ˆã£ã¦è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™*  
EOF
          
          echo "*æœ€çµ‚æ›´æ–°: $(date +%Y-%m-%d)*" >> "$INDEX_FILE"
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f temp_experiments.md
          
          echo "âœ… å®Ÿé¨“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          echo "ğŸ“Š ç·å®Ÿé¨“æ•°: $TOTAL_EXPERIMENTS"
          echo "âœ… æˆåŠŸå®Ÿé¨“: $SUCCESS_COUNT"
          echo "âŒ å¤±æ•—å®Ÿé¨“: $FAILURE_COUNT"
      
      - name: Commit updated index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add experiment-results/index.md
          
          if git diff --cached --quiet; then
            echo "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "Update experiment results index

          ğŸ“Š çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
          - ç·å®Ÿé¨“æ•°: $(find experiment-results -maxdepth 1 -type d -name "exp-*" | wc -l)
          - æœ€çµ‚æ›´æ–°: $(date +%Y-%m-%d)
          
          ğŸ¤– Generated by Update Experiment Index
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi
          
          echo "ğŸ“ˆ å®Ÿé¨“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°å®Œäº†"