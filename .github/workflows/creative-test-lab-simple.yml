name: Creative Test Lab Simple

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: '今日試したいこと（例：新しい音楽MCP + 画像で動画作成）'
        required: true
        type: string
      
      output_type:
        description: '期待するアウトプット'
        type: choice
        options:
          - 'image'
          - 'video' 
          - 'music'
          - 'mixed-media'
        default: 'image'

jobs:
  experiment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup
        id: setup
        run: |
          EXPERIMENT_ID="exp-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          mkdir -p "$EXPERIMENT_DIR"/{output,logs}
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
      
      - name: Prepare MCP
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          if [ -n "$MCP_CONFIG" ]; then
            echo "$MCP_CONFIG" > "$EXPERIMENT_DIR/mcp-config.json"
          else
            echo '{"mcpServers":{}}' > "$EXPERIMENT_DIR/mcp-config.json"
          fi
      
      - name: Run Claude Code
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          # Create instruction file
          echo "実験を実行してください。" > instruction.txt
          echo "内容: ${{ inputs.experiment_description }}" >> instruction.txt
          echo "アウトプット: ${{ inputs.output_type }}" >> instruction.txt
          echo "画像を生成して保存してください。" >> instruction.txt
          
          # Run Claude Code
          npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/mcp-config.json" \
            --message="$(cat instruction.txt)" || true
          
          # Move generated files
          ls *.png *.jpg 2>/dev/null && mv *.png *.jpg "$EXPERIMENT_DIR/output/" || true
      
      - name: Save results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          echo "# 実験結果: $EXPERIMENT_ID" > "$EXPERIMENT_DIR/README.md"
          echo "実験内容: ${{ inputs.experiment_description }}" >> "$EXPERIMENT_DIR/README.md"
          echo "日時: $(date)" >> "$EXPERIMENT_DIR/README.md"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add experiment-results/
          git diff --cached --quiet || git commit -m "Experiment: $EXPERIMENT_ID" && git push