name: Debug OAuth Authentication

on:
  workflow_dispatch:

jobs:
  debug-oauth:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Debug OAuth Environment Variables
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          echo "=== Environment Variables Check ==="
          echo "CLAUDE_ACCESS_TOKEN set: ${CLAUDE_ACCESS_TOKEN:+YES}"
          echo "CLAUDE_REFRESH_TOKEN set: ${CLAUDE_REFRESH_TOKEN:+YES}"
          echo "CLAUDE_EXPIRES_AT set: ${CLAUDE_EXPIRES_AT:+YES}"
          
          echo "=== Claude CLI Version ==="
          npx @anthropic-ai/claude-code --version
          
          echo "=== Claude CLI Help ==="
          npx @anthropic-ai/claude-code --help | head -20
          
          echo "=== Test Simple Claude CLI Call ==="
          echo "Testing with minimal prompt..."
          npx @anthropic-ai/claude-code --print -p "Hello, respond with just 'Hello back'" || echo "CLI call failed"