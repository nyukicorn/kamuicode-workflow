name: Creative Test Lab Fixed

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'å®Ÿé¨“å†…å®¹ï¼ˆä¾‹ï¼šæ¡œã®é¢¨æ™¯ç”»åƒã‚’ä½œã£ã¦ï¼‰'
        required: true
        type: string

jobs:
  phase1-fixed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup experiment
        id: setup
        run: |
          EXPERIMENT_ID="fixed-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          mkdir -p "$EXPERIMENT_DIR"/{output,logs}
          mkdir -p .claude
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
          echo "ðŸ§ª Phase 1 Fixed ãƒ†ã‚¹ãƒˆé–‹å§‹: $EXPERIMENT_ID"
      
      - name: Prepare MCP config
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > .claude/mcp-kamuicode.json
          
          echo "âœ… MCPè¨­å®šã‚’ .claude/mcp-kamuicode.json ã«ä¿å­˜"
          echo "ðŸ“Š MCPè¨­å®šç¢ºèª:"
          jq -r '.mcpServers | keys[]' .claude/mcp-kamuicode.json | head -5 || echo "JSONè§£æžã‚¨ãƒ©ãƒ¼"
      
      - name: Test imagen4-fast with MCP
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          DESCRIPTION="${{ inputs.experiment_description }}"
          
          echo "ðŸš€ imagen4-fastç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆé–‹å§‹"
          echo "ðŸ“ æ—¥æœ¬èªžæŒ‡ç¤º: $DESCRIPTION"
          
          # è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›
          if [[ "$DESCRIPTION" =~ æ¡œ ]]; then
            ENGLISH_PROMPT="Beautiful cherry blossoms in full bloom, spring landscape, pink petals, high quality"
          elif [[ "$DESCRIPTION" =~ ãƒãƒ”ãƒ¼|èŠ± ]]; then
            ENGLISH_PROMPT="Beautiful poppy flower field, vibrant red poppies, colorful garden landscape, high quality"
          else
            ENGLISH_PROMPT="Beautiful landscape artwork, natural scenery, high quality, detailed"
          fi
          
          echo "ðŸ”„ è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGLISH_PROMPT"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ðŸ“‹ MCPè¨­å®šãƒ‘ã‚¹: $MCP_CONFIG_ABS_PATH"
          echo "âœ… MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª: $([ -f "$MCP_CONFIG_ABS_PATH" ] && echo 'OK' || echo 'NG')"
          
          # Claude Codeå®Ÿè¡Œï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãï¼‰
          echo "ðŸ¤– Claude Code + MCPå®Ÿè¡Œé–‹å§‹..."
          
          PROMPT="ä»¥ä¸‹ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          **ä½¿ç”¨ãƒ„ãƒ¼ãƒ«**: imagen4-fast
          **ç”»åƒã®èª¬æ˜Ž**: $ENGLISH_PROMPT

          æ‰‹é †:
          1. ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
          2. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_result\`ã§çµæžœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. ç”»åƒURLã‚’ä½¿ç”¨ã—ã¦Bashã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: curl -L -o generated-image.png [URL]
          6. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®å­˜åœ¨ç¢ºèª

          **é‡è¦**: 
          - MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã«ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
          - ç”Ÿæˆã•ã‚ŒãŸç”»åƒURLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ generated-image.png ã«ã—ã¦ãã ã•ã„"
          
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 10 \
            --verbose \
            --permission-mode "acceptAll" \
            -p "$PROMPT" \
            > "$EXPERIMENT_DIR/logs/claude-output.log" 2>&1
          
          EXIT_CODE=$?
          echo "ðŸ“Š Claude Codeçµ‚äº†ã‚³ãƒ¼ãƒ‰: $EXIT_CODE"
          
          # ãƒ­ã‚°å†…å®¹ã‚’è¡¨ç¤º
          echo "ðŸ“‹ Claude Codeå®Ÿè¡Œãƒ­ã‚°ï¼ˆæœ€å¾Œã®30è¡Œï¼‰:"
          tail -30 "$EXPERIMENT_DIR/logs/claude-output.log" || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # çµæžœç¢ºèª
          if ls *.png *.jpg 2>/dev/null; then
            echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸï¼"
            mv *.png *.jpg "$EXPERIMENT_DIR/output/" 2>/dev/null || true
            echo "generated=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "generated=false" >> $GITHUB_OUTPUT
          fi
          
          ls -la "$EXPERIMENT_DIR/output/" || echo "outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
      
      - name: Save results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          # ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          cat > "$EXPERIMENT_DIR/README.md" << EOF
          # ðŸ§ª Phase 1 Fixed ãƒ†ã‚¹ãƒˆçµæžœ: $EXPERIMENT_ID
          
          ## å®Ÿé¨“æ¦‚è¦
          - **å®Ÿé¨“å†…å®¹**: ${{ inputs.experiment_description }}
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date)
          - **ä½¿ç”¨MCP**: imagen4-fast
          - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.generate.outputs.generated == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
          
          ## ç”Ÿæˆçµæžœ
          EOF
          
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A $EXPERIMENT_DIR/output)" ]; then
            for img in "$EXPERIMENT_DIR/output"/*; do
              if [ -f "$img" ]; then
                filename=$(basename "$img")
                echo "### ðŸ–¼ï¸ ç”Ÿæˆç”»åƒ: $filename" >> "$EXPERIMENT_DIR/README.md"
                echo "![Generated Image](output/$filename)" >> "$EXPERIMENT_DIR/README.md"
              fi
            done
          else
            echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # Git commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add experiment-results/
          git diff --cached --quiet || git commit -m "Phase 1 Fixed: $EXPERIMENT_ID - MCP imagen4-fast test" && git push