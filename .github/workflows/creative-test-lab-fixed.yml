name: Creative Test Lab

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'ãƒ†ã‚¹ãƒˆã—ãŸã„å®Ÿé¨“å†…å®¹'
        required: true
        type: string
      
      mcp_to_test:
        description: 'ãƒ†ã‚¹ãƒˆã™ã‚‹MCP'
        required: false
        type: string
        default: 'imagen4-fast'
      
      output_type:
        description: 'æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ'
        type: choice
        options:
          - 'image'
          - 'video'
          - 'music'
          - 'mixed-media'
        default: 'image'

jobs:
  experiment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup experiment
        run: |
          echo "ğŸ§ª å®Ÿé¨“é–‹å§‹"
          echo "å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}"
          echo "ä½¿ç”¨MCP: ${{ inputs.mcp_to_test }}"
          echo "å‡ºåŠ›ã‚¿ã‚¤ãƒ—: ${{ inputs.output_type }}"
          
          # å®Ÿé¨“ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          EXPERIMENT_ID="exp-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/$EXPERIMENT_ID"
          
          mkdir -p "$EXPERIMENT_DIR"/{output,logs,config}
          
          echo "å®Ÿé¨“ID: $EXPERIMENT_ID"
          echo "EXPERIMENT_ID=$EXPERIMENT_ID" >> $GITHUB_ENV
          echo "EXPERIMENT_DIR=$EXPERIMENT_DIR" >> $GITHUB_ENV
      
      - name: Setup MCP configuration
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          # Secretsã‹ã‚‰åŸºæœ¬è¨­å®šã‚’å–å¾—
          if [ -n "$MCP_CONFIG" ]; then
            echo "ğŸ”§ Secretsã‹ã‚‰MCPè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­..."
            echo "$MCP_CONFIG" > temp-configs/experiment-config.json
            echo "âœ… MCPè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            echo "âŒ MCP_CONFIG secretãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªè¨­å®šã‚’ä½œæˆ
            mkdir -p temp-configs
            cat > temp-configs/experiment-config.json << 'EOF'
{
  "mcpServers": {
    "t2i-fal-imagen4-fast": {
      "type": "http",
      "url": "https://mcp-flux-kontext-only-20250716-020022-44f00679-zl3xx5lsaq-uc.a.run.app/t2i/fal/imagen4/fast",
      "description": "Fal.ai Imagen4 Fast Text-to-Image (Speed Optimized)"
    }
  }
}
EOF
            echo "âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆMCPè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™"
          fi
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿé¨“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          cp temp-configs/experiment-config.json "$EXPERIMENT_DIR/config/"
      
      - name: Execute experiment
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          echo "ğŸš€ å®Ÿé¨“å®Ÿè¡Œä¸­"
          
          # å®Ÿé¨“å®Ÿè¡Œã®ãƒ­ã‚°ã‚’é–‹å§‹
          exec 1> >(tee -a "$EXPERIMENT_DIR/logs/experiment.log")
          exec 2> >(tee -a "$EXPERIMENT_DIR/logs/error.log")
          
          # Claude Code ã‚’ä½¿ç”¨ã—ã¦å®Ÿé¨“ã‚’å®Ÿè¡Œ
          timeout 1800 npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/config/experiment-config.json" \
            --message="å®Ÿé¨“ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
          å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ: ${{ inputs.output_type }}
          ä½¿ç”¨äºˆå®šMCP: ${{ inputs.mcp_to_test }}
          
          ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿé¨“ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          1. å®Ÿé¨“å†…å®¹ã‚’åˆ†æ
          2. é©åˆ‡ãªMCPã‚’é¸æŠ
          3. åŸºæœ¬çš„ãªã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ç”Ÿæˆ
          4. çµæœã‚’ $EXPERIMENT_DIR/output/ ã«ä¿å­˜
          5. ç°¡å˜ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
          
          å“è³ªã‚ˆã‚Šã‚‚ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã€ã¨ã«ã‹ãä½•ã‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          å¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚" \
            || echo "å®Ÿé¨“ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ã¾ã—ãŸ" >> "$EXPERIMENT_DIR/logs/error.log"
          
          echo "å®Ÿé¨“å®Ÿè¡Œå®Œäº†"
      
      - name: Create experiment report
        run: |
          # å®Ÿé¨“çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          cat > "$EXPERIMENT_DIR/README.md" << EOF
          # å®Ÿé¨“çµæœ: $EXPERIMENT_ID
          
          ## å®Ÿé¨“æ¦‚è¦
          - **å®Ÿé¨“ID**: $EXPERIMENT_ID
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          - **å®Ÿé¨“å†…å®¹**: ${{ inputs.experiment_description }}
          - **ä½¿ç”¨MCP**: ${{ inputs.mcp_to_test }}
          - **æœŸå¾…ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**: ${{ inputs.output_type }}
          
          ## å®Ÿé¨“çµæœ
          
          ### ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          EOF
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A "$EXPERIMENT_DIR/output")" ]; then
            echo "- ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> "$EXPERIMENT_DIR/README.md"
            ls -la "$EXPERIMENT_DIR/output/" >> "$EXPERIMENT_DIR/README.md"
          else
            echo "- ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ãªã—" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          echo "ğŸ“‹ å®Ÿé¨“ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ env.EXPERIMENT_ID }}
          path: experiment-results/${{ env.EXPERIMENT_ID }}/
          retention-days: 30
      
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add experiment-results/
          git add experiments/
          
          if git diff --cached --quiet; then
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "Add experiment results: $EXPERIMENT_ID

          å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          ä½¿ç”¨MCP: ${{ inputs.mcp_to_test }}
          
          ğŸ§ª Generated with Creative Test Lab
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi
          
          echo "ğŸ‰ å®Ÿé¨“å®Œäº†: $EXPERIMENT_ID"