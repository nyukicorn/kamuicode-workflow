name: Create Music Video Orchestrated v3 (Auto-Web)

on:
  workflow_dispatch:
    inputs:
      music_concept:
        description: 'éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆä¾‹ï¼šé™ã‹ãªå¤œã®ãƒ”ã‚¢ãƒæ›²ï¼‰'
        required: true
        type: string

jobs:
  create-music-video-orchestrated:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Branch
        id: setup
        uses: ./.github/actions/kamui-modules/setup-branch
      
      - name: Music Planning (Intent-to-Prompt)
        id: planning
        uses: ./.github/actions/kamui-modules/music-planning
        with:
          music-concept: ${{ inputs.music_concept }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Music Generation (Intent-to-Prompt)
        id: music
        uses: ./.github/actions/kamui-modules/music-generation
        with:
          music-concept: ${{ inputs.music_concept }}
          music-prompt: ${{ steps.planning.outputs.music-prompt }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}
      
      - name: Music Analysis
        id: analysis
        uses: ./.github/actions/kamui-modules/music-analysis
        with:
          music-concept: ${{ inputs.music_concept }}
          original-image-prompt: ${{ steps.planning.outputs.image-prompt }}
          original-video-prompt: ${{ steps.planning.outputs.video-concept }}
          music-url: ${{ steps.music.outputs.music-url }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Image Generation (Intent-to-Prompt)
        id: image
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Intent-to-Prompt Image Generation"
          echo "Starting experimental image generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT='${{ inputs.music_concept }}'
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          OPTIMIZED_PROMPT="${{ steps.analysis.outputs.image-prompt-1 }}"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Optimized prompt from analysis: $OPTIMIZED_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$IMAGES_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > "$MCP_CONFIG_PATH"
          
          # Setup Node.js and Claude Code SDK (optimized for minimal logs)
          echo "ğŸ”§ Installing Node.js and npm..."
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y nodejs npm > /dev/null 2>&1
          echo "âœ… Node.js and npm installed successfully"
          
          echo "ğŸ“¦ Installing Claude Code SDK..."
          npm install @anthropic-ai/claude-code
          echo "âœ… Claude Code SDK ready"
          
          # Intent-to-Prompt: éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨åˆ†æçµæœã‚’ç·åˆçš„ã«è€ƒæ…®
          SMART_PROMPT="éŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **éŸ³æ¥½åˆ†æã«ã‚ˆã‚‹æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $OPTIMIZED_PROMPT
          
          **ã‚ãªãŸã®åˆ¤æ–­ã§è¡Œã£ã¦ãã ã•ã„**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·åˆçš„ã«åˆ†æ
          2. ã‚ˆã‚Šé­…åŠ›çš„ã§éŸ³æ¥½ã«èª¿å’Œã™ã‚‹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªç”±ã«æ§‹ç¯‰
          3. æ—¥æœ¬èªã®å ´åˆã¯è‹±èªã«ç¿»è¨³ã—ã¦ã‹ã‚‰Imagen4 Fastã§å®Ÿè¡Œ
          4. æŠ€è¡“çš„ãªè©³ç´°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã€URLç®¡ç†ç­‰ï¼‰ã‚‚æœ€é©ãªæ–¹æ³•ã§å®Ÿè¡Œ
          
          **åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«**: Imagen4 Fast MCP, Bash
          
          **ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜è¦ç´„ï¼ˆå¿…é ˆéµå®ˆï¼‰**:
          1. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: å¿…ãšã€Œ$IMAGES_DIR/generated-image.pngã€ã«ä¿å­˜
          2. URLè¨˜éŒ²: å¿…ãšã€Œ$FOLDER_NAME/google-image-url.txtã€ã«ä¿å­˜
          3. ä¿å­˜ç¢ºèª: ä¿å­˜å¾Œã€å¿…ãšã€Œls -la [filepath]ã€ã§ç¢ºèª
          4. ãƒ­ã‚°å‡ºåŠ›: ã€Œecho 'Saved: [filepath]'ã€ã§ä¿å­˜æˆåŠŸã‚’è¨˜éŒ²
          
          **é‡è¦**: 
          - ä¸Šè¨˜ã®ä¿å­˜å ´æ‰€ã¯å³å¯†ã«å®ˆã‚‹ã“ã¨ï¼ˆä»–ã®å ´æ‰€ã¸ã®ä¿å­˜ç¦æ­¢ï¼‰
          - ã‚ãªãŸã®å‰µé€ æ€§ã¨åˆ¤æ–­åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã€éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«æœ€ã‚‚èª¿å’Œã™ã‚‹ç¾ã—ã„ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Intent-to-Prompt Image Generation..."
          
          # Claude Code SDKå®Ÿè¡Œï¼ˆè©³ç´°ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$SMART_PROMPT" 2>&1 | tee image_execution.log || {
              EXIT_CODE=$?
              echo "::error::âŒ Image generation failed with exit code: $EXIT_CODE"
              echo "::group::Image Generation Error Details"
              tail -50 image_execution.log || echo "No execution log available"
              echo "::endgroup::"
              
              # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®å¯¾å‡¦
              if grep -q "rate limit\|quota\|limit exceeded" image_execution.log; then
                echo "::warning::ğŸš« Rate limit detected. Consider retry after delay."
              elif grep -q "timeout\|timed out" image_execution.log; then
                echo "::warning::â° Timeout detected. Consider increasing max-turns or reducing complexity."
              elif grep -q "MCP\|mcp__" image_execution.log; then
                echo "::error::ğŸ”Œ MCP connection issue detected. Check MCP server status."
              elif grep -q "authentication\|auth\|token" image_execution.log; then
                echo "::error::ğŸ”‘ Authentication issue detected. Check CLAUDE_CODE_OAUTH_TOKEN."
              fi
              
              exit $EXIT_CODE
            }
          
          # çµæœç¢ºèªï¼ˆæ¨™æº–åŒ–ã•ã‚ŒãŸå ´æ‰€ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼‰
          IMAGE_URL_FILE="$FOLDER_NAME/google-image-url.txt"
          IMAGE_FILE="$IMAGES_DIR/generated-image.png"
          
          # URLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$IMAGE_URL_FILE" ]; then
            GOOGLE_URL=$(cat "$IMAGE_URL_FILE")
            echo "âœ… Found image URL file: $IMAGE_URL_FILE"
            echo "Image URL: $GOOGLE_URL"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -f "$IMAGE_FILE" ]; then
              IMAGE_SIZE=$(ls -lah "$IMAGE_FILE" | awk '{print $5}')
              echo "âœ… Found image file: $IMAGE_FILE (Size: $IMAGE_SIZE)"
            else
              echo "âš ï¸ Image file not found at expected location: $IMAGE_FILE"
            fi
            
            echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            echo "image-completed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Image generation failed - URL file not found at standard location"
            echo "Expected location: $IMAGE_URL_FILE"
            echo ""
            echo "Debugging information:"
            echo "Current directory: $(pwd)"
            echo "Folder contents:"
            ls -la "$FOLDER_NAME" || echo "Folder not found"
            echo "Images directory contents:"
            ls -la "$IMAGES_DIR" || echo "Images directory not found"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Video Generation (Intent-to-Prompt)
        id: video
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¬ Intent-to-Prompt Video Generation"
          echo "Starting experimental video generation at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT='${{ inputs.music_concept }}'
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          GOOGLE_IMAGE_URL="${{ steps.image.outputs.google-image-url }}"
          OPTIMIZED_VIDEO_PROMPT="${{ steps.analysis.outputs.video-prompt-1 }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Image URL: $GOOGLE_IMAGE_URL"
          echo "Optimized video prompt: $OPTIMIZED_VIDEO_PROMPT"
          
          # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$VIDEOS_DIR"
          
          # MCPè¨­å®š
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > "$MCP_CONFIG_PATH"
          
          # Intent-to-Prompt: éŸ³æ¥½ã€ç”»åƒã€åˆ†æçµæœã‚’ç·åˆè€ƒæ…®
          SMART_PROMPT="éŸ³æ¥½ãƒ“ãƒ‡ã‚ªã®å‹•ç”»ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”Ÿæˆæ¸ˆã¿ç”»åƒURL**: $GOOGLE_IMAGE_URL
          **éŸ³æ¥½åˆ†æã«ã‚ˆã‚‹æœ€é©åŒ–æ¸ˆã¿å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $OPTIMIZED_VIDEO_PROMPT
          
          **å³å¯†ãªå®Ÿè¡Œæ‰‹é †ï¼ˆå¿…ãšé †ç•ªé€šã‚Šã«å®Ÿè¡Œï¼‰**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€ç”»åƒã®å†…å®¹ã€æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·åˆçš„ã«åˆ†æ
          2. ã‚ˆã‚Šé­…åŠ›çš„ã§ä¸€è²«æ€§ã®ã‚ã‚‹å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªç”±ã«æ§‹ç¯‰
          3. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
          4. **ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–å¾…æ©Ÿå‡¦ç†**: Bashãƒ„ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®å¾…æ©Ÿæˆ¦ç•¥ã‚’å®Ÿè¡Œ
             - åˆå›: 30ç§’å¾…æ©Ÿï¼ˆé«˜é€Ÿå‡¦ç†ã®å ´åˆï¼‰
             - 2-3å›ç›®: 60ç§’å¾…æ©Ÿï¼ˆé€šå¸¸å‡¦ç†ï¼‰
             - 4-6å›ç›®: 90ç§’å¾…æ©Ÿï¼ˆå‡¦ç†é…å»¶æ™‚ï¼‰
             - 7å›ç›®ä»¥é™: 120ç§’å¾…æ©Ÿï¼ˆæœ€å¤§å¾…æ©Ÿï¼‰
          5. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œcompletedã€ã§ãªã„å ´åˆã€ä¸Šè¨˜ã®å¾…æ©Ÿæˆ¦ç•¥ã§å†ç¢ºèªï¼ˆæœ€å¤§10å›ã¾ã§ï¼‰
          7. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_result\`ã§çµæœå–å¾—
          8. **é‡è¦**: å–å¾—ã—ãŸå‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/segment-1.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
          9. **é‡è¦**: å®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªï¼ˆls ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªï¼‰
          10. ç”Ÿæˆå®Œäº†ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          
          **ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–å¾…æ©Ÿæˆ¦ç•¥ã®è©³ç´°**:
          - å¾…æ©Ÿæ™‚é–“é…åˆ—: [30, 60, 60, 90, 90, 90, 120, 120, 120, 120] ç§’
          - åˆè¨ˆæœ€å¤§å¾…æ©Ÿæ™‚é–“: ç´„13åˆ†30ç§’ï¼ˆå¾“æ¥æ¯”20%çŸ­ç¸®ï¼‰
          - é«˜é€Ÿå‡¦ç†ã§ã®æ—©æœŸå®Œäº†ã‚’å„ªå…ˆã€æ®µéšçš„ã«å¾…æ©Ÿæ™‚é–“ã‚’å»¶é•·
          - æœ€å¤§è©¦è¡Œå›æ•°: 10å›ï¼ˆå¾“æ¥ã¨åŒã˜ï¼‰
          - å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå¾Œã€å³åº§ã«æ¬¡ã®å‡¦ç†ã¾ãŸã¯å¾…æ©Ÿåˆ¤å®š
          
          **å¿…é ˆã®ãƒ•ã‚¡ã‚¤ãƒ«åè¦å‰‡**:
          - å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«å: å¿…ãšã€Œsegment-1.mp4ã€ã¨ã™ã‚‹ï¼ˆä»–ã®åå‰ã¯ä½¿ç”¨ç¦æ­¢ï¼‰
          - ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: å¿…ãšã€Œ$VIDEOS_DIRã€ã¨ã™ã‚‹
          
          **åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«**: Hailuo-02 Pro MCP, Bash
          **ä¿å­˜å…ˆï¼ˆå³å¯†ã«å¾“ã†ã“ã¨ï¼‰**: $VIDEOS_DIR/segment-1.mp4
          
          **é‡è¦**: éŸ³æ¥½ã®é›°å›²æ°—ã¨ç”»åƒã®ç¾ã—ã•ã‚’æœ€å¤§é™ã«æ´»ã‹ã—ã€
          è¦–è´è€…ãŒæ„Ÿå‹•ã™ã‚‹å‹•ç”»ã‚’å‰µé€ ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Intent-to-Prompt Video Generation..."
          
          # Claude Code SDKå®Ÿè¡Œï¼ˆè©³ç´°ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$SMART_PROMPT" 2>&1 | tee video_execution.log || {
              EXIT_CODE=$?
              echo "::error::âŒ Video generation failed with exit code: $EXIT_CODE"
              echo "::group::Video Generation Error Details"
              tail -50 video_execution.log || echo "No execution log available"
              echo "::endgroup::"
              
              # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®å¯¾å‡¦ï¼ˆå‹•ç”»ç”Ÿæˆç‰¹æœ‰ã®ã‚¨ãƒ©ãƒ¼ã‚‚å«ã‚€ï¼‰
              if grep -q "rate limit\|quota\|limit exceeded" video_execution.log; then
                echo "::warning::ğŸš« Rate limit detected. Video generation may need longer delays."
              elif grep -q "timeout\|timed out" video_execution.log; then
                echo "::warning::â° Timeout detected. Video processing takes 3-5 minutes typically."
              elif grep -q "queue\|queued\|processing" video_execution.log; then
                echo "::warning::ğŸ”„ Video still processing. May need additional wait time."
              elif grep -q "MCP\|mcp__" video_execution.log; then
                echo "::error::ğŸ”Œ MCP connection issue detected. Check Hailuo-02 Pro server status."
              elif grep -q "image.*not found\|invalid.*url" video_execution.log; then
                echo "::error::ğŸ–¼ï¸ Image URL issue detected. Check image generation step."
              elif grep -q "authentication\|auth\|token" video_execution.log; then
                echo "::error::ğŸ”‘ Authentication issue detected. Check CLAUDE_CODE_OAUTH_TOKEN."
              fi
              
              exit $EXIT_CODE
            }
          
          # çµæœç¢ºèª
          if [ -f "$VIDEOS_DIR/segment-1.mp4" ]; then
            echo "video-completed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Video generation output not found"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Commit and push generated files (after video)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.setup.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit"
          else
            git commit -m "Add generated files (orchestrated): images and videos"
            git push origin ${{ steps.setup.outputs.branch-name }}
          fi
      
      - name: Video Adjustment
        id: adjustment
        uses: ./.github/actions/kamui-modules/video-adjustment
        with:
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          video-prompt-1: ${{ steps.analysis.outputs.video-prompt-1 }}
          video-prompt-2: ${{ steps.analysis.outputs.video-prompt-2 }}
          video-prompt-3: ${{ steps.analysis.outputs.video-prompt-3 }}
      
      - name: Video Concatenation & Music Integration
        id: concatenation
        shell: bash
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¬ Video Concatenation & Music Integration Agent"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          MUSIC_DIR="$FOLDER_NAME/music"
          OUTPUT_DIR="$FOLDER_NAME/final"
          
          echo "Folder name: $FOLDER_NAME"
          echo "Videos directory: $VIDEOS_DIR"
          echo "Music directory: $MUSIC_DIR"
          echo "Output directory: $OUTPUT_DIR"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          if [ ! -d "$OUTPUT_DIR" ]; then
            mkdir -p "$OUTPUT_DIR"
            echo "ğŸ“ Created output folder: $OUTPUT_DIR"
          fi
          
          # å‹•ç”»ã¨éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“ Checking video segments..."
          if [ -d "$VIDEOS_DIR" ]; then
            ls -la "$VIDEOS_DIR"
          else
            echo "âŒ Videos directory not found: $VIDEOS_DIR"
            exit 1
          fi
          
          echo "ğŸ“ Checking music files..."
          if [ -d "$MUSIC_DIR" ]; then
            ls -la "$MUSIC_DIR"
          else
            echo "âŒ Music directory not found: $MUSIC_DIR"
            exit 1
          fi
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨å½¢å¼ç‰¹å®š
          MUSIC_FILE=""
          if [ -f "$MUSIC_DIR/generated-music.mp3" ]; then
            MUSIC_FILE="$MUSIC_DIR/generated-music.mp3"
            echo "âœ… Found music file: $MUSIC_FILE"
          elif [ -f "$MUSIC_DIR/generated-music.wav" ]; then
            MUSIC_FILE="$MUSIC_DIR/generated-music.wav"
            echo "âœ… Found music file: $MUSIC_FILE"
          else
            echo "âŒ Music file not found! Checking all audio files in $MUSIC_DIR..."
            FOUND_MUSIC=$(find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
            if [ -n "$FOUND_MUSIC" ]; then
              MUSIC_FILE="$FOUND_MUSIC"
              echo "âœ… Found alternative music file: $MUSIC_FILE"
            else
              echo "âŒ No audio files found in $MUSIC_DIR"
              exit 1
            fi
          fi
          
          # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          VIDEO_COUNT=$(find "$VIDEOS_DIR" -name "segment-*.mp4" | wc -l)
          echo "ğŸ“¹ Found $VIDEO_COUNT video segments"
          
          if [ "$VIDEO_COUNT" -eq 0 ]; then
            echo "âŒ No video segments found"
            exit 1
          fi
          
          # çµ¶å¯¾ãƒ‘ã‚¹ã®å–å¾—ï¼ˆç’°å¢ƒä¾å­˜æ€§ã‚’æ’é™¤ï¼‰
          ABS_MUSIC_FILE=$(readlink -f "$MUSIC_FILE" 2>/dev/null || echo "$(cd "$(dirname "$MUSIC_FILE")" && pwd)/$(basename "$MUSIC_FILE")")
          ABS_VIDEOS_DIR=$(readlink -f "$VIDEOS_DIR" 2>/dev/null || echo "$(cd "$VIDEOS_DIR" && pwd)")
          ABS_OUTPUT_DIR=$(readlink -f "$OUTPUT_DIR" 2>/dev/null || echo "$(cd "$OUTPUT_DIR" && pwd)")
          ABS_FINAL_VIDEO="$ABS_OUTPUT_DIR/final-music-video.mp4"
          
          echo "Absolute paths:"
          echo "Music file: $ABS_MUSIC_FILE"
          echo "Videos dir: $ABS_VIDEOS_DIR"
          echo "Output dir: $ABS_OUTPUT_DIR"
          echo "Final video: $ABS_FINAL_VIDEO"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰ï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ä½¿ç”¨ï¼‰
          PROMPT="éŸ³æ¥½ã¨å‹•ç”»ã‚’çµ±åˆã—ã¦æœ€çµ‚çš„ãªéŸ³æ¥½ãƒ“ãƒ‡ã‚ªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **é‡è¦**: å…¨ã¦ã®ãƒ‘ã‚¹ã¯ä»¥ä¸‹ã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

          **ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ï¼‰**:
          - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: $ABS_MUSIC_FILE
          - å‹•ç”»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $ABS_VIDEOS_DIR
          - æœ€çµ‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: $ABS_FINAL_VIDEO

          **å¿…é ˆå®Ÿè¡Œæ‰‹é †ï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰**:
          1. ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª: pwd
          2. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã¨å½¢å¼ã‚’ç¢ºèª:
             - ls -la \"$ABS_MUSIC_FILE\"
             - ffprobe -v quiet -show_format \"$ABS_MUSIC_FILE\" || echo \"éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯å¤±æ•—\"
          3. å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:
             - ls -la \"$ABS_VIDEOS_DIR\"/*.mp4
             - VIDEO_COUNT=\$(find \"$ABS_VIDEOS_DIR\" -name \"segment-*.mp4\" | wc -l)
             - echo \"å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°: \$VIDEO_COUNT\"
          4. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª:
             - mkdir -p \"$ABS_OUTPUT_DIR\"
             - test -w \"$ABS_OUTPUT_DIR\" || echo \"å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ›¸ãè¾¼ã¿æ¨©é™ãªã—\"
          5. ffmpegå®Ÿè¡Œï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ä½¿ç”¨ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰:

          **1ã¤ã®å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆ**:
          \`\`\`bash
          cd \"$ABS_VIDEOS_DIR\"
          if ffmpeg -stream_loop -1 -i segment-1.mp4 -i \"$ABS_MUSIC_FILE\" \\
            -c:v libx264 -c:a aac -shortest -y \"$ABS_FINAL_VIDEO\"; then
            echo \"å‹•ç”»ä½œæˆæˆåŠŸ\"
          else
            echo \"å‹•ç”»ä½œæˆå¤±æ•—: \$?\"
          fi
          \`\`\`

          **è¤‡æ•°ã®å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆ**:
          \`\`\`bash
          cd \"$ABS_VIDEOS_DIR\"
          ls -1 *.mp4 | sed 's/^/file /' > filelist.txt
          if ffmpeg -f concat -safe 0 -i filelist.txt -c copy concatenated.mp4; then
            if ffmpeg -stream_loop -1 -i concatenated.mp4 -i \"$ABS_MUSIC_FILE\" \\
              -c:v libx264 -c:a aac -shortest -y \"$ABS_FINAL_VIDEO\"; then
              echo \"å‹•ç”»ä½œæˆæˆåŠŸ\"
            else
              echo \"éŸ³æ¥½çµåˆå¤±æ•—: \$?\"
            fi
          else
            echo \"å‹•ç”»é€£çµå¤±æ•—: \$?\"
          fi
          \`\`\`

          6. çµæœã®è©³ç´°æ¤œè¨¼:
             - ls -la \"$ABS_FINAL_VIDEO\"
             - ffprobe -v quiet -show_streams \"$ABS_FINAL_VIDEO\"
             - echo \"æœ€çµ‚å‹•ç”»ä½œæˆå®Œäº†\"

          **ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å¿œ**: å„ã‚¹ãƒ†ãƒƒãƒ—ã§å¤±æ•—ã—ãŸå ´åˆã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¾ãªã„ã§ãã ã•ã„ã€‚"
          
          # å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ”§ Installing required tools..."
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y ffmpeg nodejs npm > /dev/null 2>&1
          echo "âœ… FFmpeg, Node.js, and npm installed"
          
          echo "ğŸ“¦ Installing Claude Code SDK..."
          npm install @anthropic-ai/claude-code > /dev/null 2>&1
          echo "âœ… Claude Code SDK ready"
          
          echo "ğŸš€ Starting Video Concatenation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # æœ€çµ‚å‹•ç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ¬ Checking final music video..."
          FINAL_VIDEO="$OUTPUT_DIR/final-music-video.mp4"
          
          if [ -f "$FINAL_VIDEO" ]; then
            echo "âœ… Final music video created: $FINAL_VIDEO"
            FILE_SIZE=$(ls -lah "$FINAL_VIDEO" | awk '{print $5}')
            echo "File size: $FILE_SIZE"
            
            # éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ç¢ºèª
            echo "ğŸ”Š Checking audio stream..."
            if command -v ffmpeg &> /dev/null; then
              AUDIO_STREAMS=$(ffmpeg -i "$FINAL_VIDEO" -hide_banner -f null - 2>&1 | grep "Stream.*Audio" | wc -l)
              if [ "$AUDIO_STREAMS" -gt 0 ]; then
                echo "âœ… Audio stream detected in final video"
              else
                echo "âš ï¸ No audio stream detected in final video"
              fi
            fi
            
            echo "final-video-path=$FINAL_VIDEO" >> $GITHUB_OUTPUT
            echo "concatenation-completed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Final music video not created"
            echo "Checking output directory contents:"
            ls -la "$OUTPUT_DIR" || echo "Output directory is empty"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Auto-Generate Web Player & Deploy
        id: web-player
        uses: ./.github/actions/kamui-modules/web-player-generation
        with:
          folder-name: ${{ steps.setup.outputs.folder-name }}
          music-concept: ${{ inputs.music_concept }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          execution-time: "${{ github.event.created_at }} - $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
      - name: Ensure final video is copied to docs
        shell: bash
        run: |
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          
          echo "ğŸ¬ Ensuring final video is copied to docs folder..."
          
          # finalãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã€docsã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -d "$FOLDER_NAME/final" ]; then
            if [ ! -d "docs/$FOLDER_NAME/final" ]; then
              echo "ğŸ“ Final directory not found in docs, copying now..."
              mkdir -p "docs/$FOLDER_NAME"
              cp -r "$FOLDER_NAME/final" "docs/$FOLDER_NAME/"
              echo "âœ… Final directory copied to docs/$FOLDER_NAME/final"
            else
              echo "âœ… Final directory already exists in docs"
            fi
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            echo "Final files in docs:"
            ls -la "docs/$FOLDER_NAME/final/" || echo "No files found in final directory"
          else
            echo "âš ï¸ Final directory not found: $FOLDER_NAME/final"
          fi
      
      - name: Commit and push final music video
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.setup.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No final video to commit"
          else
            git commit -m "Add final music video with integrated audio"
            git push origin ${{ steps.setup.outputs.branch-name }}
          fi
      
      - name: Summary (Experimental Results)
        run: |
          echo "ğŸ¯ Music Video Creation Summary (ORCHESTRATED VERSION - EXPERIMENTAL):"
          echo "================================================"
          echo "ğŸ“ Concept: ${{ inputs.music_concept }}"
          echo "ğŸŒ¿ Branch: ${{ steps.setup.outputs.branch-name }}"
          echo "ğŸ“ Folder: ${{ steps.setup.outputs.folder-name }}"
          echo ""
          echo "ğŸ§ª EXPERIMENTAL FEATURES USED:"
          echo "  - Intent-to-Prompt Image Generation"
          echo "  - Intent-to-Prompt Video Generation"
          echo "  - Claude Code SDK Autonomous Decision Making"
          echo ""
          echo "âœ… Planning Status: ${{ steps.planning.outputs.planning-completed }}"
          echo "ğŸµ Music Prompt: ${{ steps.planning.outputs.music-prompt }}"
          echo "ğŸ–¼ï¸ Image Prompt: ${{ steps.planning.outputs.image-prompt }}"
          echo ""
          echo "âœ… Music Generation: ${{ steps.music.outputs.music-completed }}"
          echo "ğŸ¶ Music URL: ${{ steps.music.outputs.music-url }}"
          echo ""
          echo "âœ… Music Analysis: ${{ steps.analysis.outputs.analysis-completed }}"
          echo "ğŸ” Optimized Image Prompt: ${{ steps.analysis.outputs.image-prompt-1 }}"
          echo "ğŸ­ Optimized Video Prompt: ${{ steps.analysis.outputs.video-prompt-1 }}"
          echo ""
          echo "ğŸ§ª Intent-to-Prompt Image Generation: ${{ steps.image.outputs.image-completed }}"
          echo "ğŸ–¼ï¸ Google Image URL: ${{ steps.image.outputs.google-image-url }}"
          echo ""
          echo "ğŸ§ª Intent-to-Prompt Video Generation: ${{ steps.video.outputs.video-completed }}"
          echo ""
          echo "âœ… Video Adjustment: ${{ steps.adjustment.outputs.adjustment-completed }}"
          echo "ğŸ­ Adjusted Video Prompts: Generated for 3 segments"
          echo ""
          echo "âœ… Video Concatenation & Music Integration: ${{ steps.concatenation.outputs.concatenation-completed }}"
          echo "ğŸ¬ Final Music Video: ${{ steps.concatenation.outputs.final-video-path }}"
          echo ""
          echo "âœ… Auto-Generated Web Player: ${{ steps.web-player.outputs.web-player-created }}"
          echo "ğŸŒ GitHub Pages URL: ${{ steps.web-player.outputs.web-player-url }}"
          echo "ğŸ“ Docs Deployment: ${{ steps.web-player.outputs.docs-deployed }}"
          echo ""
          echo "ğŸ‰ FULL ORCHESTRATED PIPELINE SUCCESS!"
          echo "ğŸ“Š Generated: Music + Analysis + Intent-to-Prompt Image/Video + Final Integration + Web Player"
          echo "ğŸ§ª Claude Code SDK Autonomous Creativity: ACTIVATED"
          echo "ğŸŒ Auto-Deploy to GitHub Pages: COMPLETED"
          echo "================================================"
      
      - name: Upload Generated Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: music-video-artifacts-${{ steps.setup.outputs.folder-name }}
          path: |
            ${{ steps.setup.outputs.folder-name }}/final/final-music-video.mp4
            ${{ steps.setup.outputs.folder-name }}/music/generated-music.wav
            ${{ steps.setup.outputs.folder-name }}/images/generated-image.png
            ${{ steps.setup.outputs.folder-name }}/videos/segment-*.mp4
            ${{ steps.setup.outputs.folder-name }}/google-image-url.txt
            ${{ steps.setup.outputs.folder-name }}/music-url.txt
          retention-days: 30
      
      - name: Final Status
        run: |
          echo "âœ… Experimental Orchestrated Workflow completed successfully!"
          echo "Branch: ${{ steps.setup.outputs.branch-name }}"
          echo "ğŸ§ª Compare results with standard modular workflow"
          echo "Check the branch for generated files."
          echo "ğŸ“¦ Artifacts uploaded for download"