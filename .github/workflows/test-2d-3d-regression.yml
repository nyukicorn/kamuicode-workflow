name: ðŸ§ª 2Dâ†’3D Regression Test
# Tests existing 2D to 3D point cloud generation after modularization

on:
  workflow_dispatch:
    inputs:
      test_image:
        description: 'Test image path (2D image for conversion)'
        required: false
        default: 'archive-pointcloud-experiments/latest/immersive-pointcloud-20250727-081545/images/generated-image.png'
      
      particle_density:
        description: 'Particle density level'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
      
      enable_audio:
        description: 'Enable audio reactive test'
        required: false
        default: 'true'
        type: boolean

jobs:
  test-2d-to-3d-conversion:
    name: Test 2Dâ†’3D Point Cloud Generation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ” Check Test Image Exists
        run: |
          echo "ðŸ” Checking test image: ${{ github.event.inputs.test_image }}"
          if [[ -f "${{ github.event.inputs.test_image }}" ]]; then
            echo "âœ… Test image found"
            ls -la "${{ github.event.inputs.test_image }}"
          else
            echo "âŒ Test image not found, using default test pattern"
            echo "USE_TEST_PATTERN=true" >> $GITHUB_ENV
          fi
      
      - name: ðŸŽ¨ Generate 3D Point Cloud
        id: generate_pointcloud
        uses: ./.github/actions/kamui-modules/pointcloud-generation
        with:
          input-image-path: ${{ github.event.inputs.test_image }}
          output-folder: 'test-output-2d-3d'
          branch-name: 'main'
          depth-model: 'midas_v21_small'
          color-mode: 'color'
          
      - name: ðŸŒ Create Three.js Viewer
        id: create_viewer
        uses: ./.github/actions/kamui-modules/threejs-pointcloud-viewer
        with:
          ply-file-path: ${{ steps.generate_pointcloud.outputs.ply-file-path }}
          output-folder: 'test-output-2d-3d'
          viewer-title: '2Dâ†’3D Regression Test Viewer'
          camera-position: '0,0,100'
          auto-rotate: 'false'
          background-color: '#1a1a2e'
          point-size: '2.0'
          animation-speed: '1.0'
          branch-name: 'main'
          
      - name: ðŸ“Š Test Results Summary
        run: |
          echo "# ðŸ§ª 2Dâ†’3D Regression Test Results" > test-output-2d-3d/test-report.md
          echo "" >> test-output-2d-3d/test-report.md
          echo "## Test Configuration" >> test-output-2d-3d/test-report.md
          echo "- **Input Image**: \`${{ github.event.inputs.test_image }}\`" >> test-output-2d-3d/test-report.md
          echo "- **Particle Density**: ${{ github.event.inputs.particle_density }}" >> test-output-2d-3d/test-report.md
          echo "- **Audio Reactive**: ${{ github.event.inputs.enable_audio }}" >> test-output-2d-3d/test-report.md
          echo "" >> test-output-2d-3d/test-report.md
          echo "## Generated Files" >> test-output-2d-3d/test-report.md
          echo "- **PLY File**: \`${{ steps.generate_pointcloud.outputs.ply-file-path }}\`" >> test-output-2d-3d/test-report.md
          echo "- **Depth Map**: \`${{ steps.generate_pointcloud.outputs.depth-map-path }}\`" >> test-output-2d-3d/test-report.md
          echo "- **Viewer**: \`test-output-2d-3d/index.html\`" >> test-output-2d-3d/test-report.md
          echo "" >> test-output-2d-3d/test-report.md
          echo "## Processing Details" >> test-output-2d-3d/test-report.md
          echo "- **Generation Status**: ${{ steps.generate_pointcloud.outputs.pointcloud-completed }}" >> test-output-2d-3d/test-report.md
          echo "" >> test-output-2d-3d/test-report.md
          echo "## Module Integration Status" >> test-output-2d-3d/test-report.md
          echo "- âœ… pointcloud-generation module" >> test-output-2d-3d/test-report.md
          echo "- âœ… threejs-pointcloud-viewer module" >> test-output-2d-3d/test-report.md
          echo "- âœ… Shared components integration" >> test-output-2d-3d/test-report.md
          
          cat test-output-2d-3d/test-report.md
          
      - name: ðŸ“¦ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-2d-3d-${{ github.run_number }}
          path: |
            test-output-2d-3d/
          retention-days: 7
          
      - name: ðŸŽ¯ Validate Generated Files
        run: |
          echo "ðŸ” Validating generated files..."
          
          # Debug: List all files in output directory
          echo "ðŸ“ Files in test-output-2d-3d directory:"
          ls -la test-output-2d-3d/ || echo "Directory not found"
          
          # Check PLY file
          if [[ -f "${{ steps.generate_pointcloud.outputs.ply-file-path }}" ]]; then
            echo "âœ… PLY file generated successfully"
            head -20 "${{ steps.generate_pointcloud.outputs.ply-file-path }}"
          else
            echo "âŒ PLY file generation failed"
            exit 1
          fi
          
          # Check viewer HTML (try both possible filenames)
          if [[ -f "test-output-2d-3d/index.html" ]]; then
            echo "âœ… Viewer HTML generated successfully (index.html)"
            # Check for key components
            grep -q "three.min.js" test-output-2d-3d/index.html && echo "  âœ“ Three.js included"
            grep -q "OrbitControls" test-output-2d-3d/index.html && echo "  âœ“ OrbitControls included"
            grep -q "PLYLoader" test-output-2d-3d/index.html && echo "  âœ“ PLYLoader included"
            grep -q "shared-components" test-output-2d-3d/index.html && echo "  âœ“ Shared components included"
          elif [[ -f "test-output-2d-3d/viewer.html" ]]; then
            echo "âœ… Viewer HTML generated successfully (viewer.html)"
            # Check for key components  
            grep -q "three.min.js" test-output-2d-3d/viewer.html && echo "  âœ“ Three.js included"
            grep -q "OrbitControls" test-output-2d-3d/viewer.html && echo "  âœ“ OrbitControls included"
            grep -q "PLYLoader" test-output-2d-3d/viewer.html && echo "  âœ“ PLYLoader included"
            grep -q "shared-components" test-output-2d-3d/viewer.html && echo "  âœ“ Shared components included"
          else
            echo "âŒ Viewer HTML generation failed (neither index.html nor viewer.html found)"
            exit 1
          fi
          
          echo ""
          echo "âœ… All validations passed!"
          
  test-shared-components:
    name: Test Shared Components Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ” Verify Shared Components
        run: |
          echo "ðŸ” Checking shared components..."
          
          COMPONENTS=(
            "audio-reactive-system.js"
            "camera-controls.js" 
            "mouse-interaction.js"
            "particle-effects.js"
            "ui-controls.js"
          )
          
          for component in "${COMPONENTS[@]}"; do
            if [[ -f ".github/actions/kamui-modules/shared-viewer-components/$component" ]]; then
              echo "âœ… $component exists"
            else
              echo "âŒ $component missing!"
              exit 1
            fi
          done
          
          echo ""
          echo "âœ… All shared components verified!"
          
      - name: ðŸ“Š Generate Component Report
        run: |
          echo "# ðŸ“¦ Shared Components Status" > component-report.md
          echo "" >> component-report.md
          echo "## Component Files" >> component-report.md
          echo "| Component | Status | Size |" >> component-report.md
          echo "|-----------|--------|------|" >> component-report.md
          
          for file in .github/actions/kamui-modules/shared-viewer-components/*.js; do
            basename=$(basename "$file")
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "| $basename | âœ… Active | $size |" >> component-report.md
          done
          
          cat component-report.md
          
      - name: ðŸ“¦ Upload Component Report
        uses: actions/upload-artifact@v4
        with:
          name: component-integration-report-${{ github.run_number }}
          path: component-report.md
          retention-days: 7