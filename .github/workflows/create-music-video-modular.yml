name: Create Music Video Modular

on:
  workflow_dispatch:
    inputs:
      music_concept:
        description: 'éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆä¾‹ï¼šé™ã‹ãªå¤œã®ãƒ”ã‚¢ãƒæ›²ï¼‰'
        required: true
        type: string

jobs:
  create-music-video-modular:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Branch
        id: setup
        uses: ./.github/actions/kamui-modules/setup-branch
      
      - name: Music Planning
        id: planning
        uses: ./.github/actions/kamui-modules/music-planning
        with:
          music-concept: ${{ inputs.music_concept }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      
      - name: Music Generation
        id: music
        uses: ./.github/actions/kamui-modules/music-generation
        with:
          music-concept: ${{ inputs.music_concept }}
          music-prompt: ${{ steps.planning.outputs.music-prompt }}
          folder-name: ${{ steps.setup.outputs.folder-name }}
          branch-name: ${{ steps.setup.outputs.branch-name }}
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mcp-config: ${{ secrets.MCP_CONFIG }}
      
      - name: Summary
        run: |
          echo "ğŸ¯ Music Video Creation Summary (Modular Version):"
          echo "================================================"
          echo "ğŸ“ Concept: ${{ inputs.music_concept }}"
          echo "ğŸŒ¿ Branch: ${{ steps.setup.outputs.branch-name }}"
          echo "ğŸ“ Folder: ${{ steps.setup.outputs.folder-name }}"
          echo ""
          echo "âœ… Planning Status: ${{ steps.planning.outputs.planning-completed }}"
          echo "ğŸµ Music Prompt: ${{ steps.planning.outputs.music-prompt }}"
          echo "ğŸ–¼ï¸ Image Prompt: ${{ steps.planning.outputs.image-prompt }}"
          echo ""
          echo "âœ… Music Generation: ${{ steps.music.outputs.music-completed }}"
          echo "ğŸ¶ Music URL: ${{ steps.music.outputs.music-url }}"
          echo ""
          echo "ğŸ‰ Workflow completed successfully!"
          echo "================================================"
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create PR title and body
          PR_TITLE="ğŸµ Add music video: ${{ inputs.music_concept }}"
          PR_BODY=$(cat <<'EOF'
## ğŸ¬ Music Video Creation Summary

**Concept**: ${{ inputs.music_concept }}
**Branch**: ${{ steps.setup.outputs.branch-name }}
**Folder**: ${{ steps.setup.outputs.folder-name }}

### ğŸ“Š Generation Results:
- âœ… Planning: Completed
- âœ… Music Generation: Completed
- ğŸµ Music URL: ${{ steps.music.outputs.music-url }}

### ğŸ“ Files Created:
- Planning documents in `planning/` directory
- Music files in `music/` directory

---
ğŸ¤– Generated with Create Music Video (Modular) workflow
EOF
)

          # Create the pull request
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head ${{ steps.setup.outputs.branch-name }} || echo "PR creation skipped or failed"