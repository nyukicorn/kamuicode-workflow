name: Creative Test Lab Working

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'å®Ÿé¨“å†…å®¹ï¼ˆä¾‹ï¼šæ¡œã®é¢¨æ™¯ç”»åƒã‚’ä½œã£ã¦ï¼‰'
        required: true
        type: string

jobs:
  generate-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup
        id: setup
        run: |
          EXPERIMENT_ID="test-$(date +%Y%m%d-%H%M%S)"
          FOLDER_NAME="experiment-results/${EXPERIMENT_ID}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          mkdir -p "$IMAGES_DIR"
          mkdir -p .claude
          
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "images-dir=$IMAGES_DIR" >> $GITHUB_OUTPUT
      
      - name: Generate Image with MCP
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          DESCRIPTION="${{ inputs.experiment_description }}"
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          IMAGES_DIR="${{ steps.setup.outputs.images-dir }}"
          
          # æ—¥æœ¬èªžã®èª¬æ˜Žã‚’ãã®ã¾ã¾è‹±èªžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ä½¿ç”¨
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸã‚‚ã®ã‚’ä½œã‚‹
          IMAGE_PROMPT="$DESCRIPTION, high quality, detailed, professional photography"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p .claude
          echo '${{ secrets.MCP_CONFIG }}' > .claude/mcp-kamuicode.json
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ðŸ“‹ è¨­å®šç¢ºèª:"
          echo "ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $IMAGE_PROMPT"
          echo "MCPè¨­å®š: $MCP_CONFIG_ABS_PATH"
          echo "ä¿å­˜å…ˆ: $IMAGES_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
          PROMPT="ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $IMAGE_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Imagen4 Fastã§ç”»åƒç”Ÿæˆ
          2. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_result\`ã§çµæžœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/generated-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - ç”»åƒã¯å¿…ãšã€Œ$IMAGES_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œgenerated-image.pngã€ã¨ã™ã‚‹"
          
          echo "ðŸš€ ç”»åƒç”Ÿæˆé–‹å§‹..."
          
          # Claude Code CLIã®å®Ÿè¡Œï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "âŒ Claude Codeå®Ÿè¡Œå¤±æ•—"
              exit 1
            }
          
          # çµæžœç¢ºèª
          if [ -f "$IMAGES_DIR/generated-image.png" ]; then
            echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸï¼"
            ls -la "$IMAGES_DIR/"
          else
            echo "âŒ ç”»åƒç”Ÿæˆå¤±æ•—"
            exit 1
          fi
      
      - name: Save Results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          FOLDER_NAME="${{ steps.setup.outputs.folder-name }}"
          
          # READMEä½œæˆ
          cat > "$FOLDER_NAME/README.md" << EOF
          # å®Ÿé¨“çµæžœ: $EXPERIMENT_ID
          - å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
          - å®Ÿè¡Œæ—¥æ™‚: $(date)
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æˆåŠŸ
          
          ## ç”Ÿæˆç”»åƒ
          ![Generated Image](images/generated-image.png)
          EOF
          
          # ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add experiment-results/
          git commit -m "âœ… Creative Test Lab: $EXPERIMENT_ID - ç”»åƒç”ŸæˆæˆåŠŸ" && git push