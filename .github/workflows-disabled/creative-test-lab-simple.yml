name: Creative Test Lab Simple

on:
  workflow_dispatch:
    inputs:
      experiment_description:
        description: 'ä»Šæ—¥è©¦ã—ãŸã„ã“ã¨ï¼ˆä¾‹ï¼šæ–°ã—ã„éŸ³æ¥½MCP + ç”»åƒã§å‹•ç”»ä½œæˆï¼‰'
        required: true
        type: string
      
      output_type:
        description: 'æœŸå¾…ã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ'
        type: choice
        options:
          - 'image'
          - 'video' 
          - 'music'
          - 'mixed-media'
        default: 'image'

jobs:
  experiment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup
        id: setup
        run: |
          EXPERIMENT_ID="exp-$(date +%Y%m%d-%H%M%S)"
          EXPERIMENT_DIR="experiment-results/${EXPERIMENT_ID}"
          mkdir -p "$EXPERIMENT_DIR"/{output,logs}
          echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
          echo "experiment-dir=$EXPERIMENT_DIR" >> $GITHUB_OUTPUT
      
      - name: Prepare MCP
        env:
          MCP_CONFIG: ${{ secrets.MCP_CONFIG }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          if [ -n "$MCP_CONFIG" ]; then
            echo "$MCP_CONFIG" > "$EXPERIMENT_DIR/mcp-config.json"
          else
            echo '{"mcpServers":{}}' > "$EXPERIMENT_DIR/mcp-config.json"
          fi
      
      - name: Run Claude Code
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_EXPIRES_AT: ${{ secrets.CLAUDE_EXPIRES_AT }}
        run: |
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          echo "ğŸš€ Phase 1: imagen4-fastç”»åƒç”Ÿæˆå®Ÿè¡Œä¸­..."
          
          # æ—¥æœ¬èªå…¥åŠ›ã‚’è‹±èªã«å¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          DESCRIPTION="${{ inputs.experiment_description }}"
          
          # åŸºæœ¬çš„ãªæ—¥æœ¬èªâ†’è‹±èªå¤‰æ›
          if [[ "$DESCRIPTION" =~ æ¡œ ]]; then
            ENGLISH_PROMPT="Beautiful cherry blossoms in full bloom, spring landscape, high quality, detailed"
          elif [[ "$DESCRIPTION" =~ èŠ± ]]; then
            ENGLISH_PROMPT="Beautiful flowers in a garden, colorful, high quality, detailed"
          elif [[ "$DESCRIPTION" =~ é¢¨æ™¯ ]]; then
            ENGLISH_PROMPT="Beautiful landscape scenery, natural lighting, high quality, detailed"
          else
            ENGLISH_PROMPT="Beautiful artistic image of $DESCRIPTION, high quality, detailed"
          fi
          
          echo "ğŸ“ æ—¥æœ¬èªæŒ‡ç¤º: $DESCRIPTION"
          echo "ğŸ”„ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGLISH_PROMPT"
          
          # Claude Codeè©³ç´°æŒ‡ç¤ºã‚’ä½œæˆ
          echo "ä»¥ä¸‹ã®ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š" > "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "ä½¿ç”¨MCP: mcp__t2i-fal-imagen4-fast__generate" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGLISH_PROMPT" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "ç”»åƒã‚µã‚¤ã‚º: 1024x1024" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "å“è³ª: high" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "é‡è¦ãªæŒ‡ç¤º:" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "1. mcp__t2i-fal-imagen4-fast__generateãƒ„ãƒ¼ãƒ«ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "2. ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "3. ãƒ•ã‚¡ã‚¤ãƒ«åã¯ generated-image.png ã«ã—ã¦ãã ã•ã„" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          echo "4. ç”Ÿæˆå®Œäº†å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> "$EXPERIMENT_DIR/claude-instructions.txt"
          
          echo "ğŸ“‹ Claude CodeæŒ‡ç¤ºå†…å®¹:"
          cat "$EXPERIMENT_DIR/claude-instructions.txt"
          
          # Claude Codeå®Ÿè¡Œ
          echo "ğŸ¤– Claude Codeå®Ÿè¡Œé–‹å§‹: $(date)"
          timeout 600 npx claude-code --non-interactive \
            --mcp-config="$EXPERIMENT_DIR/mcp-config.json" \
            --message="$(cat $EXPERIMENT_DIR/claude-instructions.txt)" \
            > "$EXPERIMENT_DIR/logs/claude-output.log" 2>&1 || echo "âš ï¸ Claude Codeå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
          
          echo "ğŸ“Š Claude Codeå®Ÿè¡Œãƒ­ã‚°:"
          tail -10 "$EXPERIMENT_DIR/logs/claude-output.log" || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ç§»å‹•
          echo "ğŸ” ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
          if ls generated-image.png *.png *.jpg *.jpeg 2>/dev/null; then
            echo "âœ… ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼"
            mv generated-image.png *.png *.jpg *.jpeg "$EXPERIMENT_DIR/output/" 2>/dev/null || true
            echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã—ãŸ"
          else
            echo "âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # æœ€çµ‚ç¢ºèª
          echo "ğŸ“‚ ç”Ÿæˆçµæœç¢ºèª:"
          ls -la "$EXPERIMENT_DIR/output/" || echo "outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
          
          echo "âœ… Phase 1å®Ÿè¡Œå®Œäº†: $(date)"
      
      - name: Save results
        run: |
          EXPERIMENT_ID="${{ steps.setup.outputs.experiment-id }}"
          EXPERIMENT_DIR="${{ steps.setup.outputs.experiment-dir }}"
          
          echo "ğŸ“ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          
          # è©³ç´°ãªREADME.mdç”Ÿæˆ
          cat > "$EXPERIMENT_DIR/README.md" << EOF
          # ğŸ§ª å®Ÿé¨“çµæœ: $EXPERIMENT_ID
          
          ## ğŸ“‹ å®Ÿé¨“æ¦‚è¦
          - **å®Ÿé¨“ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - imagen4-faståŸºæœ¬å®Ÿè£…
          - **æ—¥æœ¬èªæŒ‡ç¤º**: ${{ inputs.experiment_description }}
          - **æœŸå¾…ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**: ${{ inputs.output_type }}
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date)
          - **ä½¿ç”¨MCP**: imagen4-fast
          
          ## ğŸ¯ ç”Ÿæˆçµæœ
          EOF
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨è¡¨ç¤º
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A $EXPERIMENT_DIR/output)" ]; then
            echo "" >> "$EXPERIMENT_DIR/README.md"
            echo "### âœ… ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«" >> "$EXPERIMENT_DIR/README.md"
            echo '```' >> "$EXPERIMENT_DIR/README.md"
            ls -la "$EXPERIMENT_DIR/output/" >> "$EXPERIMENT_DIR/README.md"
            echo '```' >> "$EXPERIMENT_DIR/README.md"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            for img in "$EXPERIMENT_DIR/output"/*.png "$EXPERIMENT_DIR/output"/*.jpg "$EXPERIMENT_DIR/output"/*.jpeg; do
              if [ -f "$img" ]; then
                filename=$(basename "$img")
                echo "" >> "$EXPERIMENT_DIR/README.md"
                echo "### ğŸ–¼ï¸ ç”Ÿæˆç”»åƒ: $filename" >> "$EXPERIMENT_DIR/README.md"
                echo "![Generated Image](output/$filename)" >> "$EXPERIMENT_DIR/README.md"
                echo "" >> "$EXPERIMENT_DIR/README.md"
                echo "**ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: $(du -h "$img" | cut -f1)" >> "$EXPERIMENT_DIR/README.md"
              fi
            done
          else
            echo "" >> "$EXPERIMENT_DIR/README.md"
            echo "### âŒ ç”Ÿæˆå¤±æ•—" >> "$EXPERIMENT_DIR/README.md"
            echo "ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # å®Ÿè¡Œãƒ­ã‚°ã®è¿½åŠ 
          echo "" >> "$EXPERIMENT_DIR/README.md"
          echo "## ğŸ“Š å®Ÿè¡Œãƒ­ã‚°" >> "$EXPERIMENT_DIR/README.md"
          if [ -f "$EXPERIMENT_DIR/logs/claude-output.log" ]; then
            echo "### Claude Codeå®Ÿè¡Œãƒ­ã‚°ï¼ˆæœ€å¾Œã®20è¡Œï¼‰:" >> "$EXPERIMENT_DIR/README.md"
            echo '```' >> "$EXPERIMENT_DIR/README.md"
            tail -20 "$EXPERIMENT_DIR/logs/claude-output.log" >> "$EXPERIMENT_DIR/README.md" 2>/dev/null || echo "ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"
            echo '```' >> "$EXPERIMENT_DIR/README.md"
          fi
          
          # Phase 1ã®æˆåŠŸåˆ¤å®š
          if [ -d "$EXPERIMENT_DIR/output" ] && [ "$(ls -A $EXPERIMENT_DIR/output)" ]; then
            STATUS="âœ… SUCCESS"
            echo "" >> "$EXPERIMENT_DIR/README.md"
            echo "## ğŸ‰ Phase 1 å®Œäº†" >> "$EXPERIMENT_DIR/README.md"
            echo "imagen4-fastã‚’ä½¿ç”¨ã—ãŸç”»åƒç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸï¼" >> "$EXPERIMENT_DIR/README.md"
          else
            STATUS="âŒ FAILED"
            echo "" >> "$EXPERIMENT_DIR/README.md"
            echo "## âš ï¸ Phase 1 å¤±æ•—" >> "$EXPERIMENT_DIR/README.md"
            echo "ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> "$EXPERIMENT_DIR/README.md"
          fi
          
          echo "ğŸ“Š å®Ÿé¨“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          
          # Gitè¨­å®šã¨ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add experiment-results/
          if git diff --cached --quiet; then
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "ğŸ§ª Phase 1å®Ÿé¨“çµæœ: $EXPERIMENT_ID [$STATUS]

å®Ÿé¨“å†…å®¹: ${{ inputs.experiment_description }}
ä½¿ç”¨MCP: imagen4-fast
ãƒ•ã‚§ãƒ¼ã‚º: Phase 1 - åŸºæœ¬ç”»åƒç”Ÿæˆå®Ÿè£…

ğŸ¤– Generated with Creative Test Lab Simple"
            git push
          fi
          
          echo "âœ… Phase 1å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆå®Œäº†"